{"version":3,"sources":["bbg_xiv-gallery.js"],"names":["bbg_xiv","window","docUrl","helpOptionsUrl","galleryOfGalleriesTitle","bbg_xiv_lang","templateOptions","evaluate","interpolate","escape","variable","images","search","galleries","Image","Backbone","Model","extend","idAttribute","bbg_xiv_wp_rest_api","Images","Collection","model","ImageView","View","render","srcOnly","html","this","template","attributes","$el","GalleryView","renderBootstrapGallery","container","collection","empty","ReactDOM","GalleryContainer","get","renderFlex","FlexContainer","guiInterface","find","addClass","renderTiles","flags","indexOf","Modernizr","objectfit","load","naturalWidth","naturalHeight","jQuery","galleryContainer","closest","attr","hover","hasClass","parents","each","show","hide","click","e","caption","parentNode","data","preventDefault","renderCarousel","id","containerWidth","width","imageView","_","bulletsHtml","imagesHtml","forEach","index","browser","bbg_xiv_container_width","galleryView","gallery","size","length","bullets","items","append","renderTabs","tabView","tabsHtml","tabs","renderDense","mode","titleView","titlesHtml","titles","renderJustified","justifiedContainer","$justifiedGallery","justifiedGallery","margins","rowHeight","bbg_xiv_miro_row_height","lastRow","refreshSensitivity","refreshTime","on","css","matchMedia","matches","removeClass","img","querySelector","item","addEventListener","style","display","opacity","stopImmediatePropagation","$caption","parseFloat","renderGeneric","fieldNames","dumpFieldNames","Object","keys","key","push","buffer","name","dumpFieldValues","renderTable","constructImages","reset","JSON","parse","console","log","constructed","renderGallery","view","dataset","concat","split","jqGallery","constructOverlay","outer","inner","$altInner","overlayShowing","overlayLocked","mouseX","NaN","mouseY","hideOverlay","type","Math","abs","screenX","screenY","$inner","$navbar","setTimeout","add","mousemove","call","fullImg","fullTitle","fullCaption","titleColor","titleShadow","color","textShadow","altOverlayView","showOverlay","$button","tagName","parent","alt","replace","galleryId","bbg_xivGalleryId","bbg_xivImageId","src","getSrc","bbg_srcset","srcset","getSrcset","removeAttribute","textContent","getTitle","getCaption","error","stopPropagation","pause","mouseenter","gallery_home","titlesButton","resize","carouselId","button","$carousel","carousel","$this","$span","open","resetGallery","prevChangeTime","input","slider","slideChange","val","change","Date","now","i","isNumeric","parseInt","keypress","which","blur","focus","relatedTarget","$gallery","$divCarousel","scrollTop","scrollHeight","height","offset","top","$body","$adminBar","adminBarHeight","outerHeight","bodyBeforeHeight","bodyBeforeStyle","getComputedStyle","position","interval","bbg_xiv_carousel_interval","prettifyTabs","href","substr","lastIndexOf","r0","j","f","w","h","W","H","r","max","floor","$window","fullscreen","$content","filter","galleryIndex","toggle","siblings","jqThis","bbg_xiv_flex_number_of_dense_view_columns","normal","highlight","background-color","border-color","bottom","div","li","checked","value","menuItems","bbg_xiv_flex_min_width_for_dense_view","galleryOfGalleries","models","gallery_index","divAltGalleryHeading","text","initial","navbar","currentView","divGallery","defaultView","getDefaultView","liSelectView","liFirst","toLowerCase","fullSize","icon","bandwidth","source_url","url","bbg_thumbnail_src","bbg_large_src","bbg_medium_large_src","bbg_medium_src","bbg_xiv_bandwidth","title","rendered","post_title","trim","noAlt","post_excerpt","getAlt","noCaption","alt_text","image_alt","getPostContent","postContent","bbg_post_content","post_content","getSizes","localStorage","setItem","removeItem","localStorageAvailable","setCookie","expires","d","setTime","getTime","document","cookie","toUTCString","getCookie","getItem","start","end","substring","calcBreakpoints","minFlexWidth","bbg_xiv_flex_min_width","breakpoints","cssClass","getOptionsFromCookie","options","carousel_interval","flex_min_width","miro_row_height","max_search_results","bbg_xiv_max_search_results","flex_number_of_dense_view_columns","bbg_xiv_default_view","usingServerDefaultView","bbg_xiv_interface","userAgent","navigator","lowbandwidth","test","touchevents","wpRestApiMaxPerPage","pxWidth","minFlexWidthForCaption","bbg_xiv_flex_min_width_for_caption","breakpoint","ready","wp","api","loadPromise","done","collections","Media","select","handleResponse","jqueryLoading","mobile","loading","children","detach","prop","liGallery","textVisible","textonly","_widget","undefined","specifiers","nameMap","ids","bb_tags","valueMap","ASC","DESC","match","parameters","specifier","orderby","form","first","once","per_page","fetch","success","c","postData","action","_wpnonce","_wp_http_referer","parameter","post","ajaxurl","query","page","count","Number","MAX_SAFE_INTEGER","pages","searchLimit","searchBtn","startSearch","continueSearch","history","prevOffset","prevQuery","heading","Page","of","to","o","link","xhr","getResponseHeader","state","totalObjects","totalPages","limit","$galleryContainer","$container","$figure","divConfigure","attrMax","stringify","pageY","swipestop","coords","swipestart","zIndex"],"mappings":"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","file":"bbg_xiv-gallery.js","sourcesContent":["// Backbone.js Model View Presenter for the 'gallery' shortcode\n\n/*\n    This program is free software; you can redistribute it and/or\n    modify it under the terms of the GNU General Public License\n    as published by the Free Software Foundation; either version 2\n    of the License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU General Public License for more details.\n\n    You should have received a copy of the GNU General Public License\n    along with this program; if not, write to the Free Software\n    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n\n    Copyright 2015  Magenta Cuda\n*/\n\n(function(){\n    var bbg_xiv=window.bbg_xiv=window.bbg_xiv||{};\n    // URLs\n    bbg_xiv.docUrl         = \"http://docs.magentacuda.com/\";\n    bbg_xiv.helpOptionsUrl = \"http://docs.magentacuda.com/#options\";\n    // Strings\n    bbg_xiv.galleryOfGalleriesTitle=bbg_xiv_lang.galleryOfGalleriesTitle;\n    // use WordPress templating syntax; see .../wp-includes/js/wp-util.js\n    bbg_xiv.templateOptions={\n        evaluate:    /<#([\\s\\S]+?)#>/g,\n        interpolate: /\\{\\{\\{([\\s\\S]+?)\\}\\}\\}/g,\n        escape:      /\\{\\{([^\\}]+?)\\}\\}(?!\\})/g,\n        variable:    'data'\n    };\n    \n    bbg_xiv.images={};\n    bbg_xiv.search={};      // state info for multi part search results\n    bbg_xiv.galleries={};   // state info for alternate galleries\n    \n    bbg_xiv.Image=Backbone.Model.extend({idAttribute:window.bbg_xiv.bbg_xiv_wp_rest_api?\"id\":\"ID\"});\n    \n    bbg_xiv.Images=Backbone.Collection.extend({model:bbg_xiv.Image});\n    \n    bbg_xiv.ImageView=Backbone.View.extend({\n        render:function(srcOnly){\n            var html=this.template(this.model.attributes);\n            if(srcOnly){\n                return html;\n            }\n            this.$el.html(html);\n            return this;\n        }    \n    });\n    \n    bbg_xiv.GalleryView=Backbone.View.extend({\n        render:function(){\n            var html=this.template(this.model.attributes);\n            this.$el.html(html);\n            return this;\n        }\n    });\n    \n    bbg_xiv.renderBootstrapGallery=function(container,collection){\n        var imageView=new bbg_xiv.ImageView();\n        // attach template to imageView not ImageView.prototype since template is specific to imageView\n/*\n        imageView.template=_.template( jQuery(\"script#bbg_xiv-template_gallery_item\").html(),null,bbg_xiv.templateOptions);\n        var imagesHtml=\"\";\n        collection.forEach(function(model,index){\n            imageView.model=model;\n            imagesHtml+=imageView.render(true);\n            // Bootstrap's grid needs \"clear\" elements to correctly align non-uniformly sized items\n            if(index%4===3){\n                imagesHtml+='<br class=\"clearfix visible-lg-block\">';\n            }\n            if(index%3===2){\n                imagesHtml+='<br class=\"clearfix visible-md-block\">';\n            }\n            if(index%2===1){\n                imagesHtml+='<br class=\"clearfix visible-sm-block\">';\n            }\n        } );\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    items:imagesHtml\n                }\n            }\n        } );\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_gallery_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"div.container\"));\n */\n        container.empty();\n        ReactDOM.render( GalleryContainer( collection ), container.get( 0 ) );\n    };\n\n    bbg_xiv.renderFlex=function(container,collection){\n/*\n        var containerWidth=container.width();\n        var imageView=new bbg_xiv.ImageView();\n        // attach template to imageView not ImageView.prototype since template is specific to imageView\n        imageView.template=_.template( jQuery(\"script#bbg_xiv-template_flex_item\").html(),null,bbg_xiv.templateOptions);\n        var imagesHtml=\"\";\n        collection.forEach(function( model ) {\n            model.attributes.bbg_xiv_container_width=containerWidth;\n            imageView.model=model;\n            imagesHtml+=imageView.render(true);\n        });\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    id:collection.id,\n                    items:imagesHtml\n                }\n            }\n        });\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_flex_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"div.bbg_xiv-flex_container\"));\n */ \n        container.empty();\n        ReactDOM.render(FlexContainer(collection),container.get(0));\n        if ( bbg_xiv.guiInterface === 'touch' ) {\n            container.find(\"div.bbg_xiv-flex_container div.bbg_xiv-flex_item div.bbg_xiv-dense_full_btn\").addClass(\"bbg_xiv-touch\");\n        }\n    };\n\n    bbg_xiv.renderTiles=function(container,collection,flags){\n        // gallery tiles have exactly the same HTML elements as the gallery Flex items but we will use CSS specificity to override the Flex container CSS\n        container.addClass(\"bbg_xiv-tiles_container\");\n        // in the default mode of the square tiles the images cover the square tiles i.e., object-fit: cover;\n        if(flags.indexOf(\"contain\")!==-1){\n            // the images in the square tiles are contained in the square tiles i.e., object-fit: contain;\n            container.addClass(\"bbg_xiv-contain\");\n        }else if(flags.indexOf(\"fill\")!==-1){\n            // object-fit: fill;\n            container.addClass(\"bbg_xiv-fill\");\n        }\n        bbg_xiv.renderFlex(container,collection);\n        if(!Modernizr.objectfit||flags.indexOf(\"contain\")!==-1){\n            // IE and Edge do not support objectfit so we set a class to differentiate between landscape and portrait mode which will let our CSS rules simulate object-fit:cover\n            container.find(\"div.bbg_xiv-flex_item img\").load(function(){\n                if(this.naturalWidth<this.naturalHeight){\n                    jQuery(this).addClass(\"bbg_xiv-portrait\");\n                }\n            });\n        }\n        var flexContainer    = container.find( 'div.bbg_xiv-flex_container');\n        var galleryContainer = flexContainer.closest( 'div.bbg_xiv-gallery' ).addClass( 'bbg_xiv-caption_visible' );\n        galleryContainer.find( 'button.bbg_xiv-titles' ).attr( 'title', bbg_xiv_lang['hide titles'] );\n        // flip display state of caption on hover\n        container.find(\"div.bbg_xiv-dense_full_btn\").hover(\n            function() {\n                if ( ! galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                    jQuery(this).parents(\"div.bbg_xiv-flex_item\").find(\"figure figcaption\").each(function(){\n                        jQuery(this).show();\n                    });\n                }\n            },\n            function() {\n                if ( ! galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                    jQuery(this).parents(\"div.bbg_xiv-flex_item\").find(\"figure figcaption\").each(function(){\n                        jQuery(this).hide();\n                    });\n                }\n            }\n        );\n        if ( bbg_xiv.guiInterface === 'touch' ) {\n            container.find(\"div.bbg_xiv-flex_item a\").click(function(e){\n                if ( ! galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                    var caption=jQuery(this.parentNode).find(\"figure figcaption\");\n                    if(!caption.data(\"visible\")){\n                        container.find(\"div.bbg_xiv-flex_item figure figcaption\").data(\"visible\",false);\n                        caption.data(\"visible\",true);\n                        e.preventDefault();\n                    }\n                }\n            });\n        }\n    };\n\n    bbg_xiv.renderCarousel=function(container,collection,id){\n        var containerWidth=container.width();\n        var imageView=new bbg_xiv.ImageView();\n        imageView.template=_.template(jQuery(\"script#bbg_xiv-template_carousel_item\").html(),null,bbg_xiv.templateOptions);\n        var bulletsHtml=\"\";\n        var imagesHtml=\"\";\n        collection.forEach(function(model,index){\n            model.attributes.browser=bbg_xiv.browser;\n            model.attributes.index=index;\n            model.attributes.bbg_xiv_container_width=containerWidth;\n            imageView.model=model;\n            var active=index ===0?' class=\"active\"':'';\n            bulletsHtml+='<li data-target=\"#'+id+'\" data-slide-to=\"'+index+'\"'+active+'></li>';\n            imagesHtml+=imageView.render(true);\n        } );\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    id:id,\n                    gallery:collection.id,\n                    size:collection.length,\n                    bullets:bulletsHtml,\n                    items:imagesHtml\n                }\n            }\n        } );\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_carousel_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find( \"div.carousel.slide\"));\n    };\n\n    bbg_xiv.renderTabs=function(container,collection,id){\n        var containerWidth=container.width();\n        var tabView=new bbg_xiv.ImageView();\n        tabView.template=_.template(jQuery(\"script#bbg_xiv-template_tabs_tab\").html(),null,bbg_xiv.templateOptions);\n        var imageView=new bbg_xiv.ImageView();\n        imageView.template=_.template(jQuery(\"script#bbg_xiv-template_tabs_item\").html(),null,bbg_xiv.templateOptions);\n        var tabsHtml=\"\";\n        var imagesHtml=\"\";\n        collection.forEach(function(model,index){\n            model.attributes.browser=bbg_xiv.browser;\n            model.attributes.index=index;\n            model.attributes.bbg_xiv_container_width=containerWidth;\n            imageView.model=tabView.model=model;\n            tabsHtml+=tabView.render(true);\n            imagesHtml+=imageView.render(true);\n        });\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    id:id,\n                    tabs:tabsHtml,\n                    items:imagesHtml\n                }\n            }\n        });\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_tabs_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"div.bbg_xiv-template_tabs_container\"));\n    };\n\n    bbg_xiv.renderDense=function(container,collection,id,mode){\n        var containerWidth=container.width();\n        var titleView=new bbg_xiv.ImageView();\n        titleView.template=_.template(jQuery(\"script#bbg_xiv-template_dense_title\").html(),null,bbg_xiv.templateOptions);\n        var imageView=new bbg_xiv.ImageView();\n        imageView.template=_.template(jQuery(\"script#bbg_xiv-template_dense_image\").html(),null,bbg_xiv.templateOptions);\n        var titlesHtml=\"\";\n        var imagesHtml=\"\";\n        collection.forEach(function(model,index){\n            model.attributes.mode=mode;\n            model.attributes.index=index;\n            model.attributes.bbg_xiv_container_width=containerWidth;\n            imageView.model=titleView.model=model;\n            titlesHtml+=titleView.render(true);\n            imagesHtml+=imageView.render(true);\n        });\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    id:id,\n                    gallery:collection.id,\n                    mode:mode,\n                    titles:titlesHtml,\n                    images:imagesHtml\n                }\n            }\n        });\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_dense_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"div.bbg_xiv-dense_container\"));\n    };\n    \n    bbg_xiv.renderJustified=function(container,collection){\n        var imageView=new bbg_xiv.ImageView();\n        // attach template to imageView not ImageView.prototype since template is specific to imageView\n        imageView.template=_.template( jQuery(\"script#bbg_xiv-template_justified_item\").html(),null,bbg_xiv.templateOptions);\n        var imagesHtml=\"\";\n        collection.forEach(function( model ) {\n            imageView.model=model;\n            imagesHtml+=imageView.render(true);\n        });\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    id:collection.id,\n                    items:imagesHtml\n                }\n            }\n        });\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_justified_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        var justifiedContainer=galleryView.render().$el.find(\"div.bbg_xiv-justified_container\");\n        container.append(justifiedContainer);\n        var $justifiedGallery = justifiedContainer.find( 'div.bbg_xiv-justified_gallery' );\n        $justifiedGallery.justifiedGallery({margins: 5, rowHeight: bbg_xiv.bbg_xiv_miro_row_height, lastRow: 'nojustify', refreshSensitivity: 0, refreshTime: 250 })\n            .on( 'jg.complete jg.resize', function() {\n            // Why are there negative margins on the img - anyway remove them\n            $justifiedGallery.find( 'img' ).css( 'margin', '0' );\n        });\n        if ( bbg_xiv.guiInterface === 'touch' ) {\n            justifiedContainer.addClass( 'bbg_xiv-touch' );\n            $justifiedGallery.find( 'div.bbg_xiv-justified_item > a' ).click(function( e ) {\n                e.preventDefault();\n            });\n            justifiedContainer.addClass( window.matchMedia( '(max-aspect-ratio:1/1)' ).matches ? 'bbg_xiv-portrait' : 'bbg_xiv-landscape' );\n        }\n        justifiedContainer   = container.find( 'div.bbg_xiv-justified_container' );\n        var galleryContainer = justifiedContainer.closest( 'div.bbg_xiv-gallery' ).removeClass( 'bbg_xiv-caption_visible' );\n        galleryContainer.find( 'button.bbg_xiv-titles' ).attr( 'title',  bbg_xiv_lang['show captions'] );\n        // if CC has been set to visible then override Justified Gallery's hover handlers\n        justifiedContainer.find(\"div.bbg_xiv-justified_gallery div.bbg_xiv-justified_item\").each(function(){\n          var img=this.querySelector(\"img\");\n          var caption=this.querySelector(\"div.caption\");\n          [img,caption].forEach(function(item){\n              // these handlers need work if executed before or after the Justified Gallery's handlers\n              item.addEventListener(\"mouseover\",function(e){\n                  if ( galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                      caption.style.display=\"block\";\n                      caption.style.opacity=\"0.7\";\n                      e.stopImmediatePropagation();\n                  }\n              });\n              item.addEventListener(\"mouseout\",function(e){\n                  if ( galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                      caption.style.display=\"block\";\n                      caption.style.opacity=\"0.7\";\n                      e.stopImmediatePropagation();\n                  }\n              });\n          });\n          jQuery( img ).closest( 'a' ).click(function( e ) {\n              e.preventDefault();\n          });\n          jQuery( caption ).find( 'a' ).click( function( e ) {\n              var $caption = jQuery( this ).closest( 'div.caption' );\n              if ( parseFloat( $caption.css( 'opacity' ) ) < 0.1 ) {\n                  e.preventDefault();\n              }\n          } );\n        });\n    };\n\n    // renderGeneric() may work unmodified with your template.\n    // Otherwise you can use it as a base for a render function specific to your template.\n    // See renderGallery(), renderCarousel() or renderTabs() - all of which need some special HTML to work correctly.\n\n    bbg_xiv.renderGeneric=function(container,collection,template){\n        var imageView=new bbg_xiv.ImageView();\n        // attach template to imageView not ImageView.prototype since template is specific to imageView\n        imageView.template=_.template( jQuery(\"script#bbg_xiv-template_\"+template+\"_item\").html(),null,bbg_xiv.templateOptions);\n        var imagesHtml=\"\";\n        collection.forEach(function( model ) {\n            imageView.model=model;\n            imagesHtml+=imageView.render(true);\n        });\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    items:imagesHtml\n                }\n            }\n        } );\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_\"+template+\"_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"bbg_xiv-container\"));\n    };\n\n    // debugging utilities\n    \n    // dumpFieldNames() dumps field names as <th> elements in a <tr> element\n    var fieldNames=[];\n    bbg_xiv.dumpFieldNames=function(collection){\n        collection.forEach(function(model){\n            Object.keys(model.attributes).forEach(function(key){\n                if(fieldNames.indexOf(key)===-1){\n                    fieldNames.push(key);\n                }\n            });\n        });\n        var buffer=\"<tr>\";\n        fieldNames.forEach(function(name){\n            buffer+=\"<th>\"+name+\"</th>\";\n        });\n        buffer+=\"</tr>\";\n        return buffer;\n    };\n    \n    // dumpFieldValues() dumps field values as <td> elements in <tr> elements\n    bbg_xiv.dumpFieldValues=function(collection){\n        var buffer=\"\";\n        collection.forEach(function(model){\n            buffer+=\"<tr>\";\n            fieldNames.forEach(function(name){\n                buffer+=\"<td>\"+model.attributes[name]+\"</td>\";\n            });\n            buffer+=\"</tr>\";\n        });\n        return buffer;        \n    };\n    \n    bbg_xiv.renderTable=function(container,collection){\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    collection:collection\n                }\n            }\n        } );\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_table_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"div.bbg_xiv-table\"));\n    };\n    \n    bbg_xiv.constructImages=function(gallery){\n        var images;\n        if(window.bbg_xiv.bbg_xiv_wp_rest_api){\n            images = bbg_xiv.images[ gallery.id ];\n        }else{\n            images = bbg_xiv.images[ gallery.id ] = new bbg_xiv.Images();\n            try{\n                images.reset(JSON.parse(window.bbg_xiv[gallery.id+\"-data\"]));\n            }catch(e){\n                console.log(\"reset(JSON.parse()) failed:\",e);\n                return images;\n            }\n        }\n        images.id=gallery.id;\n        images.constructed=true;\n        return images;\n    };\n    \n    bbg_xiv.renderGallery=function(gallery,view,flags){\n        if(!flags){\n            flags=[];\n        }\n        // extract flags from data attribute flags\n        if(gallery.dataset.flags){\n            flags=flags.concat(gallery.dataset.flags.split(\",\"));\n        }\n\n        var jqGallery=jQuery(gallery);\n        var images=bbg_xiv.images[gallery.id];\n        if(!images||!images.constructed){\n            images=bbg_xiv.constructImages(gallery);\n        }\n        // remember the initial statically loaded gallery so we can efficiently return to it\n        bbg_xiv.galleries[gallery.id]=bbg_xiv.galleries[gallery.id]||{images:{\"gallery_home\":images},view:\"gallery_home\"};\n        function constructOverlay() {\n            // gallery or dense view shows a full browser viewport view of an image when its fullscreen glyph is clicked\n            var outer          = jqGallery.find( 'div.bbg_xiv-dense_outer' );\n            var inner          = jqGallery.find( 'div.bbg_xiv-dense_inner' );\n            var $altInner      = jqGallery.find( 'div.bbg_xiv-dense_alt_inner' );\n            var overlayShowing = false;\n            var overlayLocked  = false;\n            var mouseX         = NaN;\n            var mouseY         = NaN;\n            var $caption       = null;\n            function hideOverlay( e ) {\n                if ( ! overlayShowing ) {\n                    // ignore events when overlay is transitioning to hide\n                    return;\n                }\n                if ( e.type !== 'click' ) {\n                    if ( overlayLocked ) {\n                        return;\n                    }\n                    if ( Math.abs( e.screenX - mouseX ) < 10 && Math.abs( e.screenY - mouseY ) < 10 ) {\n                        // ignore a small mouse movement\n                        return;\n                    }\n                } else {\n                    if ( ! overlayLocked ) {\n                        // An unlocked overlay must be the alt overlay.\n                        // When the alt overlay is showing from a hover use the first click in the inner to lock the alt overlay.\n                        overlayLocked = true;\n                        $altInner.addClass( 'bbg_xiv-locked' );\n                        return;\n                    }\n                }\n                // This is either a click event on a locked overlay or a large mouse move event on an unlocked alt overlay\n                var $inner = jQuery( this );\n                if ( $inner.hasClass( 'bbg_xiv-dense_outer' ) ) {\n                    // $inner really is outer so ...\n                    $inner = $altInner;\n                }   \n                overlayShowing = overlayLocked = false;\n                $altInner.removeClass( 'bbg_xiv-locked' );\n                mouseX = mouseY = NaN;\n                // fade out and hide overlay\n                $inner.css(\"opacity\",\"0.0\");\n                outer.css(\"opacity\",\"0.0\");\n                // workaround for a bug? in Chrome where navbar is not visible after an overlay is closed\n                var $navbar = jQuery( 'div.bbg_xiv-gallery nav.bbg_xiv-gallery_navbar' ).css( 'opacity', '0.99' );\n                window.setTimeout(function(){\n                    $inner.hide();\n                    outer.hide();\n                    $navbar.css( 'opacity', '1.0' );\n                }, $inner !== $altInner ? 2000 : 500 );\n                // $caption.css( { display: 'block', opacity: '0.7' } );\n            }   // function hideOverlay( e ) {\n            inner.add( $altInner ).click( hideOverlay );\n            outer.add( $altInner ).mousemove( hideOverlay );\n            // when overlay is showing from hover use a click in the outer to lock the overlay\n            outer.click( function( e ) {\n                if ( !overlayLocked ) {\n                    // The overlay must be the alt overlay.\n                    overlayLocked = true;\n                    $altInner.addClass( 'bbg_xiv-locked' );\n                } else {\n                    hideOverlay.call( this, e );\n                }\n            } );\n            var fullImg     = inner.find( 'img' );\n            var fullTitle   = inner.find( 'h1.bbg_xiv-dense_title' );\n            var fullCaption = inner.find( 'h1.bbg_xiv-dense_caption' );\n            if( typeof bbg_xiv.titleColor === 'undefined' ) {\n                // save the initial values of title color and shadow as these will be changed\n                bbg_xiv.titleColor  = fullTitle.css( 'color' );\n                bbg_xiv.titleShadow = fullTitle.css( 'text-shadow' );\n            }\n            if ( bbg_xiv.guiInterface === 'mouse' ) {\n                // only show title on mouseover\n                fullImg.hover(\n                    function() {\n                        fullTitle.css({   color: bbg_xiv.titleColor, textShadow: bbg_xiv.titleShadow});\n                        fullCaption.css({ color: bbg_xiv.titleColor, textShadow: bbg_xiv.titleShadow});\n                    },\n                    function() {\n                        fullTitle.css({   color: 'transparent', textShadow: 'none' });\n                        fullCaption.css({ color: 'transparent', textShadow: 'none' });\n                    }\n                );\n            }\n            var altOverlayView      = new bbg_xiv.ImageView();\n            altOverlayView.template = _.template( jQuery( 'script#bbg_xiv-template_justified_alt_overlay' ).html(), null, bbg_xiv.templateOptions );\n            function showOverlay( e ) {\n                var $button;\n                if ( this.tagName === 'A' ) {\n                    // click from carousel info button\n                    $button = jQuery( this );\n                } else if ( this.tagName === 'SPAN' ) {\n                    $button = jQuery( this.parentNode );\n                } else {\n                    $button = jQuery( this );\n                }\n                if ( parseFloat( $button.closest( 'div.caption' ).css( 'opacity' ) ) < 0.1 ) {\n                    // click was on an invisible button so ignore it\n                    return;\n                }\n                overlayShowing = true;\n                overlayLocked  = e.type === 'click';\n                mouseX         = e.screenX;\n                mouseY         = e.screenY;\n                $caption       = $button.parent( 'div.caption' );\n                var alt        = $button.hasClass( 'bbg_xiv-carousel_info' ) || $button.hasClass( 'bbg_xiv-dense_alt_btn' );   // use the alternate overlay view\n                if ( alt && overlayLocked ) {\n                    $altInner.addClass( 'bbg_xiv-locked' );\n                }\n                var img;\n                // the buttons are of four different types so the associated image is found differently depending on the type\n                if ( $button.hasClass( 'bbg_xiv-carousel_info' ) ) {\n                    // click from carousel info button\n                    img = $button.closest( 'div.carousel' ).find( 'div.carousel-inner figure.item.active img' )[0];\n                } else if ( $button.hasClass( 'bbg_xiv-dense_from_image' ) ) {\n                    img = $button.parents( 'div.bbg_xiv-dense_flex_item' ).find( 'img' )[0];\n                } else if ( $button.hasClass( 'bbg_xiv-dense_from_title' ) ) {\n                    img = jQuery( 'div#' + this.parentNode.id.replace( 'title', 'image' ) ).find( 'img' )[0];\n                } else if ( $button.hasClass( 'bbg_xiv-flex_from_image' ) ) {\n                    img = $button.parents( 'div.bbg_xiv-flex_item' ).find( 'img' )[0];\n                } else if ( $button.hasClass( 'bbg_xiv-dense_from_justified') ) {\n                    img = $button.parents( 'div.bbg_xiv-justified_item' ).find( 'img' )[0];\n                }\n                var data;\n                try {\n                    var galleryId=jQuery(img).parents(\"div[data-bbg_xiv-gallery-id]\")[0].dataset.bbg_xivGalleryId;\n                    data = bbg_xiv.images[ galleryId ].get( img.dataset.bbg_xivImageId ).attributes;\n                    if ( ! alt ) {\n                        fullImg[0].src=bbg_xiv.getSrc(data,\"viewport\",false);\n                        if(data.bbg_srcset){\n                            fullImg[0].srcset=bbg_xiv.getSrcset(data);\n                        }else{\n                            fullImg[0].removeAttribute(\"sizes\");\n                        }\n                        fullTitle[0].textContent=bbg_xiv.getTitle(data);\n                        fullCaption[0].textContent=bbg_xiv.getCaption(data);\n                    } else {\n                        // instantiate the alternate overlay\n                        altOverlayView.model = { attributes: data };\n                        $altInner.find( 'div.bbg_xiv-dense_alt_items' ).html( altOverlayView.render( true ) );\n                        $altInner.find( 'span.bbg_xiv-item_value a' ).click( function( e ) {\n                            // click on a elements should be ignored if the overlay is not locked, propagation will then lock the overlay as expected\n                            if ( ! jQuery( this ).parents( 'div.bbg_xiv-dense_alt_inner' ).hasClass( 'bbg_xiv-locked' ) ) {\n                                e.preventDefault();\n                            }\n                        } );\n                    }\n                } catch ( error ) {\n                    console.log('##### broken 1');\n                    if ( ! alt ) {\n                        fullImg[0].src = img.src;\n                    }\n                }\n                // show and fade in overlay\n                outer.show();\n                if ( ! alt ) {\n                    // show full image overlay\n                    $altInner.hide();\n                    inner.show();\n                } else {\n                    // show alternate overlay\n                    inner.hide();\n                    $altInner.show();\n                }\n                if ( bbg_xiv.guiInterface === 'touch' ) {\n                    // force hover effects on touchscreen\n                    fullTitle.css({   color: bbg_xiv.titleColor, textShadow: bbg_xiv.titleShadow});\n                    fullCaption.css({ color: bbg_xiv.titleColor, textShadow: bbg_xiv.titleShadow});\n                }\n                window.setTimeout(function(){\n                    ( ! alt ? inner : $altInner ).css( 'opacity', '1.0' );\n                    outer.css(\"opacity\",\"0.93\");\n                },100);\n                $caption.css( { display: 'block', opacity: '0.7' } );\n                e.preventDefault();\n                e.stopPropagation();\n            }  // function showOverlay( e ) {\n            jqGallery.find( 'a.bbg_xiv-carousel_info' ).click( function( e ) {\n                pause( this );\n                // show alt overlay\n                showOverlay.call( this, e );\n            } );\n            jqGallery.find( 'button.bbg_xiv-dense_full_btn, button.bbg_xiv-dense_alt_btn' ).click( showOverlay );\n            jqGallery.find( 'button.bbg_xiv-dense_alt_btn span.glyphicon' ).mouseenter( showOverlay );\n        }   // function constructOverlay() {\n        var titlesButton=jqGallery.parents(\"div.bbg_xiv-gallery\").find(\"nav.navbar button.bbg_xiv-titles\").hide();\n        switch(view){\n        case \"Gallery\":\n            if(flags.indexOf(\"tiles\")!==-1){\n                bbg_xiv.renderTiles(jqGallery,images,flags);\n                constructOverlay();\n                titlesButton.show();\n// TODO: renderFlex commented out to force renderBootstrapGallery for testing JSX code - uncomment!\n/*\n            } else if ( Modernizr.flexbox && Modernizr.flexwrap && ! window.bbg_xiv.bbg_xiv_disable_flexbox ) {\n                bbg_xiv.renderFlex(jqGallery,images);\n                constructOverlay();\n*/ \n            }else{\n                bbg_xiv.renderBootstrapGallery(jqGallery,images);\n            }\n            window.setTimeout(function(){\n                jQuery(window).resize();\n            },100);\n            break;\n        case \"Justified\":\n            bbg_xiv.renderJustified(jqGallery,images);\n            constructOverlay();\n            titlesButton.show();\n            break;\n        case \"Carousel\":\n            if(flags.indexOf(\"embedded-carousel\")!==-1){\n                jqGallery.addClass(\"bbg_xiv-embedded_carousel\");\n            }else{\n                jQuery(\"html\").css(\"overflow-y\",\"hidden\");\n            }\n            var carouselId=\"bbg_xiv-carousel_\"+gallery.id;\n            bbg_xiv.renderCarousel(jqGallery,images,carouselId);\n            constructOverlay();\n            // pause() can be called from a button's event handler to pause the carousel, the argument is the button\n            function pause( button ) {\n                var $carousel = jQuery( button ).parents( 'div.carousel' );\n                $carousel.carousel( 'pause' );\n                $carousel.find( 'a.bbg_xiv-carousel_play span.glyphicon' ).removeClass( 'glyphicon-pause' ).addClass( 'glyphicon-play' ).parent().attr( 'title', bbg_xiv_lang['Play'] );\n            }\n            // Wireup the handlers - this must be done here as the elements in the carousel view are dynamically created\n            // Carousel pause handler\n            jqGallery.find( 'a.bbg_xiv-carousel_play' ).click( function( e ) {\n                var $this     = jQuery( this );\n                var $carousel = $this.parents( 'div.carousel' );\n                var $span     = $this.find( 'span.glyphicon' );\n                if ( $span.hasClass( 'glyphicon-pause' ) ) {\n                    pause( this );\n                } else {\n                    $span.removeClass( 'glyphicon-play' ).addClass( 'glyphicon-pause' ).parent().attr( 'title', bbg_xiv_lang['Pause'] );\n                    $carousel.carousel( 'next' );\n                    $carousel.carousel( 'cycle' );\n                }\n                e.preventDefault();      \n            });\n            jqGallery.find( 'a.bbg_xiv-carousel_left, a.bbg_xiv-carousel_right' ).click(function() {\n                pause(this);\n            });\n            // Carousel rewind handler\n            jqGallery.find(\"a.bbg_xiv-carousel_first span.glyphicon,a.bbg_xiv-carousel_last span.glyphicon\").click(function(e){\n                pause( this );\n                var carousel=jQuery(this).parents(\"div.carousel\");\n                if(jQuery(this.parentNode).hasClass(\"bbg_xiv-carousel_first\")){\n                    carousel.carousel(0);\n                }else{\n                    carousel.carousel(images.length-1);\n                }\n                e.preventDefault();      \n            });\n            jqGallery.find( 'a.bbg_xiv-carousel_help span.glyphicon' ).click( function( e ) {\n                window.open( bbg_xiv.docUrl + '#view-carousel', '_blank' );\n                e.preventDefault();      \n            } );\n            jqGallery.find(\"a.bbg_xiv-carousel_close\").click(function(e){\n                // restore \"Gallery View\"\n                jqGallery.removeClass(\"bbg_xiv-embedded_carousel\");\n                bbg_xiv.resetGallery(jQuery(this).parents(\"div.bbg_xiv-gallery\"),\"Carousel\");\n                jQuery( 'html' ).css( 'overflow-y', '' );\n                e.preventDefault();      \n            });\n            var input=jqGallery.find(\"div.bbg_xiv-jquery_mobile input[type='range']\");\n            input.slider();\n            var prevChangeTime;\n            var slideChange=false;   // change event triggered by a carousel slid event\n            // update Bootstrap carousel slide when jQuery mobile slider changes\n            // jQuery Mobile should change the \"type\" from \"range\" to \"number\" but does not so force it.\n            // TODO: Find out why jQuery Mobile is not doing this here - maybe I am doing something wrong.\n            input.attr( 'type', 'number' ).val( '1' ).change(function() {\n                if(slideChange){\n                    // ignore change events triggered by a carousel slid event\n                    return;\n                }\n                prevChangeTime=Date.now();\n                var carousel=jQuery(this).parents(\"div.carousel\");\n                pause(input);\n                // Since change events will occur much too rapidly wait until they quiesce\n                window.setTimeout(function(){\n                    if(Date.now()-prevChangeTime>=500){\n                        var i=input.val();\n                        if(jQuery.isNumeric(i)){\n                            i = parseInt( i, 10 ) - 1;\n                            if(i>=0&&i<images.length){\n                                carousel.carousel(i);\n                                pause(input);\n                            }\n                        }\n                    }\n                },500);\n            }).keypress(function(e){\n                if(e.which===13){\n                    jQuery(this).blur();\n                    e.preventDefault();\n                }\n            }).focus(function() {\n                pause(this);\n            }).on( 'slidestart', function() {\n                pause(this);\n            });\n            // update jQuery Mobile slider when Bootstrap carousel changes slide\n            jqGallery.find(\"div.carousel\").on(\"slide.bs.carousel slid.bs.carousel\",function(e){\n                slideChange=true;\n                // update input element and trigger change event to force update of slider position\n                jQuery( this ).find( 'div.bbg_xiv-jquery_mobile input[type=\"number\"]' ).val( parseInt( e.relatedTarget.dataset.index, 10 ) + 1 ).change();\n                slideChange=false;\n            });\n            if ( flags.indexOf( 'embedded-carousel' ) !== -1 ) {\n                window.setTimeout( function() {\n                    // the timeout is necessary to give browser time to render the image before the scrolling is done\n                    var $gallery     = jqGallery.closest( 'div.bbg_xiv-gallery' );\n                    var $divCarousel = jqGallery.find( 'div.carousel' );\n                    if ( $gallery.hasClass( 'bbg_xiv-fullscreen_gallery' ) ) {\n                        // full screen\n                        if ( window.matchMedia( '(max-aspect-ratio:1/1)' ).matches ) {\n                            // portrait mode\n                        } else {\n                            // landscape mode\n                            $gallery.scrollTop( $gallery[0].scrollHeight - $gallery.height() - 50 + 0.05 * $divCarousel.height() );\n                        }\n                    } else {\n                        // not full screen\n                        if(window.matchMedia(\"(max-aspect-ratio:1/1)\").matches){\n                            // portrait mode\n                            jQuery(window).scrollTop( $divCarousel.offset().top - jQuery(window).height()/6 );\n                        }else{\n                            // landscape mode\n                            // If WordPress admin bar is showing on frontend page adjust for it.\n                            var $body            = jQuery( 'body' );\n                            var $adminBar        = jQuery( 'div#wpadminbar' );\n                            var adminBarHeight   = $body.hasClass( 'admin-bar' ) && $adminBar.css( 'position' ) == 'fixed' ? $adminBar.outerHeight() : 0;\n                            var bodyBeforeHeight = 0;\n                            if ( $body.hasClass( 'bbg_xiv-twentysixteen_with_border' ) ) {\n                                // Adjust for the black border in the WordPress TwentySixteen theme.\n                                var bodyBeforeStyle = window.getComputedStyle( $body[0], ':before' );\n                                bodyBeforeHeight    = bodyBeforeStyle && bodyBeforeStyle.position === 'fixed' ? parseInt( bodyBeforeStyle.height, 10 ) : 0;\n                            }\n                            jQuery( window ).scrollTop( $divCarousel.offset().top - $divCarousel.outerHeight() / 18 - adminBarHeight - bodyBeforeHeight );\n                        }\n                    }\n                }, 500 );\n            }\n            jQuery(\"#\"+carouselId).carousel({interval:bbg_xiv.bbg_xiv_carousel_interval,pause:false});\n            break;\n        case \"Tabs\":\n            bbg_xiv.renderTabs(jqGallery,images,\"bbg_xiv-tabs_\"+gallery.id);\n            bbg_xiv.prettifyTabs(jqGallery,true);\n            jqGallery.find( 'nav.navbar ul.nav li a' ).click(function() {\n                if(!Modernizr.objectfit){\n                    // Microsoft Edge does not support CSS object-fit so do the object fit with JavaScript code\n                    jQuery(this.href.substr(this.href.lastIndexOf(\"#\"))+\" img\").each(function(){\n                        var img=this;\n                        var i=0;\n                        var j=0;\n                        var r0;\n                        window.setTimeout(function f(){\n                            var w=img.naturalWidth;\n                            var h=img.naturalHeight;\n                            var parent=jQuery(img.parentNode.parentNode.parentNode);\n                            var W=parent.width();\n                            var H=0.7*jQuery(window).height();\n                            if(!w||!h||!W||!H||W<64||H<64){\n                                if(i++<16){\n                                    window.setTimeout(f,250);\n                                }\n                                return;\n                            }\n                            var r=Math.max(w/W,h/H);\n                            if(r<0.125||r>8){\n                                return;\n                            }\n                            if(typeof r0!=='undefined'&&r===r0){\n                                return;\n                            }\n                            w=Math.floor(w/r);\n                            h=Math.floor(h/r);\n                            jQuery(img).css({width:w+\"px\",height:h+\"px\"});\n                            r0=r;\n                            if(j++<16){\n                                window.setTimeout(f,250);\n                            }\n                        },250);\n                    });\n                }\n                window.setTimeout(function() {\n                    // the timeout is necessary to give browser time to render the image before the scrolling is done\n                    var $window    = jQuery( window );\n                    var $gallery   = jqGallery.closest( 'div.bbg_xiv-gallery' );\n                    var fullscreen = $gallery.hasClass( 'bbg_xiv-fullscreen_gallery' );\n                    var $content   = jqGallery.find( 'div.tab-content' );\n                    if( window.matchMedia( '(max-aspect-ratio:1/1)' ).matches ) {\n                        // portrait mode\n                        if ( fullscreen ) {\n                            $gallery.scrollTop( $gallery.scrollTop() + $content.position().top  - $window.height() / 3 - 20 );\n                        } else {\n                            $window.scrollTop( $content.offset().top - $window.height() / 3 - 20 );\n                        }\n                    } else {\n                        // landscape mode\n                        if ( fullscreen ) {\n                            $gallery.scrollTop( $gallery.scrollTop() + $content.position().top - 90 );\n                        } else {\n                            var $body            = jQuery( 'body' );\n                            var $adminBar        = jQuery( 'div#wpadminbar' );\n                            // If WordPress admin bar is showing on frontend page adjust for it.\n                            var adminBarHeight   = $body.hasClass( 'admin-bar' ) && $adminBar.css( 'position' ) == 'fixed' ? $adminBar.outerHeight() : 0;\n                            var bodyBeforeHeight = 0;\n                            if ( $body.hasClass( 'bbg_xiv-twentysixteen_with_border' ) ) {\n                                // Adjust for the black border in the WordPress TwentySixteen theme.\n                                var bodyBeforeStyle = window.getComputedStyle( $body[0], ':before' );\n                                bodyBeforeHeight    = bodyBeforeStyle && bodyBeforeStyle.position === 'fixed' ? parseInt( bodyBeforeStyle.height, 10 ) : 0;\n                            }\n                            var offset              = $window.height() >= 480 ? 80 : 40;\n                            $window.scrollTop( $content.offset().top - offset - adminBarHeight - bodyBeforeHeight );\n                        }\n                    }\n                }, 500 );\n            });\n            // intercept clicks when images belong to gallery of galleries\n            if(jqGallery.hasClass(\"bbg_xiv-gallery_icons_mode\")){\n                jqGallery.find(\"div.bbg_xiv-template_tabs_container div.tab-content figure.tab-pane a\").click(function(e){\n                    var galleries=jqGallery.parent().find(\"nav.bbg_xiv-gallery_navbar ul.nav li.dropdown ul.bbg_xiv-view_menu li.bbg_xiv-alt_gallery\");\n                    // only intercept clicks on the home gallery\n                    if(galleries.filter(\".bbg_xiv-alt_gallery_home\").hasClass(\"active\")){\n                        galleries.find(\"a[data-view='gallery_\"+this.dataset.galleryIndex+\"']\").click();\n                        e.preventDefault();\n                    }\n                });\n            }\n            // make the \"Tabs\" brand clickable for mobile devices and send click to the toggle button\n            jqGallery.find(\"a.bbg_xiv-tabs_brand\").click(function(e){\n                var toggle=jQuery(this).siblings(\"button.navbar-toggle\");\n                if(toggle.css(\"display\")!==\"none\"){\n                    toggle.click();\n                }\n                e.preventDefault();\n            });\n            if ( bbg_xiv.guiInterface === 'touch' ) {\n                // For mobile devices if a scrollbar is needed then initially expand the tab navbar as the collapsed tab navbar is not user friendly on mobile devices\n                jQuery( 'div.bbg_xiv-gallery nav.bbg_xiv-gallery_navbar' ).find( 'span.glyphicon-collapse-down' ).each(function(){\n                    var jqThis=jQuery(this);\n                    if(jqThis.css(\"display\")!==\"none\"){\n                        jqThis.click();\n                    }\n                });\n            }\n            break;\n        case \"Dense\":\n            jQuery(\"html\").css(\"overflow-y\",\"hidden\");\n            bbg_xiv.renderDense(jqGallery,images,\"bbg_xiv-dense_\"+gallery.id,\"title\");\n            jqGallery.find(\"div.bbg_xiv-dense_images div.bbg_xiv-dense_flex_images div.bbg_xiv-dense_flex_item\")\n                .css(\"width\",100/bbg_xiv.bbg_xiv_flex_number_of_dense_view_columns+\"%\");\n            var normal=jQuery(\"div.bbg_xiv-dense_container button#bbg_xiv-normal_color\").css(\"background-color\");\n            var highlight=jQuery(\"div.bbg_xiv-dense_container button#bbg_xiv-highlight_color\").css(\"background-color\");\n            jqGallery.find(\"div.bbg_xiv-dense_titles ul li\").hover(\n                function() {\n                    // highlight matching image\n                    jQuery(this).css({\"background-color\":highlight});\n                    var img=jQuery(\"div#\"+this.id.replace(\"title\",\"image\")).css({\"border-color\":highlight});\n                    // scroll images view if matching image is hidden\n                    var top=img.position().top;\n                    var height=img.height();\n                    var bottom=top+height;\n                    var div = img.parents( 'div.bbg_xiv-dense_images' );\n                    var scrollTop=div.scrollTop();\n                    var scrollHeight=div.height();\n                    if(top<0){\n                        div.scrollTop(scrollTop+top-scrollHeight/2-height/2);\n                    }else if(bottom>scrollHeight){\n                        div.scrollTop(scrollTop+(bottom-scrollHeight)+scrollHeight/2-height/2);\n                    }\n                },\n                function() {\n                    jQuery(this).css({\"background-color\":normal});\n                    jQuery(\"div#\"+this.id.replace(\"title\",\"image\")).css({\"border-color\":normal});\n                }\n            );\n            jqGallery.find(\"div.bbg_xiv-dense_flex_item\").hover(\n                function() {\n                    jQuery(this).css({\"border-color\":highlight});\n                    // highlight matching title\n                    var li=jQuery(\"li#\"+this.id.replace(\"image\",\"title\")).css({\"background-color\":highlight});\n                    // scroll titles view if matching title is hidden\n                    var top=li.position().top;\n                    var height=li.height();\n                    var bottom=top+height;\n                    var div = li.parents( 'div.bbg_xiv-dense_titles' );\n                    var scrollTop=div.scrollTop();\n                    var scrollHeight=div.height();\n                    if(top<0){\n                        div.scrollTop(scrollTop+top-scrollHeight/2-height/2);\n                    }else if(bottom>scrollHeight){\n                        div.scrollTop(scrollTop+(bottom-scrollHeight)+scrollHeight/2-height/2);\n                    }\n                },\n                function() {\n                    jQuery(this).css({\"border-color\":normal});\n                    jQuery(\"li#\"+this.id.replace(\"image\",\"title\")).css({\"background-color\":normal});\n                }\n            );\n            jqGallery.find( 'input.bbg_xiv-dense_li_mode' ).change(function() {\n                // show titles or captions depending on the radio buttons \n                if(this.checked){\n                    var div=jQuery(\"div.bbg_xiv-dense_container div.bbg_xiv-dense_titles\");\n                    if(this.value===\"title\"){\n                        div.find(\"span.bbg_xiv-dense_li_caption\").hide();\n                        div.find(\"span.bbg_xiv-dense_li_title\").show();\n                        div.find(\"span.bbg_xiv-dense_li_alt\").hide();\n                    }else if(this.value===\"caption\"){\n                        div.find(\"span.bbg_xiv-dense_li_title\").hide();\n                        div.find(\"span.bbg_xiv-dense_li_caption\").show();\n                        div.find(\"span.bbg_xiv-dense_li_alt\").hide();\n                    }else if(this.value===\"alt\"){\n                        div.find(\"span.bbg_xiv-dense_li_title\").hide();\n                        div.find(\"span.bbg_xiv-dense_li_caption\").hide();\n                        div.find(\"span.bbg_xiv-dense_li_alt\").show();\n                    }\n                }\n            });\n            jqGallery.find( 'button.bbg_xiv-dense_info_btn' ).click( function( e ) {\n                window.open( bbg_xiv.docUrl + '#view-dense', '_blank' );\n                e.preventDefault();      \n            } );\n            jqGallery.find(\"button.bbg_xiv-dense_close_btn\").click(function(e){\n                // restore \"Gallery View\"\n                bbg_xiv.resetGallery(jQuery(this).parents(\"div.bbg_xiv-gallery\"));\n                jQuery( 'html' ).css( 'overflow-y', '' );\n                e.preventDefault();      \n            });\n            constructOverlay();\n            break;\n        // TODO: Add entry for new views here\n        case \"Table\":\n            bbg_xiv.renderTable(jqGallery,images);\n            break;\n        default:\n            break;\n        }\n        var menuItems=jQuery(gallery.parentNode).find(\"nav.bbg_xiv-gallery_navbar ul.nav ul.bbg_xiv-view_menu li\").show();\n        if ( bbg_xiv.guiInterface !== 'mouse' || jQuery( window ).width() < bbg_xiv.bbg_xiv_flex_min_width_for_dense_view ) {\n            // for touch and small screen devices hide the dense menu item\n            menuItems.filter( '.bbg_xiv-large_viewport_only' ).hide();\n        }\n        if(bbg_xiv.search[gallery.id]){\n            // displaying search results so hide gallery headings\n            jQuery(\"div#\"+gallery.id+\"-alt_gallery_heading\").hide();\n            // and show search results heading\n            jQuery(\"div#\"+gallery.id+\"-heading\").show();\n        }else if(bbg_xiv.galleries[gallery.id]){\n            // displaying a gallery so hide search results heading\n            jQuery(\"div#\"+gallery.id+\"-heading\").hide();\n            var galleryOfGalleries=typeof bbg_xiv.images[gallery.id].models[0].attributes.gallery_index!==\"undefined\";\n            var divAltGalleryHeading=jQuery(\"div#\"+gallery.id+\"-alt_gallery_heading\");\n            if(galleryOfGalleries){\n                // show heads up for gallery of galleries\n                divAltGalleryHeading.find(\"span.bbg_xiv-alt_gallery_heading\").text(bbg_xiv.galleryOfGalleriesTitle);\n                // click handler for gallery icon images\n                jqGallery.find(\"a.bbg_xiv-gallery_icon\").click(function(e){\n                    jqGallery.parent().find( 'nav.bbg_xiv-gallery_navbar ul.nav li.dropdown ul.bbg_xiv-view_menu li.bbg_xiv-alt_gallery > a[data-view=\"gallery_' +\n                        this.dataset.galleryIndex+'\"]').click();\n                    e.preventDefault();\n                });\n                // hide inappropriate menu items for gallery of galleries\n                menuItems.filter(\".bbg_xiv-hide_for_gallery_icons\").hide();\n            }\n            if(bbg_xiv.galleries[gallery.id].view!==\"gallery_home\"||galleryOfGalleries){\n                // and show title of alternate galleries or heads up for gallery of galleries; except hide title for home gallery; \n                divAltGalleryHeading.show();\n            }\n        }\n    };\n    \n    // tabs are used twice - to show a list of gallery titles and a list of image titles. prettifyTabs() implements the common functionality for both\n    bbg_xiv.prettifyTabs=function(jqGallery,initial){\n        // Adjust the tab view according to its environment\n        var navbar=jqGallery.find(\"nav.navbar\");\n        // In portrait mode show the tabs navbar uncollapsed\n        var toggle=navbar.find(\"button.navbar-toggle\");\n        if(toggle.css(\"display\")!==\"none\"){\n            toggle.click();\n        }\n        // Hide the expand glyph and scrollbar if not needed.\n        navbar.find(\"div.navbar-collapse ul.nav\").each(function(){\n            if(jQuery(this).height()-8<=jQuery(this.parentNode).height()){\n                jQuery(this).parents(\"nav.navbar\").find(\"span.glyphicon\").hide();\n                jQuery(this.parentNode).addClass(\"bbg_xiv-hide_scroll\");\n            }\n        });\n        if(initial){\n            // Wireup the handlers - this must be done here as the elements in the tab view are dynamically created\n            // Clicking the expand glpyh shows all the tabs.\n            jqGallery.find( 'span.glyphicon-collapse-down, span.glyphicon-collapse-up' ).click(function() {\n                var jqThis=jQuery(this);\n                var navbar=jQuery(this.parentNode).find(\"div.navbar-collapse\");\n                if(jqThis.hasClass(\"glyphicon-collapse-down\")){\n                    jqThis.removeClass(\"glyphicon-collapse-down\").addClass(\"glyphicon-collapse-up\");\n                    navbar.removeClass(\"bbg_xiv-closed\").addClass(\"bbg_xiv-open\");\n                }else{\n                    jqThis.removeClass(\"glyphicon-collapse-up\").addClass(\"glyphicon-collapse-down\");\n                    navbar.removeClass(\"bbg_xiv-open\").addClass(\"bbg_xiv-closed\");\n                }\n            });\n        }\n    };\n\n    bbg_xiv.resetGallery=function(gallery,currentView){\n        // restore \"Gallery View\"\n        var divGallery=gallery.find(\"div.bbg_xiv-gallery_envelope\")[0];\n        var galleryOfGalleries=typeof bbg_xiv.images[divGallery.id].models[0].attributes.gallery_index!==\"undefined\";\n        var defaultView=bbg_xiv.getDefaultView(jQuery(divGallery),galleryOfGalleries);\n        if(currentView===\"Carousel\"&&defaultView===\"Carousel\"){\n            defaultView=\"Gallery\";\n        }\n        bbg_xiv.renderGallery(divGallery,defaultView);\n        var liSelectView=gallery.find(\"nav.bbg_xiv-gallery_navbar ul.nav li.bbg_xiv-select_view\");\n        var liFirst=liSelectView.find(\"ul.bbg_xiv-view_menu li.bbg_xiv-view\").removeClass(\"active\").filter(\".bbg_xiv-view_\"+defaultView.toLowerCase()).addClass(\"active\");\n        liSelectView.find(\"a.bbg_xiv-selected_view span\").text(liFirst.text());\n        jQuery(window).resize();\n    };\n     \n    // getting attributes indirectly through functions will make it possible for one template to be used for both the REST mode and the old proprietary mode\n\n    // the fullSize parameter is the size of the non-iconic view of the image and should either \"viewport\" or \"container\"\n    // the icon parameter is a boolean indicating that the src is for a thumbnail\n\n    // getSrc() sets the src attribute of <img> HTML elements which will be ignored on modern browsers that support the srcset attribute\n    // i.e. the source selection logic of getSrc() will only be used on older browsers\n\n    bbg_xiv.getSrc=function(data,fullSize,icon){\n        switch(bbg_xiv.bandwidth){\n        case \"normal\":\n            return bbg_xiv.bbg_xiv_wp_rest_api?data.source_url:data.url;\n        case \"low\":\n            if(icon){\n                return data.bbg_thumbnail_src[0];\n            }else{\n                if(fullSize===\"viewport\"){\n                    return data.bbg_large_src[0];\n                }else{\n                    return data.bbg_medium_large_src[0];\n                }\n            }\n            break;\n        case \"very low\":\n            if(icon){\n                return data.bbg_thumbnail_src[0];\n            }else{\n                if(fullSize===\"viewport\"){\n                    return data.bbg_medium_large_src[0];\n                }else{\n                    return data.bbg_medium_src[0];\n                }\n            }\n        }\n    };\n\n    bbg_xiv.getSrcset=function(data){\n        if(bbg_xiv.bbg_xiv_bandwidth!=='auto'){\n            // really should removeAttribute but this should work\n            return \"\";\n        }\n        return data.bbg_srcset;\n    };\n\n    bbg_xiv.getTitle=function(data){\n        return (bbg_xiv.bbg_xiv_wp_rest_api?data.title.rendered:data.post_title).trim();\n    };\n\n    bbg_xiv.getCaption=function(data,noAlt){\n        var caption=bbg_xiv.bbg_xiv_wp_rest_api?jQuery(data.caption.rendered).text():data.post_excerpt;\n        if(!caption&&!noAlt){\n            caption=bbg_xiv.getAlt(data,true);\n        }\n        return caption.trim();\n    };\n\n    bbg_xiv.getAlt=function(data,noCaption){\n        var alt=bbg_xiv.bbg_xiv_wp_rest_api?data.alt_text:data.image_alt;\n        if(!alt&&!noCaption){\n            alt=bbg_xiv.getCaption(data,true);\n        }\n        return alt.trim();\n    };\n\n    bbg_xiv.getPostContent=function(data){\n        var postContent=bbg_xiv.bbg_xiv_wp_rest_api?data.bbg_post_content:data.post_content;\n        if(postContent){\n            return postContent;\n        }\n        return bbg_xiv.getCaption(data);\n    };\n    \n    bbg_xiv.getSizes=function(data,fullSize,icon){\n        if(bbg_xiv.bbg_xiv_bandwidth!=='auto'){\n            // really should removeAttribute but this should work\n            return \"\";\n        }\n        if(!data){\n            if(fullSize===\"viewport\"&&!icon){\n                return \"100vw\";\n            }\n            return \"50vw\";\n        }         \n        if(!data.bbg_srcset){\n            // really should removeAttribute but this should work\n            return \"\";\n        } else if ( icon ) {\n            return '10vw';\n        }else if(fullSize===\"viewport\"){\n            return \"90vw\";\n        }else if(fullSize===\"container\"){\n            return data.bbg_xiv_container_width+\"px\";\n        }else{\n            return \"50vw\";\n        }\n    };\n\n    try{\n        window.localStorage.setItem(\"test\",\"test\");\n        window.localStorage.removeItem(\"test\");\n        bbg_xiv.localStorageAvailable=true;\n    }catch(e){\n        bbg_xiv.localStorageAvailable=false;\n    }\n    \n    bbg_xiv.setCookie=function(name,value,expires){\n        if(bbg_xiv.localStorageAvailable){\n            localStorage.setItem(name,value);\n        }else{\n            var d=new Date();\n            d.setTime(d.getTime()+(expires*24*60*60*1000));\n            document.cookie=name+\"=\"+value+\"; expires=\"+d.toUTCString()+\"; path=/\";\n        }\n    };\n\n    bbg_xiv.getCookie=function(name){\n        if(bbg_xiv.localStorageAvailable){\n            return localStorage.getItem(name);\n        }else{\n            var cookie=document.cookie;\n            cookie += \";\";\n            var start=cookie.indexOf(name+\"=\");\n            if(start===-1){\n                return null;\n            }\n            start+=name.length+1;\n            var end=cookie.indexOf(\";\",start);\n            if(end===-1){\n                return null;\n            }\n            return cookie.substring(start,end);\n        }\n    };\n\n    bbg_xiv.calcBreakpoints=function(){\n        var minFlexWidth=window.bbg_xiv.bbg_xiv_flex_min_width;\n        bbg_xiv.breakpoints=[\n            {width:2*minFlexWidth,cssClass:\"100\"},\n            {width:3*minFlexWidth,cssClass:\"50\"},\n            {width:4*minFlexWidth,cssClass:\"33_3333\"},\n            {width:5*minFlexWidth,cssClass:\"25\"},\n            {width:6*minFlexWidth,cssClass:\"20\"},\n            {width:7*minFlexWidth,cssClass:\"16_6666\"},\n            {width:8*minFlexWidth,cssClass:\"14_2857\"},\n            {width:9*minFlexWidth,cssClass:\"12_5\"},\n            {width:10*minFlexWidth,cssClass:\"11_1111\"},\n            {width:11*minFlexWidth,cssClass:\"10\"},\n            {width:12*minFlexWidth,cssClass:\"9_0909\"},\n            { width: 1000000, cssClass: '8_3333' }\n        ];\n    };\n\n    bbg_xiv.getOptionsFromCookie=function(){\n        // override options with cookie values if they exists\n        var cookie=bbg_xiv.getCookie(\"bbg_xiv\");\n        if(cookie){\n            var options=JSON.parse(cookie);\n            var carousel_interval=options.bbg_xiv_carousel_interval;\n            if(jQuery.isNumeric(carousel_interval)&&carousel_interval>=1000){\n                bbg_xiv.bbg_xiv_carousel_interval=carousel_interval;\n            }\n            var flex_min_width=options.bbg_xiv_flex_min_width;\n            if(jQuery.isNumeric(flex_min_width)&&flex_min_width>=32&&flex_min_width<=1024){\n                bbg_xiv.bbg_xiv_flex_min_width=flex_min_width;\n            }\n            var miro_row_height = options.bbg_xiv_miro_row_height;\n            if ( jQuery.isNumeric( miro_row_height ) && miro_row_height >= 32 && miro_row_height <= 512 ) {\n                bbg_xiv.bbg_xiv_miro_row_height = miro_row_height;\n            }\n            var max_search_results=options.bbg_xiv_max_search_results;\n            if(jQuery.isNumeric(max_search_results)&&max_search_results>=1&&max_search_results<1048576){\n                bbg_xiv.bbg_xiv_max_search_results=max_search_results;\n            }\n            var flex_number_of_dense_view_columns=options.bbg_xiv_flex_number_of_dense_view_columns;\n            if(jQuery.isNumeric(flex_number_of_dense_view_columns)&&flex_number_of_dense_view_columns>=2&&flex_number_of_dense_view_columns<=32){\n                bbg_xiv.bbg_xiv_flex_number_of_dense_view_columns=flex_number_of_dense_view_columns;\n            }\n            if(typeof options.bbg_xiv_default_view===\"string\"){\n                bbg_xiv.bbg_xiv_default_view=options.bbg_xiv_default_view;\n                bbg_xiv.usingServerDefaultView=false;\n            }else{\n                bbg_xiv.usingServerDefaultView=true;\n            }\n            if(typeof options.bbg_xiv_bandwidth===\"string\"){\n                bbg_xiv.bbg_xiv_bandwidth=options.bbg_xiv_bandwidth;\n            }\n            if(typeof options.bbg_xiv_interface===\"string\"){\n                bbg_xiv.bbg_xiv_interface=options.bbg_xiv_interface;\n            }\n        }else{\n            bbg_xiv.usingServerDefaultView=true;\n            bbg_xiv.bbg_xiv_bandwidth=\"auto\";\n            bbg_xiv.bbg_xiv_interface=\"auto\";\n        }\n        var userAgent=navigator.userAgent;\n        if(userAgent.indexOf(\"Firefox\")!==-1){\n            bbg_xiv.browser=\"Firefox\";\n        }else{\n            bbg_xiv.browser=\"\";\n        }\n        // compute bandwidth if bandwidth is set to auto - currently since this is not done reliably the user should set the bandwidth option manually\n        if(bbg_xiv.bbg_xiv_bandwidth===\"auto\"){\n            if(Modernizr.lowbandwidth){\n                // this uses navigator.connection which is only supported by Android\n                bbg_xiv.bandwidth=\"very low\";\n            }else if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)){\n                // determining bandwidth by device type is not reliable!\n                bbg_xiv.bandwidth=\"very low\";\n            }else{\n                bbg_xiv.bandwidth=\"low\";\n            }\n        }else{\n            bbg_xiv.bandwidth=bbg_xiv.bbg_xiv_bandwidth;\n        }\n        // compute interface if interface is auto\n        if(bbg_xiv.bbg_xiv_interface===\"auto\"){\n            if(Modernizr.touchevents){\n                bbg_xiv.guiInterface = 'touch';\n            }else{\n                bbg_xiv.guiInterface = 'mouse';\n            }\n        }else{\n            bbg_xiv.guiInterface = bbg_xiv.bbg_xiv_interface;\n        }\n        if(bbg_xiv.bbg_xiv_wp_rest_api){\n            // WP REST API requires that per_page be between 1 and 100 inclusive\n            bbg_xiv.wpRestApiMaxPerPage=100;\n        }\n    };\n    \n    bbg_xiv.getOptionsFromCookie();\n    bbg_xiv.calcBreakpoints();\n    \n    jQuery(window).resize(function(){\n        var breakpoints=bbg_xiv.breakpoints;\n        jQuery(\"div.bbg_xiv-flex_container,div.bbg_xiv-gallery_container\").each(function(){\n            var jqThis=jQuery(this);\n            var width=jqThis.width();\n            var pxWidth;\n            var minFlexWidthForCaption=window.bbg_xiv.bbg_xiv_flex_min_width_for_caption;\n            if(jqThis.parents(\"div.bbg_xiv-gallery_envelope\").hasClass(\"bbg_xiv-tiles_container\")){\n                // set tile width and height in pixels so that tiles cover the div exactly and completely\n                pxWidth = Math.floor( width / Math.floor( width / window.bbg_xiv.bbg_xiv_flex_min_width ) ) - 1;\n                jqThis.find(\"div.bbg_xiv-flex_item\").css({width:pxWidth,height:pxWidth});\n                if(pxWidth<minFlexWidthForCaption){\n                    jqThis.find(\"div.bbg_xiv-flex_item figcaption\").hide();\n                }\n            }else{\n                // find the smallest percentage width that satisfies the minimum image width\n                breakpoints.forEach(function(breakpoint){\n                  jqThis.removeClass(\"bbg_xiv-flex_width_\"+breakpoint.cssClass);\n                });\n                for(var i=0;i<breakpoints.length;i++){\n                    if(width<breakpoints[i].width){\n                        var cssClass=breakpoints[i].cssClass;\n                        jqThis.addClass(\"bbg_xiv-flex_width_\"+cssClass);\n                        pxWidth = parseFloat( cssClass.replace( '_', '.' ) ) / 100.0 * width;\n                        if(pxWidth<minFlexWidthForCaption){\n                            jqThis.addClass(\"bbg_xiv-flex_no_caption\");\n                        }else{\n                            jqThis.removeClass(\"bbg_xiv-flex_no_caption\");\n                        }\n                        break;\n                    }\n                }\n            }\n        });\n        if ( bbg_xiv.guiInterface === 'mouse' && jQuery( window ).width() >= bbg_xiv.bbg_xiv_flex_min_width_for_dense_view ) {\n            jQuery(\".bbg_xiv-configure_inner .bbg_xiv-mouse_only_option\").show();\n        }else{\n            jQuery(\".bbg_xiv-configure_inner .bbg_xiv-mouse_only_option\").hide();\n        }  \n        jQuery(\"div.bbg_xiv-gallery_envelope\").each(function(){\n            var menuItems=jQuery(this.parentNode).find(\"nav.bbg_xiv-gallery_navbar ul.nav ul.bbg_xiv-view_menu li\").show();\n            if ( bbg_xiv.guiInterface !== 'mouse' || jQuery( window ).width() < bbg_xiv.bbg_xiv_flex_min_width_for_dense_view ) {\n                // for touch and small screen devices hide the dense menu item\n                menuItems.filter(\".bbg_xiv-large_viewport_only\").hide();\n            }\n            if(typeof bbg_xiv.images[this.id].models[0].attributes.gallery_index!==\"undefined\"){\n                // for a gallery of gallery icons hide the carousel and the dense menu items\n                menuItems.filter(\".bbg_xiv-hide_for_gallery_icons\").hide();\n            }\n        });\n    });\n\n    bbg_xiv.getDefaultView=function(gallery,galleryOfGalleries){\n        var defaultView;\n        if(galleryOfGalleries||(galleryOfGalleries===null&&gallery.hasClass(\"bbg_xiv-gallery_icons_mode\"))){\n            // for gallery of galleries always use the gallery view\n            defaultView = 'Gallery';\n        }else{\n            // use class to set default view if it exists otherwise use the global value\n            defaultView = bbg_xiv.bbg_xiv_default_view ? bbg_xiv.bbg_xiv_default_view : 'Gallery';\n            if(bbg_xiv.usingServerDefaultView){\n                if(gallery.hasClass(\"bbg_xiv-default_view_gallery\")){\n                    defaultView=\"Gallery\";\n                }else if(gallery.hasClass(\"bbg_xiv-default_view_justified\")){\n                    defaultView=\"Justified\";\n                }else if(gallery.hasClass(\"bbg_xiv-default_view_carousel\")){\n                    defaultView=\"Carousel\";\n                }else if(gallery.hasClass(\"bbg_xiv-default_view_tabs\")){\n                    defaultView=\"Tabs\";\n                }\n            }\n            gallery.parents(\"div.bbg_xiv-bootstrap.bbg_xiv-gallery\").find(\"nav.bbg_xiv-gallery_navbar ul.nav li.bbg_xiv-select_view ul.bbg_xiv-view_menu li.bbg_xiv-view\")\n                .removeClass(\"active\").filter(\".bbg_xiv-view_\"+defaultView.toLowerCase()).addClass(\"active\");\n        }\n        return defaultView;\n    };\n    \n    jQuery(document).ready(function(){\n        jQuery(\"div.bbg_xiv-gallery_envelope\").each(function(){\n            var gallery=this;\n            var defaultView=bbg_xiv.getDefaultView(jQuery(gallery),null);\n            // prettify Galleries tabs\n            bbg_xiv.prettifyTabs(jQuery(gallery.parentNode).find(\"div.bbg_xiv-container\"),true);\n            if(bbg_xiv.bbg_xiv_wp_rest_api){\n                // If the schema is not in sessionStorage it will be loaded asynchronously so must use wp.api.loadPromise.done()\n                wp.api.loadPromise.done(function(){\n                    var images=bbg_xiv.images[gallery.id]=new wp.api.collections.Media();\n                    images.reset(JSON.parse(bbg_xiv[gallery.id+\"-data\"]));\n                    bbg_xiv.renderGallery(gallery,defaultView,[\"initial\"]);\n                    jQuery( gallery ).closest( 'div.bbg_xiv-gallery' ).addClass( 'bbg_xiv-home_gallery' );\n                    jQuery(window).resize();\n                });\n            }else{\n                bbg_xiv.renderGallery(gallery,defaultView,[\"initial\"]);\n                jQuery( gallery ).closest( 'div.bbg_xiv-gallery' ).addClass( 'bbg_xiv-home_gallery' );\n            }\n        });\n\n        // wireup the event handlers\n        // wireup the handler for view selection\n        jQuery(\"nav.bbg_xiv-gallery_navbar ul.nav li.dropdown ul.bbg_xiv-view_menu li > a\").click(function(e){\n            var view=this.dataset.view;\n            var jqThis=jQuery(this);\n            var li=jqThis.parent();\n            var select=li.parent();\n            var liSelectView=li.parents(\"li.bbg_xiv-select_view\");\n            var container=jqThis.parents(\"div.bbg_xiv-bootstrap.bbg_xiv-gallery\");\n            var divGallery=container.find(\"div.bbg_xiv-gallery_envelope\")[0];\n            function handleResponse( r ) {\n                if(jqueryLoading){\n                    jQuery.mobile.loading(\"hide\");\n                    jQuery(divGallery).children().detach();\n                }\n                if(r){\n                    galleries.images[view]=bbg_xiv.constructImages(divGallery);\n                    galleries.view=view;\n                    container.find(\"div#\"+divGallery.id+\"-alt_gallery_heading span.bbg_xiv-alt_gallery_heading\").text(title);\n                    bbg_xiv.renderGallery(divGallery,defaultView);\n                }else{\n                    jQuery(divGallery).empty().append('<h1 class=\"bbg_xiv-warning\">'+bbg_xiv_lang[\"Nothing Found\"]+'</h1>');\n                }\n                jQuery(divGallery.parentNode).find(\"nav.navbar form.bbg_xiv-search_form button\").prop(\"disabled\",false);\n            }\n            if([\"Gallery\",\"Carousel\",\"Justified\",\"Tabs\",\"Dense\"].indexOf(view)>=0){\n                // view selected\n                select.find(\"li.bbg_xiv-view\").removeClass(\"active\");\n                li.addClass(\"active\");\n                liSelectView.find(\"a.bbg_xiv-selected_view span\").text(this.textContent);\n                bbg_xiv.renderGallery(divGallery,view);\n            }else{\n                // gallery selected\n                // delete search state if it exists\n                if(bbg_xiv.search[divGallery.id]){\n                    delete bbg_xiv.search[divGallery.id];\n                }\n                container.find(\"div#\"+divGallery.id+\"-alt_gallery_heading\").hide();\n                var title=this.textContent;\n                var galleries=bbg_xiv.galleries[divGallery.id];\n                var galleryOfGalleries=(view!==\"gallery_home\")?false:null;\n                var defaultView=bbg_xiv.getDefaultView(jQuery(divGallery),galleryOfGalleries);\n                select.find(\"li.bbg_xiv-view\").removeClass(\"active\");\n                var liGallery=select.find(\"li.bbg_xiv-view_\"+defaultView.toLowerCase()).addClass(\"active\");\n                liSelectView.find(\"a.bbg_xiv-selected_view span\").text(liGallery.text());\n                select.find(\"li.bbg_xiv-alt_gallery\").removeClass(\"active\");\n                li.addClass(\"active\");\n                if(galleries.images[view]){\n                    // images were previously loaded so just restore  the collection\n                    bbg_xiv.images[divGallery.id]=galleries.images[view];\n                    galleries.view=view;\n                    if(view!==\"gallery_home\"){\n                        container.find(\"div#\"+divGallery.id+\"-alt_gallery_heading span.bbg_xiv-alt_gallery_heading\").text(title);\n                    }\n                    bbg_xiv.renderGallery(divGallery,defaultView);\n                    // update active in gallery tabs\n                    container.find(\"div.bbg_xiv-gallery_tabs_container nav.navbar ul.nav-tabs li\").removeClass(\"active\").find(\"a[data-view='\"+view+\"']\").parent().addClass(\"active\");\n                    if ( view !== 'gallery_home' ) {\n                        jqThis.closest( 'div.bbg_xiv-gallery' ).removeClass( 'bbg_xiv-home_gallery' );\n                    } else {\n                        jqThis.closest( 'div.bbg_xiv-gallery' ).addClass( 'bbg_xiv-home_gallery' );\n                    }\n                    e.preventDefault();\n                    return;\n                }\n                // setup headings\n                jQuery(\"div#\"+divGallery.id+\"-heading\").hide();\n                var jqueryLoading=true;\n                try {\n                    // There is a very rare failure of the following\n                    jQuery(divGallery).empty().append(jQuery.mobile.loading(\"show\",{text:\"Loading... please wait.\",textVisible:true,textonly:false}));\n                } catch ( error ) {\n                    console.log( error );\n                    //console.log(\"jQuery.mobile.loading._widget=\",jQuery.mobile.loading._widget);\n                    jQuery(divGallery).empty().append('<h1 class=\"bbg_xiv-info\">Loading... please wait.</h1>');\n                    jQuery.mobile.loading._widget=undefined;\n                    jqueryLoading=false;\n                }\n                var specifiers=this.dataset.specifiers;\n                // extract individual gallery parameters\n                if(bbg_xiv.bbg_xiv_wp_rest_api){\n                    // translation maps for gallery shortcode parameter names and values to WP REST API option names and values\n                    var nameMap={\n                        id:\"parent\",\n                        ids:\"include\",\n                        bb_tags:\"bb-tags\"\n                    };\n                    // really should have a value map per parameter name but fortunately there are no overlaps\n                    var valueMap={\n                        ASC:\"asc\",\n                        DESC:\"desc\"\n                    };\n                }\n                var matches=specifiers.match(/(\\w+)=\"([^\"]+)\"/g);\n                var parameters={};\n                var ids=false;\n                matches.forEach(function(match){\n                    var specifier=match.match(/(\\w+)=\"([^\"]+)\"/);\n                    if(bbg_xiv.bbg_xiv_wp_rest_api){\n                        // translate gallery shortcode parameters to WP REST API options\n                        parameters[nameMap[specifier[1]]?nameMap[specifier[1]]:specifier[1]]=valueMap[specifier[2]]?valueMap[specifier[2]]:specifier[2];\n                        if(specifier[1]===\"ids\"){\n                            ids=true;\n                        }\n                    }else{\n                        parameters[specifier[1]]=specifier[2];\n                    }\n                });\n                if ( bbg_xiv.bbg_xiv_wp_rest_api && ids && ! parameters.orderby ) {\n                    // for ids use the explicit order in ids\n                    parameters.orderby = 'include';\n                }\n                var form=jqThis.parents(\"div.navbar-collapse\").first().find(\"form[role='search']\");\n                if(bbg_xiv.bbg_xiv_wp_rest_api){\n                    // uses the WP REST API - requires the WP REST API plugin\n                    var images=bbg_xiv.images[divGallery.id]=new wp.api.collections.Media();\n                    images.once(\"sync\",function(){\n                        // the sync event will occur once only on the Backbone fetch of the collection\n                        handleResponse(!!this.length);\n                    },images);\n                    // get the collection specified by the parameters\n                    parameters.per_page=bbg_xiv.wpRestApiMaxPerPage;\n                    images.fetch({\n                        data:parameters,\n                        success: function() {\n                        },\n                        error: function( c, r ) {\n                            console.log(\"error:r=\",r);\n                            handleResponse(false);\n                        }\n                    });\n                }else{\n                    // old proprietary non REST way to load the Backbone image collection - does not require the WP REST API plugin\n                    var postData={\n                        action:\"bbg_xiv_search_media\",\n                        _wpnonce:form.find(\"input[name='_wpnonce']\").val(),\n                        _wp_http_referer:form.find(\"input[name='_wp_http_referer']\").val()\n                    };\n                    // add individual gallery parameters to post data\n                    for(var parameter in parameters){\n                        postData[parameter]=parameters[parameter];\n                    }\n                    jQuery.post(bbg_xiv.ajaxurl,postData,function(r){\n                        if(r===\"-1\"){\n                            r=\"\";\n                        }\n                        bbg_xiv.images[divGallery.id]=null;\n                        bbg_xiv[divGallery.id+\"-data\"]=r;\n                        handleResponse(!!r);\n                    });\n                }\n                // update active in gallery tabs\n                jqThis.parents(\"div.bbg_xiv-bootstrap.bbg_xiv-gallery\").find(\"div.bbg_xiv-gallery_tabs_container nav.navbar ul.nav-tabs li\").removeClass(\"active\")\n                    .find(\"a[data-view='\"+view+\"']\").parent().addClass(\"active\");\n                if ( view !== 'gallery_home' ) {\n                    jqThis.closest( 'div.bbg_xiv-gallery' ).removeClass( 'bbg_xiv-home_gallery' );\n                } else {\n                    jqThis.closest( 'div.bbg_xiv-gallery' ).addClass( 'bbg_xiv-home_gallery' );\n                }\n            }\n            e.preventDefault();\n        });\n        // wireup Galleries tabs \n        jQuery(\"div.bbg_xiv-gallery_tabs_container nav.navbar ul.nav-tabs li a[data-view^='gallery_']\").click(function(e){\n            jQuery(this).parents(\"div.bbg_xiv-bootstrap.bbg_xiv-gallery\")\n                .find(\"nav.bbg_xiv-gallery_navbar ul.nav li.dropdown ul.bbg_xiv-view_menu li > a[data-view='\"+this.dataset.view+\"']\").click();\n            e.preventDefault();\n        });\n        // wireup the handler for searching\n        jQuery(\"form.bbg_xiv-search_form input[type='text']\").keypress(function(e){\n            if(e.which===13){\n                // need to do this to hide virtual keyboard on mobile devices\n                jQuery(this).blur();\n            }\n        });\n        jQuery(\"form.bbg_xiv-search_form button\").each(function(){\n            var query;\n            var offset;\n            var page;\n            var count=Number.MAX_SAFE_INTEGER;\n            var pages=Number.MAX_SAFE_INTEGER;\n            jQuery(this).click(function(e){\n                var searchLimit = parseInt( bbg_xiv.bbg_xiv_max_search_results, 10 );\n                if(bbg_xiv.bbg_xiv_wp_rest_api&&searchLimit>bbg_xiv.wpRestApiMaxPerPage){\n                    searchLimit=bbg_xiv.wpRestApiMaxPerPage;\n                }\n                var searchBtn=jQuery(this);\n                searchBtn.prop(\"disabled\",true);\n                var startSearch=\"search images on site\";\n                var continueSearch=\"continue current search\";\n                var divGallery=searchBtn.parents(\"div.bbg_xiv-gallery\").find(\"div.bbg_xiv-gallery_envelope\")[0];\n                var form=searchBtn.parents(\"form[role='search']\");\n                var input=form.find(\"input[type='text']\");\n                var value=input.val();\n                var postData;\n                if(value){\n                    // new search\n                    query=value;\n                    offset=0;\n                    page=1;\n                    // start new search history\n                    bbg_xiv.search[divGallery.id]={history:[],index:-1,done:false};\n                    // get count\n                    if(!window.bbg_xiv.bbg_xiv_wp_rest_api){\n                        postData = {\n                            action:\"bbg_xiv_search_media_count\",\n                            query:query,\n                            _wpnonce:form.find(\"input[name='_wpnonce']\").val(),\n                            _wp_http_referer:form.find(\"input[name='_wp_http_referer']\").val()\n                        };\n                        jQuery.post(bbg_xiv.ajaxurl,postData,function(r){\n                            count = parseInt( r, 10 );\n                        });\n                    }\n                }else if(typeof query===\"undefined\"){\n                    e.preventDefault();\n                    return;\n                }\n                // setup headings\n                jQuery(\"div#\"+divGallery.id+\"-alt_gallery_heading\").hide();\n                var jqueryLoading=true;\n                try {\n                    // There is a very rare failure of the following\n                    jQuery(divGallery).empty().append(jQuery.mobile.loading(\"show\",{text:\"Loading... please wait.\",textVisible:true,textonly:false}));\n                } catch ( error) {\n                    console.log( error );\n                    //console.log(\"jQuery.mobile.loading._widget=\",jQuery.mobile.loading._widget);\n                    jQuery(divGallery).empty().append('<h1 class=\"bbg_xiv-info\">Loading... please wait.</h1>');\n                    jQuery.mobile.loading._widget=undefined;\n                    jqueryLoading=false;\n                }\n                jQuery(divGallery).parent().find(\"div.bbg_xiv-search_header\").hide();\n                function handleResponse(r){\n                    if(jqueryLoading){\n                        jQuery.mobile.loading(\"hide\");\n                        jQuery(divGallery).children().detach();\n                    }\n                    if(r){\n                        var images=bbg_xiv.constructImages(divGallery);\n                        var prevOffset=offset;\n                        var prevQuery=query;\n                        var heading=jQuery(\"div#\"+divGallery.id+\"-heading\");\n                        var search=bbg_xiv.search[divGallery.id];\n                        if((window.bbg_xiv.bbg_xiv_wp_rest_api&&page<=pages)||(!window.bbg_xiv.bbg_xiv_wp_rest_api&&offset+images.models.length<count)){\n                            // this search has more images\n                            offset+=searchLimit;\n                            input.val(\"\").attr(\"placeholder\",continueSearch);\n                            heading.find(\"button.bbg_xiv-search_scroll_right\").attr(\"disabled\",false);\n                        }else{\n                            // all search results have been returned\n                            search.done=true;\n                            input.attr(\"placeholder\",startSearch).val(query);\n                            query=undefined;\n                            offset=undefined;\n                            heading.find(\"button.bbg_xiv-search_scroll_right\").attr(\"disabled\",true);\n                        }\n                        // search results uses a heading to show status\n                        heading.find(\"span.bbg_xiv-search_heading_first\").text(bbg_xiv_lang[\"Search Results for\"]+\" \\\"\"+prevQuery+\"\\\"\");\n                        var title;\n                        if(window.bbg_xiv.bbg_xiv_wp_rest_api){\n                            title = bbg_xiv_lang.Page + ' ' + ( page - 1 ) + ' ' + bbg_xiv_lang.of + ' ' + ( pages !== Number.MAX_SAFE_INTEGER ? pages : '?' );\n                        }else{\n                            title = bbg_xiv_lang.Images + ' ' + ( prevOffset + 1 ) + ' ' + bbg_xiv_lang.to + ' ' + ( prevOffset + images.models.length ) + ' ' + bbg_xiv_lang.of +\n                                ' ' + ( count !== Number.MAX_SAFE_INTEGER ? count: '?' );\n                        }\n                        heading.find(\"span.bbg_xiv-search_heading_second\").text(title);\n                        // maintain a history of all images returned by this search\n                        search.history.push({images:images,title:title});\n                        search.index=search.history.length-1;\n                        var defaultView = bbg_xiv.getDefaultView( jQuery( divGallery ), null );\n                        bbg_xiv.renderGallery( divGallery, defaultView );\n                        heading.find(\"button.bbg_xiv-search_scroll_left\").attr(\"disabled\",search.index===0);\n                    }else{\n                        jQuery(divGallery).empty().append('<h1 class=\"bbg_xiv-warning\">'+bbg_xiv_lang[\"Nothing Found\"]+'</h1>');\n                    }\n                    var liSelectView=jQuery(divGallery.parentNode).find(\"nav.bbg_xiv-gallery_navbar ul.nav li.bbg_xiv-select_view\");\n                    var liFirst=liSelectView.find(\"ul.bbg_xiv-view_menu li.bbg_xiv-view\").removeClass(\"active\").filter(\".bbg_xiv-view_gallery\").addClass(\"active\");\n                    liSelectView.find(\"a.bbg_xiv-selected_view span\").text(liFirst.text());\n                    searchBtn.prop(\"disabled\",false);\n                }\n                if(window.bbg_xiv.bbg_xiv_wp_rest_api){\n                    // uses the WP REST API - requires the WP REST API plugin\n                    var images=bbg_xiv.images[divGallery.id]=new wp.api.collections.Media();\n                    images.once(\"sync\",function(){\n                        // the sync event will occur once only on the Backbone fetch of the collection\n                        handleResponse(!!this.length);\n                    },images);\n                    // get the next part of the multi-part search result as specified by page\n                    images.fetch({\n                        data:{\n                            search:query,\n                            // 'bb-tags':query,\n                            page:page++,\n                            per_page:searchLimit\n                        },\n                        success:function(c,r,o){\n                            // set the page variable from the page query parameter of the next page url in the HTTP header field \"Link\"\n                            var link=o.xhr.getResponseHeader(\"link\");\n                            if(link){\n                                var matches=link.match(/(\\?|&)page=(\\d+)(&[^>]+>;|>;)\\s+rel=\"next\"/);\n                                if(matches&&matches.length===4&&jQuery.isNumeric(matches[2])){\n                                    page = parseInt( matches[2], 10 );\n                                }else{\n                                    // no next page means search is complete\n                                }\n                            }else{\n                                // no HTTP \"Link\" header field means only one page so search is complete\n                            }\n                            // get count and pages from the HTTP header fields: \"X-WP-Total\", \"X-WP-TotalPages\" via wp-api.js\n                            count=images.state.totalObjects;\n                            pages=images.state.totalPages;\n                        },\n                        error: function( c, r ) {\n                            console.log(\"error:r=\",r);\n                            handleResponse(false);\n                        }\n                    });\n                }else{\n                    // old proprietary non REST way to load the Backbone image collection - does not require the WP REST API plugin\n                    // get the next part of the multi-part search result\n                    postData = {\n                        action:\"bbg_xiv_search_media\",\n                        query:query,\n                        limit:searchLimit,\n                        offset:offset,\n                        _wpnonce:form.find(\"input[name='_wpnonce']\").val(),\n                        _wp_http_referer:form.find(\"input[name='_wp_http_referer']\").val()\n                    };\n                    jQuery.post(bbg_xiv.ajaxurl,postData,function(r){\n                        bbg_xiv.images[divGallery.id]=null;\n                        bbg_xiv[divGallery.id+\"-data\"]=r;\n                        handleResponse(!!r);\n                    });\n                }\n                searchBtn.closest( 'div.bbg_xiv-gallery' ).removeClass( 'bbg_xiv-home_gallery' );\n                e.preventDefault();\n            });\n        });\n        jQuery(\"button.bbg_xiv-home\").click(function(e){\n            jQuery(this).parents(\"div.bbg_xiv-bootstrap.bbg_xiv-gallery\")\n                .find(\"nav.bbg_xiv-gallery_navbar ul.nav li.dropdown ul.bbg_xiv-view_menu li > a[data-view='gallery_home']\").click();\n            e.preventDefault();\n        });\n        jQuery( 'button.bbg_xiv-fullscreen' ).click(function() {\n            var $gallery = jQuery( this ).closest( 'div.bbg_xiv-gallery' );\n            if ( $gallery.hasClass( 'bbg_xiv-fullscreen_gallery' ) ) {\n                $gallery.removeClass( 'bbg_xiv-fullscreen_gallery' ).find( 'button.bbg_xiv-fullscreen' ).attr( 'title', bbg_xiv_lang['expand gallery to full-screen'] );\n                jQuery( 'html' ).removeClass( 'bbg_xiv-fullscreen_gallery' );\n            } else {\n                $gallery.addClass( 'bbg_xiv-fullscreen_gallery' ).find( 'button.bbg_xiv-fullscreen' ).attr( 'title', bbg_xiv_lang['shrink gallery from full-screen'] );\n                jQuery( 'html' ).addClass( 'bbg_xiv-fullscreen_gallery' );\n            }\n            jQuery( window ).resize();\n        });\n        jQuery( 'button.bbg_xiv-titles' ).click(function() {\n            var $this             = jQuery( this );\n            var $galleryContainer = $this.closest( 'div.bbg_xiv-bootstrap.bbg_xiv-gallery' );\n            var $container        = $galleryContainer.find( 'div.bbg_xiv-flex_container' );\n            if ( $container.length ) {\n                var $figure  = $container.find( 'div.bbg_xiv-flex_item figure' );\n                var $caption = $figure.find( 'figcaption' );\n                if ( $galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                    $caption.hide( 1000 );\n                    $galleryContainer.removeClass( 'bbg_xiv-caption_visible' );\n                    $this.attr( 'title', bbg_xiv_lang['show titles'] );\n                } else {\n                    $caption.show( 1000 );\n                    $galleryContainer.addClass( 'bbg_xiv-caption_visible' );\n                    $this.attr( 'title', bbg_xiv_lang['hide titles'] );\n                }\n                if ( $container.hasClass( 'bbg_xiv-contain' ) ) {\n                    // in tiles contain mode center image if title not displayed\n                    if ( $galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                        $figure.find( 'img' ).removeClass( 'bbg_xiv-vertical_center' );\n                    }else{\n                        $figure.find( 'img' ).addClass( 'bbg_xiv-vertical_center' );\n                    }\n                }\n                return;\n            }\n            $container = $galleryContainer.find( 'div.bbg_xiv-justified_container' );\n            if ( $container.length ) {\n                if ( $galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                    $galleryContainer.removeClass( 'bbg_xiv-caption_visible' );\n                    $this.attr( 'title', bbg_xiv_lang['show captions'] );\n                } else {\n                    $galleryContainer.addClass( 'bbg_xiv-caption_visible' );\n                    $this.attr( 'title', bbg_xiv_lang['hide captions'] );\n                }\n                window.setTimeout( function() {\n                    var $caption = $container.find( 'div.caption' );\n                    if ( $galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                        $caption.css( { display: 'block', opacity: '0.7' } );\n                    } else {\n                        $caption.css( { display: 'none',  opacity: '0.0' } );\n                    }\n                }, 1000 );\n            }\n        });\n        // wireup the handler for setting options\n        jQuery(\"button.bbg_xiv-configure\").click(function(e){\n            divConfigure.find(\"input#bbg_xiv-carousel_delay\").val(bbg_xiv.bbg_xiv_carousel_interval);\n            divConfigure.find(\"input#bbg_xiv-min_image_width\").val(bbg_xiv.bbg_xiv_flex_min_width);\n            divConfigure.find( 'input#bbg_xiv-miro_row_height' ).val( bbg_xiv.bbg_xiv_miro_row_height );\n            divConfigure.find(\"input#bbg_xiv-max_search_results\").val(bbg_xiv.bbg_xiv_max_search_results);\n            divConfigure.find(\"input#bbg_xiv-columns_in_dense_view\").val(bbg_xiv.bbg_xiv_flex_number_of_dense_view_columns);\n            divConfigure.find(\"input[name='bbg_xiv-default_view']\").prop(\"checked\",false);\n            if(bbg_xiv.usingServerDefaultView===false){\n                divConfigure.find(\"input[name='bbg_xiv-default_view'][value='\"+bbg_xiv.bbg_xiv_default_view+\"']\").prop(\"checked\",true);\n            }\n            divConfigure.find(\"input[name='bbg_xiv-bandwidth']\").prop(\"checked\",false);\n            divConfigure.find(\"input[name='bbg_xiv-bandwidth'][value='\"+bbg_xiv.bbg_xiv_bandwidth+\"']\").prop(\"checked\",true);\n            divConfigure.find(\"input[name='bbg_xiv-interface']\").prop(\"checked\",false);\n            divConfigure.find(\"input[name='bbg_xiv-interface'][value='\"+bbg_xiv.bbg_xiv_interface+\"']\").prop(\"checked\",true);\n            var gallery=jQuery(this).parents(\"div.bbg_xiv-gallery\");\n            var outer=gallery.find(\"div.bbg_xiv-configure_outer\");\n            outer.show();\n            var inner=gallery.find(\"div.bbg_xiv-configure_inner\");\n            inner.show();\n            e.preventDefault();\n        });\n        var divConfigure=jQuery(\".bbg_xiv-configure_inner\");\n        divConfigure.find( 'input[type=\"number\"]#bbg_xiv-max_search_results' ).change(function() {\n            // max seems to be broken so fix with javascript\n            var jqThis=jQuery(this);\n            var max     = parseInt( jqThis.val(), 10 );\n            var attrMax = parseInt( jqThis.attr( 'max' ), 10 );\n            if(bbg_xiv.bbg_xiv_wp_rest_api&&attrMax>bbg_xiv.wpRestApiMaxPerPage){\n                // WP REST API requires that per_page be between 1 and 100 inclusive\n                attrMax=bbg_xiv.wpRestApiMaxPerPage;\n            }\n            if(max>attrMax){\n                jqThis.val(attrMax);\n            }\n        });\n        divConfigure.find( 'button.bbg_xiv-configure_close,button.bbg_xiv-cancel_options' ).click(function() {\n            var gallery=jQuery(this).parents(\"div.bbg_xiv-gallery\");\n            var outer=gallery.find(\"div.bbg_xiv-configure_outer\");\n            outer.hide();\n            var inner=gallery.find(\"div.bbg_xiv-configure_inner\");\n            inner.hide();\n        });\n        divConfigure.find(\"button.bbg_xiv-help_options\").click(function(e){\n            window.open(bbg_xiv.helpOptionsUrl,\"_blank\");\n            e.preventDefault();\n        });\n        divConfigure.find(\"button.bbg_xiv-save_options\").click(function(e){\n            // save the options\n            bbg_xiv.bbg_xiv_carousel_interval=divConfigure.find(\"input#bbg_xiv-carousel_delay\").val();\n            bbg_xiv.bbg_xiv_flex_min_width=divConfigure.find(\"input#bbg_xiv-min_image_width\").val();\n            bbg_xiv.bbg_xiv_miro_row_height = divConfigure.find( 'input#bbg_xiv-miro_row_height' ).val();\n            bbg_xiv.bbg_xiv_max_search_results=divConfigure.find(\"input#bbg_xiv-max_search_results\").val();\n            bbg_xiv.bbg_xiv_flex_number_of_dense_view_columns=divConfigure.find(\"input#bbg_xiv-columns_in_dense_view\").val();\n            var defaultView=divConfigure.find(\"input[name='bbg_xiv-default_view']:checked\").val();\n            if(defaultView){\n                bbg_xiv.bbg_xiv_default_view=defaultView;\n                bbg_xiv.usingServerDefaultView=false;\n            }else{\n                bbg_xiv.usingServerDefaultView=true;\n            }\n            bbg_xiv.bbg_xiv_bandwidth=divConfigure.find(\"input[name='bbg_xiv-bandwidth']:checked\").val();\n            bbg_xiv.bbg_xiv_interface=divConfigure.find(\"input[name='bbg_xiv-interface']:checked\").val();\n            var cookie={\n                bbg_xiv_carousel_interval:bbg_xiv.bbg_xiv_carousel_interval,\n                bbg_xiv_flex_min_width:bbg_xiv.bbg_xiv_flex_min_width,\n                bbg_xiv_miro_row_height: bbg_xiv.bbg_xiv_miro_row_height,\n                bbg_xiv_max_search_results:bbg_xiv.bbg_xiv_max_search_results,\n                bbg_xiv_flex_number_of_dense_view_columns:bbg_xiv.bbg_xiv_flex_number_of_dense_view_columns,\n                bbg_xiv_bandwidth:bbg_xiv.bbg_xiv_bandwidth,\n                bbg_xiv_interface:bbg_xiv.bbg_xiv_interface\n            };\n            if(bbg_xiv.usingServerDefaultView===false){\n                cookie.bbg_xiv_default_view=bbg_xiv.bbg_xiv_default_view;\n            }\n            cookie=JSON.stringify(cookie);\n            bbg_xiv.setCookie(\"bbg_xiv\",cookie,30);\n            bbg_xiv.getOptionsFromCookie();\n            bbg_xiv.calcBreakpoints();\n            var gallery=jQuery(this).parents(\"div.bbg_xiv-gallery\");\n            var outer=gallery.find(\"div.bbg_xiv-configure_outer\");\n            outer.hide();\n            var inner=gallery.find(\"div.bbg_xiv-configure_inner\");\n            inner.hide();\n            // redisplay the \"Gallery\" view using the new option values\n            bbg_xiv.resetGallery(jQuery(this).parents(\"div.bbg_xiv-gallery\"));\n            e.preventDefault();\n        });\n        jQuery(\"button.bbg_xiv-help\").click(function(e){\n            var view = jQuery( this ).closest( 'div.navbar-collapse' ).find( 'ul.navbar-nav li.bbg_xiv-select_view ul.bbg_xiv-view_menu li.bbg_xiv-view.active a' ).data( 'view' );\n            window.open( bbg_xiv.docUrl + '#view-' + view.toLowerCase(), '_blank' );\n            this.blur();\n            e.preventDefault();\n        });\n        // wireup the handler for scrolling through search results\n        jQuery( 'div.bbg_xiv-search_header button.bbg_xiv-search_scroll_left,div.bbg_xiv-search_header button.bbg_xiv-search_scroll_right' ).click(function() {\n            var jqThis = jQuery( this );\n            var heading=jqThis.parents(\"div.bbg_xiv-search_header\");\n            var id=heading.attr(\"id\").replace(\"-heading\",\"\");\n            var gallery=heading.parents(\"div.bbg_xiv-gallery\");\n            var search=bbg_xiv.search[id];\n            if(jqThis.hasClass(\"bbg_xiv-search_scroll_left\")){\n                if(search.index>0){\n                    if(!--search.index){\n                        jqThis.attr(\"disabled\",true);\n                    }\n                    heading.find(\"button.bbg_xiv-search_scroll_right\").attr(\"disabled\",false);\n                }else{\n                }\n            }else{\n                if(search.index<search.history.length-1){\n                    ++search.index;\n                    if(search.index===search.history.length-1&&search.done){\n                        heading.find(\"button.bbg_xiv-search_scroll_right\").attr(\"disabled\",true);\n                    }\n                    heading.find(\"button.bbg_xiv-search_scroll_left\").attr(\"disabled\",false);\n                }else{\n                    // load the next part of the multi-part search\n                    gallery.find(\"nav.navbar form.bbg_xiv-search_form button[type='submit']\").click();\n                    return;\n                }\n            }\n            if(search.index>=0&&search.index<search.history.length){\n                var history=search.history[search.index];\n                bbg_xiv.images[id]=history.images;\n                heading.find(\"span.bbg_xiv-search_heading_second\").text(history.title);\n                var divGallery  = gallery.find( 'div.bbg_xiv-gallery_envelope' );\n                var defaultView = bbg_xiv.getDefaultView( divGallery, null );\n                bbg_xiv.renderGallery( divGallery[0], defaultView );\n                // reset navbar to \"Gallery\" view\n                var liSelectView=gallery.find(\"nav.bbg_xiv-gallery_navbar ul.nav li.bbg_xiv-select_view\");\n                var liFirst=liSelectView.find(\"ul.bbg_xiv-view_menu li.bbg_xiv-view\").removeClass(\"active\").filter(\".bbg_xiv-view_gallery\").addClass(\"active\");\n                liSelectView.find(\"a.bbg_xiv-selected_view span\").text(liFirst.text());\n            }\n        });\n        // make the \"Images\" brand clickable for mobile devices and send click to the toggle button\n        jQuery(\"a.bbg_xiv-images_brand,a.bbg_xiv-tabs_brand\").click(function(e){\n            var toggle=jQuery(this).siblings(\"button.navbar-toggle\");\n            if(toggle.css(\"display\")!==\"none\"){\n                toggle.click();\n            }\n            e.preventDefault();\n        });\n        // wireup mobile only events\n        jQuery(window).on(\"swipe\",function(e){\n            var carousel=jQuery(\"div.bbg_xiv-gallery_envelope div.carousel\");\n            if(carousel.length){\n                // ignore swipes near carousel slider\n                if(e.pageY>jQuery(\"div.carousel-indicators\").offset().top-50){\n                    return;\n                }\n                if(e.swipestop.coords[0]>e.swipestart.coords[0]){\n                    carousel.find(\"a.left.carousel-control\").click();\n                }else{\n                    carousel.find(\"a.right.carousel-control\").click();\n                }\n                return;\n            }\n            // hide/show title and caption of overlay on swipe\n            var inner=jQuery(\"div.bbg_xiv-dense_inner\");\n            inner.find( '.bbg_xiv-dense_title, .bbg_xiv-dense_caption' ).each(function() {\n                var $this = jQuery( this );\n                var color = $this.css( 'color' );\n                if ( color !== 'transparent' && color !== 'rgba(0, 0, 0, 0)' ) {   // TODO: find safer test for transparent\n                    $this.css({ color: 'transparent',      textShadow: 'none'             });\n                }else{\n                    $this.css({ color: bbg_xiv.titleColor, textShadow: bbg_xiv.titleShadow});\n                }\n            });\n        });\n        jQuery( window ).on( 'orientationchange', function() {\n            var $body = jQuery( 'body' );\n            if ( $body.hasClass( 'admin-bar' ) && jQuery( 'div#wpadminbar' ).css( 'position' ) == 'fixed' ) {\n                $body.addClass( 'bbg_xiv-fixed_admin_bar' );\n            } else {\n                $body.removeClass( 'bbg_xiv-fixed_admin_bar' );\n            }\n            jQuery(\"div.bbg_xiv-gallery\").each(function(){\n                bbg_xiv.resetGallery(jQuery(this));\n            });\n        });\n        if(!bbg_xiv.bbg_xiv_wp_rest_api){\n            // if using the REST API cannot do resize here since the models may be asynchronously created\n            jQuery(window).resize();\n        }\n        // If TwentySixteen theme has border then add class to body element to indicate this.\n        var $body            = jQuery( 'body' );\n        var bodyBeforeStyle  = window.getComputedStyle( $body[0], ':before' );\n        if ( bodyBeforeStyle && bodyBeforeStyle.position === 'fixed' && bodyBeforeStyle.zIndex > 0 ) {\n            var height = parseInt( bodyBeforeStyle.height, 10 );\n            if ( height > 8 && height < 64 ) {\n                $body.addClass( 'bbg_xiv-twentysixteen_with_border' );\n            }\n        }\n        if ( $body.hasClass( 'admin-bar' ) && jQuery( 'div#wpadminbar' ).css( 'position' ) == 'fixed' ) {\n            $body.addClass( 'bbg_xiv-fixed_admin_bar' );\n        }\n        \n    });   // jQuery(document).ready(function(){\n\n    //cookie test code\n    //window.alert(\"bbg_xiv_test=\"+bbg_xiv.getCookie(\"bbg_xiv_test\"));\n    //bbg_xiv.setCookie(\"bbg_xiv_test\",window.prompt(\"bbg_xiv_test\",\"null\"));\n}());\n\n"]}