{"version":3,"sources":["bbg_xiv-gallery.js"],"names":["bbg_xiv","window","docUrl","helpOptionsUrl","galleryOfGalleriesTitle","bbg_xiv_lang","templateOptions","evaluate","interpolate","escape","variable","images","search","galleries","Image","Backbone","Model","extend","idAttribute","bbg_xiv_wp_rest_api","Images","Collection","model","ImageView","View","render","srcOnly","html","this","template","attributes","$el","GalleryView","renderBootstrapGallery","container","collection","imageView","_","jQuery","imagesHtml","forEach","index","galleryView","items","empty","append","find","renderFlex","containerWidth","width","bbg_xiv_container_width","id","guiInterface","addClass","renderTiles","flags","indexOf","Modernizr","objectfit","load","naturalWidth","naturalHeight","galleryContainer","closest","attr","hover","hasClass","parents","each","show","hide","click","e","caption","parentNode","data","preventDefault","renderCarousel","bulletsHtml","browser","gallery","size","length","bullets","renderTabs","tabView","tabsHtml","tabs","renderDense","mode","titleView","titlesHtml","titles","renderJustified","justifiedContainer","$justifiedGallery","justifiedGallery","margins","rowHeight","bbg_xiv_miro_row_height","lastRow","refreshSensitivity","refreshTime","on","css","matchMedia","matches","removeClass","img","querySelector","item","addEventListener","style","display","opacity","stopImmediatePropagation","$caption","parseFloat","renderGeneric","fieldNames","dumpFieldNames","Object","keys","key","push","buffer","name","dumpFieldValues","renderTable","constructImages","reset","JSON","parse","console","log","constructed","renderGallery","view","dataset","concat","split","jqGallery","constructOverlay","outer","inner","$altInner","overlayShowing","overlayLocked","mouseX","NaN","mouseY","hideOverlay","type","Math","abs","screenX","screenY","$inner","$navbar","setTimeout","add","mousemove","call","fullImg","fullTitle","fullCaption","titleColor","titleShadow","color","textShadow","altOverlayView","showOverlay","$button","tagName","parent","alt","replace","galleryId","bbg_xivGalleryId","get","bbg_xivImageId","src","getSrc","bbg_srcset","srcset","getSrcset","removeAttribute","textContent","getTitle","getCaption","error","stopPropagation","pause","mouseenter","gallery_home","titlesButton","flexbox","flexwrap","bbg_xiv_disable_flexbox","resize","carouselId","button","$carousel","carousel","$this","$span","open","resetGallery","prevChangeTime","input","slider","slideChange","val","change","Date","now","i","isNumeric","parseInt","keypress","which","blur","focus","relatedTarget","$gallery","$divCarousel","scrollTop","scrollHeight","height","offset","top","$body","$adminBar","adminBarHeight","outerHeight","bodyBeforeHeight","bodyBeforeStyle","getComputedStyle","position","interval","bbg_xiv_carousel_interval","prettifyTabs","href","substr","lastIndexOf","r0","j","f","w","h","W","H","r","max","floor","$window","fullscreen","$content","filter","galleryIndex","toggle","siblings","jqThis","bbg_xiv_flex_number_of_dense_view_columns","normal","highlight","background-color","border-color","bottom","div","li","checked","value","menuItems","bbg_xiv_flex_min_width_for_dense_view","galleryOfGalleries","models","gallery_index","divAltGalleryHeading","text","initial","navbar","currentView","divGallery","defaultView","getDefaultView","liSelectView","liFirst","toLowerCase","fullSize","icon","bandwidth","source_url","url","bbg_thumbnail_src","bbg_large_src","bbg_medium_large_src","bbg_medium_src","bbg_xiv_bandwidth","title","rendered","post_title","trim","noAlt","post_excerpt","getAlt","noCaption","alt_text","image_alt","getPostContent","postContent","bbg_post_content","post_content","getSizes","localStorage","setItem","removeItem","localStorageAvailable","setCookie","expires","d","setTime","getTime","document","cookie","toUTCString","getCookie","getItem","start","end","substring","calcBreakpoints","minFlexWidth","bbg_xiv_flex_min_width","breakpoints","cssClass","getOptionsFromCookie","options","carousel_interval","flex_min_width","miro_row_height","max_search_results","bbg_xiv_max_search_results","flex_number_of_dense_view_columns","bbg_xiv_default_view","usingServerDefaultView","bbg_xiv_interface","userAgent","navigator","lowbandwidth","test","touchevents","wpRestApiMaxPerPage","pxWidth","minFlexWidthForCaption","bbg_xiv_flex_min_width_for_caption","breakpoint","ready","wp","api","loadPromise","done","collections","Media","select","handleResponse","jqueryLoading","mobile","loading","children","detach","prop","liGallery","textVisible","textonly","_widget","undefined","specifiers","nameMap","ids","bb_tags","valueMap","ASC","DESC","match","parameters","specifier","orderby","form","first","once","per_page","fetch","success","c","postData","action","_wpnonce","_wp_http_referer","parameter","post","ajaxurl","query","page","count","Number","MAX_SAFE_INTEGER","pages","searchLimit","searchBtn","startSearch","continueSearch","history","prevOffset","prevQuery","heading","Page","of","to","o","link","xhr","getResponseHeader","state","totalObjects","totalPages","limit","$galleryContainer","$container","$figure","divConfigure","attrMax","stringify","pageY","swipestop","coords","swipestart","zIndex"],"mappings":"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","file":"bbg_xiv-gallery.js","sourcesContent":["// Backbone.js Model View Presenter for the 'gallery' shortcode\n\n/*\n    This program is free software; you can redistribute it and/or\n    modify it under the terms of the GNU General Public License\n    as published by the Free Software Foundation; either version 2\n    of the License, or (at your option) any later version.\n\n    This program is distributed in the hope that it will be useful,\n    but WITHOUT ANY WARRANTY; without even the implied warranty of\n    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n    GNU General Public License for more details.\n\n    You should have received a copy of the GNU General Public License\n    along with this program; if not, write to the Free Software\n    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n\n    Copyright 2015  Magenta Cuda\n*/\n\n(function(){\n    var bbg_xiv=window.bbg_xiv=window.bbg_xiv||{};\n    // URLs\n    bbg_xiv.docUrl         = \"http://docs.magentacuda.com/\";\n    bbg_xiv.helpOptionsUrl = \"http://docs.magentacuda.com/#options\";\n    // Strings\n    bbg_xiv.galleryOfGalleriesTitle=bbg_xiv_lang.galleryOfGalleriesTitle;\n    // use WordPress templating syntax; see .../wp-includes/js/wp-util.js\n    bbg_xiv.templateOptions={\n        evaluate:    /<#([\\s\\S]+?)#>/g,\n        interpolate: /\\{\\{\\{([\\s\\S]+?)\\}\\}\\}/g,\n        escape:      /\\{\\{([^\\}]+?)\\}\\}(?!\\})/g,\n        variable:    'data'\n    };\n    \n    bbg_xiv.images={};\n    bbg_xiv.search={};      // state info for multi part search results\n    bbg_xiv.galleries={};   // state info for alternate galleries\n    \n    bbg_xiv.Image=Backbone.Model.extend({idAttribute:window.bbg_xiv.bbg_xiv_wp_rest_api?\"id\":\"ID\"});\n    \n    bbg_xiv.Images=Backbone.Collection.extend({model:bbg_xiv.Image});\n    \n    bbg_xiv.ImageView=Backbone.View.extend({\n        render:function(srcOnly){\n            var html=this.template(this.model.attributes);\n            if(srcOnly){\n                return html;\n            }\n            this.$el.html(html);\n            return this;\n        }    \n    });\n    \n    bbg_xiv.GalleryView=Backbone.View.extend({\n        render:function(){\n            var html=this.template(this.model.attributes);\n            this.$el.html(html);\n            return this;\n        }\n    });\n    \n    bbg_xiv.renderBootstrapGallery=function(container,collection){\n        var imageView=new bbg_xiv.ImageView();\n        // attach template to imageView not ImageView.prototype since template is specific to imageView\n        imageView.template=_.template( jQuery(\"script#bbg_xiv-template_gallery_item\").html(),null,bbg_xiv.templateOptions);\n        var imagesHtml=\"\";\n        collection.forEach(function(model,index){\n            imageView.model=model;\n            imagesHtml+=imageView.render(true);\n            // Bootstrap's grid needs \"clear\" elements to correctly align non-uniformly sized items\n            if(index%4===3){\n                imagesHtml+='<br class=\"clearfix visible-lg-block\">';\n            }\n            if(index%3===2){\n                imagesHtml+='<br class=\"clearfix visible-md-block\">';\n            }\n            if(index%2===1){\n                imagesHtml+='<br class=\"clearfix visible-sm-block\">';\n            }\n        } );\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    items:imagesHtml\n                }\n            }\n        } );\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_gallery_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"div.container\"));\n    };\n\n    bbg_xiv.renderFlex=function(container,collection){\n        var containerWidth=container.width();\n        var imageView=new bbg_xiv.ImageView();\n        // attach template to imageView not ImageView.prototype since template is specific to imageView\n        imageView.template=_.template( jQuery(\"script#bbg_xiv-template_flex_item\").html(),null,bbg_xiv.templateOptions);\n        var imagesHtml=\"\";\n        collection.forEach(function( model ) {\n            model.attributes.bbg_xiv_container_width=containerWidth;\n            imageView.model=model;\n            imagesHtml+=imageView.render(true);\n        });\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    id:collection.id,\n                    items:imagesHtml\n                }\n            }\n        });\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_flex_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"div.bbg_xiv-flex_container\"));\n        if ( bbg_xiv.guiInterface === 'touch' ) {\n            container.find(\"div.bbg_xiv-flex_container div.bbg_xiv-flex_item div.bbg_xiv-dense_full_btn\").addClass(\"bbg_xiv-touch\");\n        }\n    };\n\n    bbg_xiv.renderTiles=function(container,collection,flags){\n        // gallery tiles have exactly the same HTML elements as the gallery Flex items but we will use CSS specificity to override the Flex container CSS\n        container.addClass(\"bbg_xiv-tiles_container\");\n        // in the default mode of the square tiles the images cover the square tiles i.e., object-fit: cover;\n        if(flags.indexOf(\"contain\")!==-1){\n            // the images in the square tiles are contained in the square tiles i.e., object-fit: contain;\n            container.addClass(\"bbg_xiv-contain\");\n        }else if(flags.indexOf(\"fill\")!==-1){\n            // object-fit: fill;\n            container.addClass(\"bbg_xiv-fill\");\n        }\n        bbg_xiv.renderFlex(container,collection);\n        if(!Modernizr.objectfit||flags.indexOf(\"contain\")!==-1){\n            // IE and Edge do not support objectfit so we set a class to differentiate between landscape and portrait mode which will let our CSS rules simulate object-fit:cover\n            container.find(\"div.bbg_xiv-flex_item img\").load(function(){\n                if(this.naturalWidth<this.naturalHeight){\n                    jQuery(this).addClass(\"bbg_xiv-portrait\");\n                }\n            });\n        }\n        var flexContainer    = container.find( 'div.bbg_xiv-flex_container');\n        var galleryContainer = flexContainer.closest( 'div.bbg_xiv-gallery' ).addClass( 'bbg_xiv-caption_visible' );\n        galleryContainer.find( 'button.bbg_xiv-titles' ).attr( 'title', bbg_xiv_lang['hide titles'] );\n        // flip display state of caption on hover\n        container.find(\"div.bbg_xiv-dense_full_btn\").hover(\n            function() {\n                if ( ! galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                    jQuery(this).parents(\"div.bbg_xiv-flex_item\").find(\"figure figcaption\").each(function(){\n                        jQuery(this).show();\n                    });\n                }\n            },\n            function() {\n                if ( ! galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                    jQuery(this).parents(\"div.bbg_xiv-flex_item\").find(\"figure figcaption\").each(function(){\n                        jQuery(this).hide();\n                    });\n                }\n            }\n        );\n        if ( bbg_xiv.guiInterface === 'touch' ) {\n            container.find(\"div.bbg_xiv-flex_item a\").click(function(e){\n                if ( ! galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                    var caption=jQuery(this.parentNode).find(\"figure figcaption\");\n                    if(!caption.data(\"visible\")){\n                        container.find(\"div.bbg_xiv-flex_item figure figcaption\").data(\"visible\",false);\n                        caption.data(\"visible\",true);\n                        e.preventDefault();\n                    }\n                }\n            });\n        }\n    };\n\n    bbg_xiv.renderCarousel=function(container,collection,id){\n        var containerWidth=container.width();\n        var imageView=new bbg_xiv.ImageView();\n        imageView.template=_.template(jQuery(\"script#bbg_xiv-template_carousel_item\").html(),null,bbg_xiv.templateOptions);\n        var bulletsHtml=\"\";\n        var imagesHtml=\"\";\n        collection.forEach(function(model,index){\n            model.attributes.browser=bbg_xiv.browser;\n            model.attributes.index=index;\n            model.attributes.bbg_xiv_container_width=containerWidth;\n            imageView.model=model;\n            var active=index ===0?' class=\"active\"':'';\n            bulletsHtml+='<li data-target=\"#'+id+'\" data-slide-to=\"'+index+'\"'+active+'></li>';\n            imagesHtml+=imageView.render(true);\n        } );\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    id:id,\n                    gallery:collection.id,\n                    size:collection.length,\n                    bullets:bulletsHtml,\n                    items:imagesHtml\n                }\n            }\n        } );\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_carousel_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find( \"div.carousel.slide\"));\n    };\n\n    bbg_xiv.renderTabs=function(container,collection,id){\n        var containerWidth=container.width();\n        var tabView=new bbg_xiv.ImageView();\n        tabView.template=_.template(jQuery(\"script#bbg_xiv-template_tabs_tab\").html(),null,bbg_xiv.templateOptions);\n        var imageView=new bbg_xiv.ImageView();\n        imageView.template=_.template(jQuery(\"script#bbg_xiv-template_tabs_item\").html(),null,bbg_xiv.templateOptions);\n        var tabsHtml=\"\";\n        var imagesHtml=\"\";\n        collection.forEach(function(model,index){\n            model.attributes.browser=bbg_xiv.browser;\n            model.attributes.index=index;\n            model.attributes.bbg_xiv_container_width=containerWidth;\n            imageView.model=tabView.model=model;\n            tabsHtml+=tabView.render(true);\n            imagesHtml+=imageView.render(true);\n        });\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    id:id,\n                    tabs:tabsHtml,\n                    items:imagesHtml\n                }\n            }\n        });\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_tabs_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"div.bbg_xiv-template_tabs_container\"));\n    };\n\n    bbg_xiv.renderDense=function(container,collection,id,mode){\n        var containerWidth=container.width();\n        var titleView=new bbg_xiv.ImageView();\n        titleView.template=_.template(jQuery(\"script#bbg_xiv-template_dense_title\").html(),null,bbg_xiv.templateOptions);\n        var imageView=new bbg_xiv.ImageView();\n        imageView.template=_.template(jQuery(\"script#bbg_xiv-template_dense_image\").html(),null,bbg_xiv.templateOptions);\n        var titlesHtml=\"\";\n        var imagesHtml=\"\";\n        collection.forEach(function(model,index){\n            model.attributes.mode=mode;\n            model.attributes.index=index;\n            model.attributes.bbg_xiv_container_width=containerWidth;\n            imageView.model=titleView.model=model;\n            titlesHtml+=titleView.render(true);\n            imagesHtml+=imageView.render(true);\n        });\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    id:id,\n                    gallery:collection.id,\n                    mode:mode,\n                    titles:titlesHtml,\n                    images:imagesHtml\n                }\n            }\n        });\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_dense_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"div.bbg_xiv-dense_container\"));\n    };\n    \n    bbg_xiv.renderJustified=function(container,collection){\n        var imageView=new bbg_xiv.ImageView();\n        // attach template to imageView not ImageView.prototype since template is specific to imageView\n        imageView.template=_.template( jQuery(\"script#bbg_xiv-template_justified_item\").html(),null,bbg_xiv.templateOptions);\n        var imagesHtml=\"\";\n        collection.forEach(function( model ) {\n            imageView.model=model;\n            imagesHtml+=imageView.render(true);\n        });\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    id:collection.id,\n                    items:imagesHtml\n                }\n            }\n        });\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_justified_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        var justifiedContainer=galleryView.render().$el.find(\"div.bbg_xiv-justified_container\");\n        container.append(justifiedContainer);\n        var $justifiedGallery = justifiedContainer.find( 'div.bbg_xiv-justified_gallery' );\n        $justifiedGallery.justifiedGallery({margins: 5, rowHeight: bbg_xiv.bbg_xiv_miro_row_height, lastRow: 'nojustify', refreshSensitivity: 0, refreshTime: 250 })\n            .on( 'jg.complete jg.resize', function() {\n            // Why are there negative margins on the img - anyway remove them\n            $justifiedGallery.find( 'img' ).css( 'margin', '0' );\n        });\n        if ( bbg_xiv.guiInterface === 'touch' ) {\n            justifiedContainer.addClass( 'bbg_xiv-touch' );\n            $justifiedGallery.find( 'div.bbg_xiv-justified_item > a' ).click(function( e ) {\n                e.preventDefault();\n            });\n            justifiedContainer.addClass( window.matchMedia( '(max-aspect-ratio:1/1)' ).matches ? 'bbg_xiv-portrait' : 'bbg_xiv-landscape' );\n        }\n        justifiedContainer   = container.find( 'div.bbg_xiv-justified_container' );\n        var galleryContainer = justifiedContainer.closest( 'div.bbg_xiv-gallery' ).removeClass( 'bbg_xiv-caption_visible' );\n        galleryContainer.find( 'button.bbg_xiv-titles' ).attr( 'title',  bbg_xiv_lang['show captions'] );\n        // if CC has been set to visible then override Justified Gallery's hover handlers\n        justifiedContainer.find(\"div.bbg_xiv-justified_gallery div.bbg_xiv-justified_item\").each(function(){\n          var img=this.querySelector(\"img\");\n          var caption=this.querySelector(\"div.caption\");\n          [img,caption].forEach(function(item){\n              // these handlers need work if executed before or after the Justified Gallery's handlers\n              item.addEventListener(\"mouseover\",function(e){\n                  if ( galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                      caption.style.display=\"block\";\n                      caption.style.opacity=\"0.7\";\n                      e.stopImmediatePropagation();\n                  }\n              });\n              item.addEventListener(\"mouseout\",function(e){\n                  if ( galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                      caption.style.display=\"block\";\n                      caption.style.opacity=\"0.7\";\n                      e.stopImmediatePropagation();\n                  }\n              });\n          });\n          jQuery( img ).closest( 'a' ).click(function( e ) {\n              e.preventDefault();\n          });\n          jQuery( caption ).find( 'a' ).click( function( e ) {\n              var $caption = jQuery( this ).closest( 'div.caption' );\n              if ( parseFloat( $caption.css( 'opacity' ) ) < 0.1 ) {\n                  e.preventDefault();\n              }\n          } );\n        });\n    };\n\n    // renderGeneric() may work unmodified with your template.\n    // Otherwise you can use it as a base for a render function specific to your template.\n    // See renderGallery(), renderCarousel() or renderTabs() - all of which need some special HTML to work correctly.\n\n    bbg_xiv.renderGeneric=function(container,collection,template){\n        var imageView=new bbg_xiv.ImageView();\n        // attach template to imageView not ImageView.prototype since template is specific to imageView\n        imageView.template=_.template( jQuery(\"script#bbg_xiv-template_\"+template+\"_item\").html(),null,bbg_xiv.templateOptions);\n        var imagesHtml=\"\";\n        collection.forEach(function( model ) {\n            imageView.model=model;\n            imagesHtml+=imageView.render(true);\n        });\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    items:imagesHtml\n                }\n            }\n        } );\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_\"+template+\"_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"bbg_xiv-container\"));\n    };\n\n    // debugging utilities\n    \n    // dumpFieldNames() dumps field names as <th> elements in a <tr> element\n    var fieldNames=[];\n    bbg_xiv.dumpFieldNames=function(collection){\n        collection.forEach(function(model){\n            Object.keys(model.attributes).forEach(function(key){\n                if(fieldNames.indexOf(key)===-1){\n                    fieldNames.push(key);\n                }\n            });\n        });\n        var buffer=\"<tr>\";\n        fieldNames.forEach(function(name){\n            buffer+=\"<th>\"+name+\"</th>\";\n        });\n        buffer+=\"</tr>\";\n        return buffer;\n    };\n    \n    // dumpFieldValues() dumps field values as <td> elements in <tr> elements\n    bbg_xiv.dumpFieldValues=function(collection){\n        var buffer=\"\";\n        collection.forEach(function(model){\n            buffer+=\"<tr>\";\n            fieldNames.forEach(function(name){\n                buffer+=\"<td>\"+model.attributes[name]+\"</td>\";\n            });\n            buffer+=\"</tr>\";\n        });\n        return buffer;        \n    };\n    \n    bbg_xiv.renderTable=function(container,collection){\n        var galleryView=new bbg_xiv.GalleryView({\n            model:{\n                attributes:{\n                    collection:collection\n                }\n            }\n        } );\n        galleryView.template=_.template(jQuery(\"script#bbg_xiv-template_table_container\").html(),null,bbg_xiv.templateOptions);\n        container.empty();\n        container.append(galleryView.render().$el.find(\"div.bbg_xiv-table\"));\n    };\n    \n    bbg_xiv.constructImages=function(gallery){\n        var images;\n        if(window.bbg_xiv.bbg_xiv_wp_rest_api){\n            images = bbg_xiv.images[ gallery.id ];\n        }else{\n            images = bbg_xiv.images[ gallery.id ] = new bbg_xiv.Images();\n            try{\n                images.reset(JSON.parse(window.bbg_xiv[gallery.id+\"-data\"]));\n            }catch(e){\n                console.log(\"reset(JSON.parse()) failed:\",e);\n                return images;\n            }\n        }\n        images.id=gallery.id;\n        images.constructed=true;\n        return images;\n    };\n    \n    bbg_xiv.renderGallery=function(gallery,view,flags){\n        if(!flags){\n            flags=[];\n        }\n        // extract flags from data attribute flags\n        if(gallery.dataset.flags){\n            flags=flags.concat(gallery.dataset.flags.split(\",\"));\n        }\n\n        var jqGallery=jQuery(gallery);\n        var images=bbg_xiv.images[gallery.id];\n        if(!images||!images.constructed){\n            images=bbg_xiv.constructImages(gallery);\n        }\n        // remember the initial statically loaded gallery so we can efficiently return to it\n        bbg_xiv.galleries[gallery.id]=bbg_xiv.galleries[gallery.id]||{images:{\"gallery_home\":images},view:\"gallery_home\"};\n        function constructOverlay() {\n            // gallery or dense view shows a full browser viewport view of an image when its fullscreen glyph is clicked\n            var outer          = jqGallery.find( 'div.bbg_xiv-dense_outer' );\n            var inner          = jqGallery.find( 'div.bbg_xiv-dense_inner' );\n            var $altInner      = jqGallery.find( 'div.bbg_xiv-dense_alt_inner' );\n            var overlayShowing = false;\n            var overlayLocked  = false;\n            var mouseX         = NaN;\n            var mouseY         = NaN;\n            var $caption       = null;\n            function hideOverlay( e ) {\n                if ( ! overlayShowing ) {\n                    // ignore events when overlay is transitioning to hide\n                    return;\n                }\n                if ( e.type !== 'click' ) {\n                    if ( overlayLocked ) {\n                        return;\n                    }\n                    if ( Math.abs( e.screenX - mouseX ) < 10 && Math.abs( e.screenY - mouseY ) < 10 ) {\n                        // ignore a small mouse movement\n                        return;\n                    }\n                } else {\n                    if ( ! overlayLocked ) {\n                        // An unlocked overlay must be the alt overlay.\n                        // When the alt overlay is showing from a hover use the first click in the inner to lock the alt overlay.\n                        overlayLocked = true;\n                        $altInner.addClass( 'bbg_xiv-locked' );\n                        return;\n                    }\n                }\n                // This is either a click event on a locked overlay or a large mouse move event on an unlocked alt overlay\n                var $inner = jQuery( this );\n                if ( $inner.hasClass( 'bbg_xiv-dense_outer' ) ) {\n                    // $inner really is outer so ...\n                    $inner = $altInner;\n                }   \n                overlayShowing = overlayLocked = false;\n                $altInner.removeClass( 'bbg_xiv-locked' );\n                mouseX = mouseY = NaN;\n                // fade out and hide overlay\n                $inner.css(\"opacity\",\"0.0\");\n                outer.css(\"opacity\",\"0.0\");\n                // workaround for a bug? in Chrome where navbar is not visible after an overlay is closed\n                var $navbar = jQuery( 'div.bbg_xiv-gallery nav.bbg_xiv-gallery_navbar' ).css( 'opacity', '0.99' );\n                window.setTimeout(function(){\n                    $inner.hide();\n                    outer.hide();\n                    $navbar.css( 'opacity', '1.0' );\n                }, $inner !== $altInner ? 2000 : 500 );\n                // $caption.css( { display: 'block', opacity: '0.7' } );\n            }   // function hideOverlay( e ) {\n            inner.add( $altInner ).click( hideOverlay );\n            outer.add( $altInner ).mousemove( hideOverlay );\n            // when overlay is showing from hover use a click in the outer to lock the overlay\n            outer.click( function( e ) {\n                if ( !overlayLocked ) {\n                    // The overlay must be the alt overlay.\n                    overlayLocked = true;\n                    $altInner.addClass( 'bbg_xiv-locked' );\n                } else {\n                    hideOverlay.call( this, e );\n                }\n            } );\n            var fullImg     = inner.find( 'img' );\n            var fullTitle   = inner.find( 'h1.bbg_xiv-dense_title' );\n            var fullCaption = inner.find( 'h1.bbg_xiv-dense_caption' );\n            if( typeof bbg_xiv.titleColor === 'undefined' ) {\n                // save the initial values of title color and shadow as these will be changed\n                bbg_xiv.titleColor  = fullTitle.css( 'color' );\n                bbg_xiv.titleShadow = fullTitle.css( 'text-shadow' );\n            }\n            if ( bbg_xiv.guiInterface === 'mouse' ) {\n                // only show title on mouseover\n                fullImg.hover(\n                    function() {\n                        fullTitle.css({   color: bbg_xiv.titleColor, textShadow: bbg_xiv.titleShadow});\n                        fullCaption.css({ color: bbg_xiv.titleColor, textShadow: bbg_xiv.titleShadow});\n                    },\n                    function() {\n                        fullTitle.css({   color: 'transparent', textShadow: 'none' });\n                        fullCaption.css({ color: 'transparent', textShadow: 'none' });\n                    }\n                );\n            }\n            var altOverlayView      = new bbg_xiv.ImageView();\n            altOverlayView.template = _.template( jQuery( 'script#bbg_xiv-template_justified_alt_overlay' ).html(), null, bbg_xiv.templateOptions );\n            function showOverlay( e ) {\n                var $button;\n                if ( this.tagName === 'A' ) {\n                    // click from carousel info button\n                    $button = jQuery( this );\n                } else if ( this.tagName === 'SPAN' ) {\n                    $button = jQuery( this.parentNode );\n                } else {\n                    $button = jQuery( this );\n                }\n                if ( parseFloat( $button.closest( 'div.caption' ).css( 'opacity' ) ) < 0.1 ) {\n                    // click was on an invisible button so ignore it\n                    return;\n                }\n                overlayShowing = true;\n                overlayLocked  = e.type === 'click';\n                mouseX         = e.screenX;\n                mouseY         = e.screenY;\n                $caption       = $button.parent( 'div.caption' );\n                var alt        = $button.hasClass( 'bbg_xiv-carousel_info' ) || $button.hasClass( 'bbg_xiv-dense_alt_btn' );   // use the alternate overlay view\n                if ( alt && overlayLocked ) {\n                    $altInner.addClass( 'bbg_xiv-locked' );\n                }\n                var img;\n                // the buttons are of four different types so the associated image is found differently depending on the type\n                if ( $button.hasClass( 'bbg_xiv-carousel_info' ) ) {\n                    // click from carousel info button\n                    img = $button.closest( 'div.carousel' ).find( 'div.carousel-inner figure.item.active img' )[0];\n                } else if ( $button.hasClass( 'bbg_xiv-dense_from_image' ) ) {\n                    img = $button.parents( 'div.bbg_xiv-dense_flex_item' ).find( 'img' )[0];\n                } else if ( $button.hasClass( 'bbg_xiv-dense_from_title' ) ) {\n                    img = jQuery( 'div#' + this.parentNode.id.replace( 'title', 'image' ) ).find( 'img' )[0];\n                } else if ( $button.hasClass( 'bbg_xiv-flex_from_image' ) ) {\n                    img = $button.parents( 'div.bbg_xiv-flex_item' ).find( 'img' )[0];\n                } else if ( $button.hasClass( 'bbg_xiv-dense_from_justified') ) {\n                    img = $button.parents( 'div.bbg_xiv-justified_item' ).find( 'img' )[0];\n                }\n                var data;\n                try {\n                    var galleryId=jQuery(img).parents(\"div[data-bbg_xiv-gallery-id]\")[0].dataset.bbg_xivGalleryId;\n                    data = bbg_xiv.images[ galleryId ].get( img.dataset.bbg_xivImageId ).attributes;\n                    if ( ! alt ) {\n                        fullImg[0].src=bbg_xiv.getSrc(data,\"viewport\",false);\n                        if(data.bbg_srcset){\n                            fullImg[0].srcset=bbg_xiv.getSrcset(data);\n                        }else{\n                            fullImg[0].removeAttribute(\"sizes\");\n                        }\n                        fullTitle[0].textContent=bbg_xiv.getTitle(data);\n                        fullCaption[0].textContent=bbg_xiv.getCaption(data);\n                    } else {\n                        // instantiate the alternate overlay\n                        altOverlayView.model = { attributes: data };\n                        $altInner.find( 'div.bbg_xiv-dense_alt_items' ).html( altOverlayView.render( true ) );\n                        $altInner.find( 'span.bbg_xiv-item_value a' ).click( function( e ) {\n                            // click on a elements should be ignored if the overlay is not locked, propagation will then lock the overlay as expected\n                            if ( ! jQuery( this ).parents( 'div.bbg_xiv-dense_alt_inner' ).hasClass( 'bbg_xiv-locked' ) ) {\n                                e.preventDefault();\n                            }\n                        } );\n                    }\n                } catch ( error ) {\n                    console.log('##### broken 1');\n                    if ( ! alt ) {\n                        fullImg[0].src = img.src;\n                    }\n                }\n                // show and fade in overlay\n                outer.show();\n                if ( ! alt ) {\n                    // show full image overlay\n                    $altInner.hide();\n                    inner.show();\n                } else {\n                    // show alternate overlay\n                    inner.hide();\n                    $altInner.show();\n                }\n                if ( bbg_xiv.guiInterface === 'touch' ) {\n                    // force hover effects on touchscreen\n                    fullTitle.css({   color: bbg_xiv.titleColor, textShadow: bbg_xiv.titleShadow});\n                    fullCaption.css({ color: bbg_xiv.titleColor, textShadow: bbg_xiv.titleShadow});\n                }\n                window.setTimeout(function(){\n                    ( ! alt ? inner : $altInner ).css( 'opacity', '1.0' );\n                    outer.css(\"opacity\",\"0.93\");\n                },100);\n                $caption.css( { display: 'block', opacity: '0.7' } );\n                e.preventDefault();\n                e.stopPropagation();\n            }  // function showOverlay( e ) {\n            jqGallery.find( 'a.bbg_xiv-carousel_info' ).click( function( e ) {\n                pause( this );\n                // show alt overlay\n                showOverlay.call( this, e );\n            } );\n            jqGallery.find( 'button.bbg_xiv-dense_full_btn, button.bbg_xiv-dense_alt_btn' ).click( showOverlay );\n            jqGallery.find( 'button.bbg_xiv-dense_alt_btn span.glyphicon' ).mouseenter( showOverlay );\n        }   // function constructOverlay() {\n        var titlesButton=jqGallery.parents(\"div.bbg_xiv-gallery\").find(\"nav.navbar button.bbg_xiv-titles\").hide();\n        switch(view){\n        case \"Gallery\":\n            if(flags.indexOf(\"tiles\")!==-1){\n                bbg_xiv.renderTiles(jqGallery,images,flags);\n                constructOverlay();\n                titlesButton.show();\n            } else if ( Modernizr.flexbox && Modernizr.flexwrap && ! window.bbg_xiv.bbg_xiv_disable_flexbox ) {\n                bbg_xiv.renderFlex(jqGallery,images);\n                constructOverlay();\n            }else{\n                bbg_xiv.renderBootstrapGallery(jqGallery,images);\n            }\n            window.setTimeout(function(){\n                jQuery(window).resize();\n            },100);\n            break;\n        case \"Justified\":\n            bbg_xiv.renderJustified(jqGallery,images);\n            constructOverlay();\n            titlesButton.show();\n            break;\n        case \"Carousel\":\n            if(flags.indexOf(\"embedded-carousel\")!==-1){\n                jqGallery.addClass(\"bbg_xiv-embedded_carousel\");\n            }else{\n                jQuery(\"html\").css(\"overflow-y\",\"hidden\");\n            }\n            var carouselId=\"bbg_xiv-carousel_\"+gallery.id;\n            bbg_xiv.renderCarousel(jqGallery,images,carouselId);\n            constructOverlay();\n            // pause() can be called from a button's event handler to pause the carousel, the argument is the button\n            function pause( button ) {\n                var $carousel = jQuery( button ).parents( 'div.carousel' );\n                $carousel.carousel( 'pause' );\n                $carousel.find( 'a.bbg_xiv-carousel_play span.glyphicon' ).removeClass( 'glyphicon-pause' ).addClass( 'glyphicon-play' ).parent().attr( 'title', bbg_xiv_lang['Play'] );\n            }\n            // Wireup the handlers - this must be done here as the elements in the carousel view are dynamically created\n            // Carousel pause handler\n            jqGallery.find( 'a.bbg_xiv-carousel_play' ).click( function( e ) {\n                var $this     = jQuery( this );\n                var $carousel = $this.parents( 'div.carousel' );\n                var $span     = $this.find( 'span.glyphicon' );\n                if ( $span.hasClass( 'glyphicon-pause' ) ) {\n                    pause( this );\n                } else {\n                    $span.removeClass( 'glyphicon-play' ).addClass( 'glyphicon-pause' ).parent().attr( 'title', bbg_xiv_lang['Pause'] );\n                    $carousel.carousel( 'next' );\n                    $carousel.carousel( 'cycle' );\n                }\n                e.preventDefault();      \n            });\n            jqGallery.find( 'a.bbg_xiv-carousel_left, a.bbg_xiv-carousel_right' ).click(function() {\n                pause(this);\n            });\n            // Carousel rewind handler\n            jqGallery.find(\"a.bbg_xiv-carousel_first span.glyphicon,a.bbg_xiv-carousel_last span.glyphicon\").click(function(e){\n                pause( this );\n                var carousel=jQuery(this).parents(\"div.carousel\");\n                if(jQuery(this.parentNode).hasClass(\"bbg_xiv-carousel_first\")){\n                    carousel.carousel(0);\n                }else{\n                    carousel.carousel(images.length-1);\n                }\n                e.preventDefault();      \n            });\n            jqGallery.find( 'a.bbg_xiv-carousel_help span.glyphicon' ).click( function( e ) {\n                window.open( bbg_xiv.docUrl + '#view-carousel', '_blank' );\n                e.preventDefault();      \n            } );\n            jqGallery.find(\"a.bbg_xiv-carousel_close\").click(function(e){\n                // restore \"Gallery View\"\n                jqGallery.removeClass(\"bbg_xiv-embedded_carousel\");\n                bbg_xiv.resetGallery(jQuery(this).parents(\"div.bbg_xiv-gallery\"),\"Carousel\");\n                jQuery( 'html' ).css( 'overflow-y', '' );\n                e.preventDefault();      \n            });\n            var input=jqGallery.find(\"div.bbg_xiv-jquery_mobile input[type='range']\");\n            input.slider();\n            var prevChangeTime;\n            var slideChange=false;   // change event triggered by a carousel slid event\n            // update Bootstrap carousel slide when jQuery mobile slider changes\n            // jQuery Mobile should change the \"type\" from \"range\" to \"number\" but does not so force it.\n            // TODO: Find out why jQuery Mobile is not doing this here - maybe I am doing something wrong.\n            input.attr( 'type', 'number' ).val( '1' ).change(function() {\n                if(slideChange){\n                    // ignore change events triggered by a carousel slid event\n                    return;\n                }\n                prevChangeTime=Date.now();\n                var carousel=jQuery(this).parents(\"div.carousel\");\n                pause(input);\n                // Since change events will occur much too rapidly wait until they quiesce\n                window.setTimeout(function(){\n                    if(Date.now()-prevChangeTime>=500){\n                        var i=input.val();\n                        if(jQuery.isNumeric(i)){\n                            i = parseInt( i, 10 ) - 1;\n                            if(i>=0&&i<images.length){\n                                carousel.carousel(i);\n                                pause(input);\n                            }\n                        }\n                    }\n                },500);\n            }).keypress(function(e){\n                if(e.which===13){\n                    jQuery(this).blur();\n                    e.preventDefault();\n                }\n            }).focus(function() {\n                pause(this);\n            }).on( 'slidestart', function() {\n                pause(this);\n            });\n            // update jQuery Mobile slider when Bootstrap carousel changes slide\n            jqGallery.find(\"div.carousel\").on(\"slide.bs.carousel slid.bs.carousel\",function(e){\n                slideChange=true;\n                // update input element and trigger change event to force update of slider position\n                jQuery( this ).find( 'div.bbg_xiv-jquery_mobile input[type=\"number\"]' ).val( parseInt( e.relatedTarget.dataset.index, 10 ) + 1 ).change();\n                slideChange=false;\n            });\n            if ( flags.indexOf( 'embedded-carousel' ) !== -1 ) {\n                window.setTimeout( function() {\n                    // the timeout is necessary to give browser time to render the image before the scrolling is done\n                    var $gallery     = jqGallery.closest( 'div.bbg_xiv-gallery' );\n                    var $divCarousel = jqGallery.find( 'div.carousel' );\n                    if ( $gallery.hasClass( 'bbg_xiv-fullscreen_gallery' ) ) {\n                        // full screen\n                        if ( window.matchMedia( '(max-aspect-ratio:1/1)' ).matches ) {\n                            // portrait mode\n                        } else {\n                            // landscape mode\n                            $gallery.scrollTop( $gallery[0].scrollHeight - $gallery.height() - 50 + 0.05 * $divCarousel.height() );\n                        }\n                    } else {\n                        // not full screen\n                        if(window.matchMedia(\"(max-aspect-ratio:1/1)\").matches){\n                            // portrait mode\n                            jQuery(window).scrollTop( $divCarousel.offset().top - jQuery(window).height()/6 );\n                        }else{\n                            // landscape mode\n                            // If WordPress admin bar is showing on frontend page adjust for it.\n                            var $body            = jQuery( 'body' );\n                            var $adminBar        = jQuery( 'div#wpadminbar' );\n                            var adminBarHeight   = $body.hasClass( 'admin-bar' ) && $adminBar.css( 'position' ) == 'fixed' ? $adminBar.outerHeight() : 0;\n                            var bodyBeforeHeight = 0;\n                            if ( $body.hasClass( 'bbg_xiv-twentysixteen_with_border' ) ) {\n                                // Adjust for the black border in the WordPress TwentySixteen theme.\n                                var bodyBeforeStyle = window.getComputedStyle( $body[0], ':before' );\n                                bodyBeforeHeight    = bodyBeforeStyle && bodyBeforeStyle.position === 'fixed' ? parseInt( bodyBeforeStyle.height, 10 ) : 0;\n                            }\n                            jQuery( window ).scrollTop( $divCarousel.offset().top - $divCarousel.outerHeight() / 18 - adminBarHeight - bodyBeforeHeight );\n                        }\n                    }\n                }, 500 );\n            }\n            jQuery(\"#\"+carouselId).carousel({interval:bbg_xiv.bbg_xiv_carousel_interval,pause:false});\n            break;\n        case \"Tabs\":\n            bbg_xiv.renderTabs(jqGallery,images,\"bbg_xiv-tabs_\"+gallery.id);\n            bbg_xiv.prettifyTabs(jqGallery,true);\n            jqGallery.find( 'nav.navbar ul.nav li a' ).click(function() {\n                if(!Modernizr.objectfit){\n                    // Microsoft Edge does not support CSS object-fit so do the object fit with JavaScript code\n                    jQuery(this.href.substr(this.href.lastIndexOf(\"#\"))+\" img\").each(function(){\n                        var img=this;\n                        var i=0;\n                        var j=0;\n                        var r0;\n                        window.setTimeout(function f(){\n                            var w=img.naturalWidth;\n                            var h=img.naturalHeight;\n                            var parent=jQuery(img.parentNode.parentNode.parentNode);\n                            var W=parent.width();\n                            var H=0.7*jQuery(window).height();\n                            if(!w||!h||!W||!H||W<64||H<64){\n                                if(i++<16){\n                                    window.setTimeout(f,250);\n                                }\n                                return;\n                            }\n                            var r=Math.max(w/W,h/H);\n                            if(r<0.125||r>8){\n                                return;\n                            }\n                            if(typeof r0!=='undefined'&&r===r0){\n                                return;\n                            }\n                            w=Math.floor(w/r);\n                            h=Math.floor(h/r);\n                            jQuery(img).css({width:w+\"px\",height:h+\"px\"});\n                            r0=r;\n                            if(j++<16){\n                                window.setTimeout(f,250);\n                            }\n                        },250);\n                    });\n                }\n                window.setTimeout(function() {\n                    // the timeout is necessary to give browser time to render the image before the scrolling is done\n                    var $window    = jQuery( window );\n                    var $gallery   = jqGallery.closest( 'div.bbg_xiv-gallery' );\n                    var fullscreen = $gallery.hasClass( 'bbg_xiv-fullscreen_gallery' );\n                    var $content   = jqGallery.find( 'div.tab-content' );\n                    if( window.matchMedia( '(max-aspect-ratio:1/1)' ).matches ) {\n                        // portrait mode\n                        if ( fullscreen ) {\n                            $gallery.scrollTop( $gallery.scrollTop() + $content.position().top  - $window.height() / 3 - 20 );\n                        } else {\n                            $window.scrollTop( $content.offset().top - $window.height() / 3 - 20 );\n                        }\n                    } else {\n                        // landscape mode\n                        if ( fullscreen ) {\n                            $gallery.scrollTop( $gallery.scrollTop() + $content.position().top - 90 );\n                        } else {\n                            var $body            = jQuery( 'body' );\n                            var $adminBar        = jQuery( 'div#wpadminbar' );\n                            // If WordPress admin bar is showing on frontend page adjust for it.\n                            var adminBarHeight   = $body.hasClass( 'admin-bar' ) && $adminBar.css( 'position' ) == 'fixed' ? $adminBar.outerHeight() : 0;\n                            var bodyBeforeHeight = 0;\n                            if ( $body.hasClass( 'bbg_xiv-twentysixteen_with_border' ) ) {\n                                // Adjust for the black border in the WordPress TwentySixteen theme.\n                                var bodyBeforeStyle = window.getComputedStyle( $body[0], ':before' );\n                                bodyBeforeHeight    = bodyBeforeStyle && bodyBeforeStyle.position === 'fixed' ? parseInt( bodyBeforeStyle.height, 10 ) : 0;\n                            }\n                            var offset              = $window.height() >= 480 ? 80 : 40;\n                            $window.scrollTop( $content.offset().top - offset - adminBarHeight - bodyBeforeHeight );\n                        }\n                    }\n                }, 500 );\n            });\n            // intercept clicks when images belong to gallery of galleries\n            if(jqGallery.hasClass(\"bbg_xiv-gallery_icons_mode\")){\n                jqGallery.find(\"div.bbg_xiv-template_tabs_container div.tab-content figure.tab-pane a\").click(function(e){\n                    var galleries=jqGallery.parent().find(\"nav.bbg_xiv-gallery_navbar ul.nav li.dropdown ul.bbg_xiv-view_menu li.bbg_xiv-alt_gallery\");\n                    // only intercept clicks on the home gallery\n                    if(galleries.filter(\".bbg_xiv-alt_gallery_home\").hasClass(\"active\")){\n                        galleries.find(\"a[data-view='gallery_\"+this.dataset.galleryIndex+\"']\").click();\n                        e.preventDefault();\n                    }\n                });\n            }\n            // make the \"Tabs\" brand clickable for mobile devices and send click to the toggle button\n            jqGallery.find(\"a.bbg_xiv-tabs_brand\").click(function(e){\n                var toggle=jQuery(this).siblings(\"button.navbar-toggle\");\n                if(toggle.css(\"display\")!==\"none\"){\n                    toggle.click();\n                }\n                e.preventDefault();\n            });\n            if ( bbg_xiv.guiInterface === 'touch' ) {\n                // For mobile devices if a scrollbar is needed then initially expand the tab navbar as the collapsed tab navbar is not user friendly on mobile devices\n                jQuery( 'div.bbg_xiv-gallery nav.bbg_xiv-gallery_navbar' ).find( 'span.glyphicon-collapse-down' ).each(function(){\n                    var jqThis=jQuery(this);\n                    if(jqThis.css(\"display\")!==\"none\"){\n                        jqThis.click();\n                    }\n                });\n            }\n            break;\n        case \"Dense\":\n            jQuery(\"html\").css(\"overflow-y\",\"hidden\");\n            bbg_xiv.renderDense(jqGallery,images,\"bbg_xiv-dense_\"+gallery.id,\"title\");\n            jqGallery.find(\"div.bbg_xiv-dense_images div.bbg_xiv-dense_flex_images div.bbg_xiv-dense_flex_item\")\n                .css(\"width\",100/bbg_xiv.bbg_xiv_flex_number_of_dense_view_columns+\"%\");\n            var normal=jQuery(\"div.bbg_xiv-dense_container button#bbg_xiv-normal_color\").css(\"background-color\");\n            var highlight=jQuery(\"div.bbg_xiv-dense_container button#bbg_xiv-highlight_color\").css(\"background-color\");\n            jqGallery.find(\"div.bbg_xiv-dense_titles ul li\").hover(\n                function() {\n                    // highlight matching image\n                    jQuery(this).css({\"background-color\":highlight});\n                    var img=jQuery(\"div#\"+this.id.replace(\"title\",\"image\")).css({\"border-color\":highlight});\n                    // scroll images view if matching image is hidden\n                    var top=img.position().top;\n                    var height=img.height();\n                    var bottom=top+height;\n                    var div = img.parents( 'div.bbg_xiv-dense_images' );\n                    var scrollTop=div.scrollTop();\n                    var scrollHeight=div.height();\n                    if(top<0){\n                        div.scrollTop(scrollTop+top-scrollHeight/2-height/2);\n                    }else if(bottom>scrollHeight){\n                        div.scrollTop(scrollTop+(bottom-scrollHeight)+scrollHeight/2-height/2);\n                    }\n                },\n                function() {\n                    jQuery(this).css({\"background-color\":normal});\n                    jQuery(\"div#\"+this.id.replace(\"title\",\"image\")).css({\"border-color\":normal});\n                }\n            );\n            jqGallery.find(\"div.bbg_xiv-dense_flex_item\").hover(\n                function() {\n                    jQuery(this).css({\"border-color\":highlight});\n                    // highlight matching title\n                    var li=jQuery(\"li#\"+this.id.replace(\"image\",\"title\")).css({\"background-color\":highlight});\n                    // scroll titles view if matching title is hidden\n                    var top=li.position().top;\n                    var height=li.height();\n                    var bottom=top+height;\n                    var div = li.parents( 'div.bbg_xiv-dense_titles' );\n                    var scrollTop=div.scrollTop();\n                    var scrollHeight=div.height();\n                    if(top<0){\n                        div.scrollTop(scrollTop+top-scrollHeight/2-height/2);\n                    }else if(bottom>scrollHeight){\n                        div.scrollTop(scrollTop+(bottom-scrollHeight)+scrollHeight/2-height/2);\n                    }\n                },\n                function() {\n                    jQuery(this).css({\"border-color\":normal});\n                    jQuery(\"li#\"+this.id.replace(\"image\",\"title\")).css({\"background-color\":normal});\n                }\n            );\n            jqGallery.find( 'input.bbg_xiv-dense_li_mode' ).change(function() {\n                // show titles or captions depending on the radio buttons \n                if(this.checked){\n                    var div=jQuery(\"div.bbg_xiv-dense_container div.bbg_xiv-dense_titles\");\n                    if(this.value===\"title\"){\n                        div.find(\"span.bbg_xiv-dense_li_caption\").hide();\n                        div.find(\"span.bbg_xiv-dense_li_title\").show();\n                        div.find(\"span.bbg_xiv-dense_li_alt\").hide();\n                    }else if(this.value===\"caption\"){\n                        div.find(\"span.bbg_xiv-dense_li_title\").hide();\n                        div.find(\"span.bbg_xiv-dense_li_caption\").show();\n                        div.find(\"span.bbg_xiv-dense_li_alt\").hide();\n                    }else if(this.value===\"alt\"){\n                        div.find(\"span.bbg_xiv-dense_li_title\").hide();\n                        div.find(\"span.bbg_xiv-dense_li_caption\").hide();\n                        div.find(\"span.bbg_xiv-dense_li_alt\").show();\n                    }\n                }\n            });\n            jqGallery.find( 'button.bbg_xiv-dense_info_btn' ).click( function( e ) {\n                window.open( bbg_xiv.docUrl + '#view-dense', '_blank' );\n                e.preventDefault();      \n            } );\n            jqGallery.find(\"button.bbg_xiv-dense_close_btn\").click(function(e){\n                // restore \"Gallery View\"\n                bbg_xiv.resetGallery(jQuery(this).parents(\"div.bbg_xiv-gallery\"));\n                jQuery( 'html' ).css( 'overflow-y', '' );\n                e.preventDefault();      \n            });\n            constructOverlay();\n            break;\n        // TODO: Add entry for new views here\n        case \"Table\":\n            bbg_xiv.renderTable(jqGallery,images);\n            break;\n        default:\n            break;\n        }\n        var menuItems=jQuery(gallery.parentNode).find(\"nav.bbg_xiv-gallery_navbar ul.nav ul.bbg_xiv-view_menu li\").show();\n        if ( bbg_xiv.guiInterface !== 'mouse' || jQuery( window ).width() < bbg_xiv.bbg_xiv_flex_min_width_for_dense_view ) {\n            // for touch and small screen devices hide the dense menu item\n            menuItems.filter( '.bbg_xiv-large_viewport_only' ).hide();\n        }\n        if(bbg_xiv.search[gallery.id]){\n            // displaying search results so hide gallery headings\n            jQuery(\"div#\"+gallery.id+\"-alt_gallery_heading\").hide();\n            // and show search results heading\n            jQuery(\"div#\"+gallery.id+\"-heading\").show();\n        }else if(bbg_xiv.galleries[gallery.id]){\n            // displaying a gallery so hide search results heading\n            jQuery(\"div#\"+gallery.id+\"-heading\").hide();\n            var galleryOfGalleries=typeof bbg_xiv.images[gallery.id].models[0].attributes.gallery_index!==\"undefined\";\n            var divAltGalleryHeading=jQuery(\"div#\"+gallery.id+\"-alt_gallery_heading\");\n            if(galleryOfGalleries){\n                // show heads up for gallery of galleries\n                divAltGalleryHeading.find(\"span.bbg_xiv-alt_gallery_heading\").text(bbg_xiv.galleryOfGalleriesTitle);\n                // click handler for gallery icon images\n                jqGallery.find(\"a.bbg_xiv-gallery_icon\").click(function(e){\n                    jqGallery.parent().find( 'nav.bbg_xiv-gallery_navbar ul.nav li.dropdown ul.bbg_xiv-view_menu li.bbg_xiv-alt_gallery > a[data-view=\"gallery_' +\n                        this.dataset.galleryIndex+'\"]').click();\n                    e.preventDefault();\n                });\n                // hide inappropriate menu items for gallery of galleries\n                menuItems.filter(\".bbg_xiv-hide_for_gallery_icons\").hide();\n            }\n            if(bbg_xiv.galleries[gallery.id].view!==\"gallery_home\"||galleryOfGalleries){\n                // and show title of alternate galleries or heads up for gallery of galleries; except hide title for home gallery; \n                divAltGalleryHeading.show();\n            }\n        }\n    };\n    \n    // tabs are used twice - to show a list of gallery titles and a list of image titles. prettifyTabs() implements the common functionality for both\n    bbg_xiv.prettifyTabs=function(jqGallery,initial){\n        // Adjust the tab view according to its environment\n        var navbar=jqGallery.find(\"nav.navbar\");\n        // In portrait mode show the tabs navbar uncollapsed\n        var toggle=navbar.find(\"button.navbar-toggle\");\n        if(toggle.css(\"display\")!==\"none\"){\n            toggle.click();\n        }\n        // Hide the expand glyph and scrollbar if not needed.\n        navbar.find(\"div.navbar-collapse ul.nav\").each(function(){\n            if(jQuery(this).height()-8<=jQuery(this.parentNode).height()){\n                jQuery(this).parents(\"nav.navbar\").find(\"span.glyphicon\").hide();\n                jQuery(this.parentNode).addClass(\"bbg_xiv-hide_scroll\");\n            }\n        });\n        if(initial){\n            // Wireup the handlers - this must be done here as the elements in the tab view are dynamically created\n            // Clicking the expand glpyh shows all the tabs.\n            jqGallery.find( 'span.glyphicon-collapse-down, span.glyphicon-collapse-up' ).click(function() {\n                var jqThis=jQuery(this);\n                var navbar=jQuery(this.parentNode).find(\"div.navbar-collapse\");\n                if(jqThis.hasClass(\"glyphicon-collapse-down\")){\n                    jqThis.removeClass(\"glyphicon-collapse-down\").addClass(\"glyphicon-collapse-up\");\n                    navbar.removeClass(\"bbg_xiv-closed\").addClass(\"bbg_xiv-open\");\n                }else{\n                    jqThis.removeClass(\"glyphicon-collapse-up\").addClass(\"glyphicon-collapse-down\");\n                    navbar.removeClass(\"bbg_xiv-open\").addClass(\"bbg_xiv-closed\");\n                }\n            });\n        }\n    };\n\n    bbg_xiv.resetGallery=function(gallery,currentView){\n        // restore \"Gallery View\"\n        var divGallery=gallery.find(\"div.bbg_xiv-gallery_envelope\")[0];\n        var galleryOfGalleries=typeof bbg_xiv.images[divGallery.id].models[0].attributes.gallery_index!==\"undefined\";\n        var defaultView=bbg_xiv.getDefaultView(jQuery(divGallery),galleryOfGalleries);\n        if(currentView===\"Carousel\"&&defaultView===\"Carousel\"){\n            defaultView=\"Gallery\";\n        }\n        bbg_xiv.renderGallery(divGallery,defaultView);\n        var liSelectView=gallery.find(\"nav.bbg_xiv-gallery_navbar ul.nav li.bbg_xiv-select_view\");\n        var liFirst=liSelectView.find(\"ul.bbg_xiv-view_menu li.bbg_xiv-view\").removeClass(\"active\").filter(\".bbg_xiv-view_\"+defaultView.toLowerCase()).addClass(\"active\");\n        liSelectView.find(\"a.bbg_xiv-selected_view span\").text(liFirst.text());\n        jQuery(window).resize();\n    };\n     \n    // getting attributes indirectly through functions will make it possible for one template to be used for both the REST mode and the old proprietary mode\n\n    // the fullSize parameter is the size of the non-iconic view of the image and should either \"viewport\" or \"container\"\n    // the icon parameter is a boolean indicating that the src is for a thumbnail\n\n    // getSrc() sets the src attribute of <img> HTML elements which will be ignored on modern browsers that support the srcset attribute\n    // i.e. the source selection logic of getSrc() will only be used on older browsers\n\n    bbg_xiv.getSrc=function(data,fullSize,icon){\n        switch(bbg_xiv.bandwidth){\n        case \"normal\":\n            return bbg_xiv.bbg_xiv_wp_rest_api?data.source_url:data.url;\n        case \"low\":\n            if(icon){\n                return data.bbg_thumbnail_src[0];\n            }else{\n                if(fullSize===\"viewport\"){\n                    return data.bbg_large_src[0];\n                }else{\n                    return data.bbg_medium_large_src[0];\n                }\n            }\n            break;\n        case \"very low\":\n            if(icon){\n                return data.bbg_thumbnail_src[0];\n            }else{\n                if(fullSize===\"viewport\"){\n                    return data.bbg_medium_large_src[0];\n                }else{\n                    return data.bbg_medium_src[0];\n                }\n            }\n        }\n    };\n\n    bbg_xiv.getSrcset=function(data){\n        if(bbg_xiv.bbg_xiv_bandwidth!=='auto'){\n            // really should removeAttribute but this should work\n            return \"\";\n        }\n        return data.bbg_srcset;\n    };\n\n    bbg_xiv.getTitle=function(data){\n        return (bbg_xiv.bbg_xiv_wp_rest_api?data.title.rendered:data.post_title).trim();\n    };\n\n    bbg_xiv.getCaption=function(data,noAlt){\n        var caption=bbg_xiv.bbg_xiv_wp_rest_api?jQuery(data.caption.rendered).text():data.post_excerpt;\n        if(!caption&&!noAlt){\n            caption=bbg_xiv.getAlt(data,true);\n        }\n        return caption.trim();\n    };\n\n    bbg_xiv.getAlt=function(data,noCaption){\n        var alt=bbg_xiv.bbg_xiv_wp_rest_api?data.alt_text:data.image_alt;\n        if(!alt&&!noCaption){\n            alt=bbg_xiv.getCaption(data,true);\n        }\n        return alt.trim();\n    };\n\n    bbg_xiv.getPostContent=function(data){\n        var postContent=bbg_xiv.bbg_xiv_wp_rest_api?data.bbg_post_content:data.post_content;\n        if(postContent){\n            return postContent;\n        }\n        return bbg_xiv.getCaption(data);\n    };\n    \n    bbg_xiv.getSizes=function(data,fullSize,icon){\n        if(bbg_xiv.bbg_xiv_bandwidth!=='auto'){\n            // really should removeAttribute but this should work\n            return \"\";\n        }\n        if(!data){\n            if(fullSize===\"viewport\"&&!icon){\n                return \"100vw\";\n            }\n            return \"50vw\";\n        }         \n        if(!data.bbg_srcset){\n            // really should removeAttribute but this should work\n            return \"\";\n        } else if ( icon ) {\n            return '10vw';\n        }else if(fullSize===\"viewport\"){\n            return \"90vw\";\n        }else if(fullSize===\"container\"){\n            return data.bbg_xiv_container_width+\"px\";\n        }else{\n            return \"50vw\";\n        }\n    };\n\n    try{\n        window.localStorage.setItem(\"test\",\"test\");\n        window.localStorage.removeItem(\"test\");\n        bbg_xiv.localStorageAvailable=true;\n    }catch(e){\n        bbg_xiv.localStorageAvailable=false;\n    }\n    \n    bbg_xiv.setCookie=function(name,value,expires){\n        if(bbg_xiv.localStorageAvailable){\n            localStorage.setItem(name,value);\n        }else{\n            var d=new Date();\n            d.setTime(d.getTime()+(expires*24*60*60*1000));\n            document.cookie=name+\"=\"+value+\"; expires=\"+d.toUTCString()+\"; path=/\";\n        }\n    };\n\n    bbg_xiv.getCookie=function(name){\n        if(bbg_xiv.localStorageAvailable){\n            return localStorage.getItem(name);\n        }else{\n            var cookie=document.cookie;\n            cookie += \";\";\n            var start=cookie.indexOf(name+\"=\");\n            if(start===-1){\n                return null;\n            }\n            start+=name.length+1;\n            var end=cookie.indexOf(\";\",start);\n            if(end===-1){\n                return null;\n            }\n            return cookie.substring(start,end);\n        }\n    };\n\n    bbg_xiv.calcBreakpoints=function(){\n        var minFlexWidth=window.bbg_xiv.bbg_xiv_flex_min_width;\n        bbg_xiv.breakpoints=[\n            {width:2*minFlexWidth,cssClass:\"100\"},\n            {width:3*minFlexWidth,cssClass:\"50\"},\n            {width:4*minFlexWidth,cssClass:\"33_3333\"},\n            {width:5*minFlexWidth,cssClass:\"25\"},\n            {width:6*minFlexWidth,cssClass:\"20\"},\n            {width:7*minFlexWidth,cssClass:\"16_6666\"},\n            {width:8*minFlexWidth,cssClass:\"14_2857\"},\n            {width:9*minFlexWidth,cssClass:\"12_5\"},\n            {width:10*minFlexWidth,cssClass:\"11_1111\"},\n            {width:11*minFlexWidth,cssClass:\"10\"},\n            {width:12*minFlexWidth,cssClass:\"9_0909\"},\n            { width: 1000000, cssClass: '8_3333' }\n        ];\n    };\n\n    bbg_xiv.getOptionsFromCookie=function(){\n        // override options with cookie values if they exists\n        var cookie=bbg_xiv.getCookie(\"bbg_xiv\");\n        if(cookie){\n            var options=JSON.parse(cookie);\n            var carousel_interval=options.bbg_xiv_carousel_interval;\n            if(jQuery.isNumeric(carousel_interval)&&carousel_interval>=1000){\n                bbg_xiv.bbg_xiv_carousel_interval=carousel_interval;\n            }\n            var flex_min_width=options.bbg_xiv_flex_min_width;\n            if(jQuery.isNumeric(flex_min_width)&&flex_min_width>=32&&flex_min_width<=1024){\n                bbg_xiv.bbg_xiv_flex_min_width=flex_min_width;\n            }\n            var miro_row_height = options.bbg_xiv_miro_row_height;\n            if ( jQuery.isNumeric( miro_row_height ) && miro_row_height >= 32 && miro_row_height <= 512 ) {\n                bbg_xiv.bbg_xiv_miro_row_height = miro_row_height;\n            }\n            var max_search_results=options.bbg_xiv_max_search_results;\n            if(jQuery.isNumeric(max_search_results)&&max_search_results>=1&&max_search_results<1048576){\n                bbg_xiv.bbg_xiv_max_search_results=max_search_results;\n            }\n            var flex_number_of_dense_view_columns=options.bbg_xiv_flex_number_of_dense_view_columns;\n            if(jQuery.isNumeric(flex_number_of_dense_view_columns)&&flex_number_of_dense_view_columns>=2&&flex_number_of_dense_view_columns<=32){\n                bbg_xiv.bbg_xiv_flex_number_of_dense_view_columns=flex_number_of_dense_view_columns;\n            }\n            if(typeof options.bbg_xiv_default_view===\"string\"){\n                bbg_xiv.bbg_xiv_default_view=options.bbg_xiv_default_view;\n                bbg_xiv.usingServerDefaultView=false;\n            }else{\n                bbg_xiv.usingServerDefaultView=true;\n            }\n            if(typeof options.bbg_xiv_bandwidth===\"string\"){\n                bbg_xiv.bbg_xiv_bandwidth=options.bbg_xiv_bandwidth;\n            }\n            if(typeof options.bbg_xiv_interface===\"string\"){\n                bbg_xiv.bbg_xiv_interface=options.bbg_xiv_interface;\n            }\n        }else{\n            bbg_xiv.usingServerDefaultView=true;\n            bbg_xiv.bbg_xiv_bandwidth=\"auto\";\n            bbg_xiv.bbg_xiv_interface=\"auto\";\n        }\n        var userAgent=navigator.userAgent;\n        if(userAgent.indexOf(\"Firefox\")!==-1){\n            bbg_xiv.browser=\"Firefox\";\n        }else{\n            bbg_xiv.browser=\"\";\n        }\n        // compute bandwidth if bandwidth is set to auto - currently since this is not done reliably the user should set the bandwidth option manually\n        if(bbg_xiv.bbg_xiv_bandwidth===\"auto\"){\n            if(Modernizr.lowbandwidth){\n                // this uses navigator.connection which is only supported by Android\n                bbg_xiv.bandwidth=\"very low\";\n            }else if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)){\n                // determining bandwidth by device type is not reliable!\n                bbg_xiv.bandwidth=\"very low\";\n            }else{\n                bbg_xiv.bandwidth=\"low\";\n            }\n        }else{\n            bbg_xiv.bandwidth=bbg_xiv.bbg_xiv_bandwidth;\n        }\n        // compute interface if interface is auto\n        if(bbg_xiv.bbg_xiv_interface===\"auto\"){\n            if(Modernizr.touchevents){\n                bbg_xiv.guiInterface = 'touch';\n            }else{\n                bbg_xiv.guiInterface = 'mouse';\n            }\n        }else{\n            bbg_xiv.guiInterface = bbg_xiv.bbg_xiv_interface;\n        }\n        if(bbg_xiv.bbg_xiv_wp_rest_api){\n            // WP REST API requires that per_page be between 1 and 100 inclusive\n            bbg_xiv.wpRestApiMaxPerPage=100;\n        }\n    };\n    \n    bbg_xiv.getOptionsFromCookie();\n    bbg_xiv.calcBreakpoints();\n    \n    jQuery(window).resize(function(){\n        var breakpoints=bbg_xiv.breakpoints;\n        jQuery(\"div.bbg_xiv-flex_container,div.bbg_xiv-gallery_container\").each(function(){\n            var jqThis=jQuery(this);\n            var width=jqThis.width();\n            var pxWidth;\n            var minFlexWidthForCaption=window.bbg_xiv.bbg_xiv_flex_min_width_for_caption;\n            if(jqThis.parents(\"div.bbg_xiv-gallery_envelope\").hasClass(\"bbg_xiv-tiles_container\")){\n                // set tile width and height in pixels so that tiles cover the div exactly and completely\n                pxWidth = Math.floor( width / Math.floor( width / window.bbg_xiv.bbg_xiv_flex_min_width ) ) - 1;\n                jqThis.find(\"div.bbg_xiv-flex_item\").css({width:pxWidth,height:pxWidth});\n                if(pxWidth<minFlexWidthForCaption){\n                    jqThis.find(\"div.bbg_xiv-flex_item figcaption\").hide();\n                }\n            }else{\n                // find the smallest percentage width that satisfies the minimum image width\n                breakpoints.forEach(function(breakpoint){\n                  jqThis.removeClass(\"bbg_xiv-flex_width_\"+breakpoint.cssClass);\n                });\n                for(var i=0;i<breakpoints.length;i++){\n                    if(width<breakpoints[i].width){\n                        var cssClass=breakpoints[i].cssClass;\n                        jqThis.addClass(\"bbg_xiv-flex_width_\"+cssClass);\n                        pxWidth = parseFloat( cssClass.replace( '_', '.' ) ) / 100.0 * width;\n                        if(pxWidth<minFlexWidthForCaption){\n                            jqThis.addClass(\"bbg_xiv-flex_no_caption\");\n                        }else{\n                            jqThis.removeClass(\"bbg_xiv-flex_no_caption\");\n                        }\n                        break;\n                    }\n                }\n            }\n        });\n        if ( bbg_xiv.guiInterface === 'mouse' && jQuery( window ).width() >= bbg_xiv.bbg_xiv_flex_min_width_for_dense_view ) {\n            jQuery(\".bbg_xiv-configure_inner .bbg_xiv-mouse_only_option\").show();\n        }else{\n            jQuery(\".bbg_xiv-configure_inner .bbg_xiv-mouse_only_option\").hide();\n        }  \n        jQuery(\"div.bbg_xiv-gallery_envelope\").each(function(){\n            var menuItems=jQuery(this.parentNode).find(\"nav.bbg_xiv-gallery_navbar ul.nav ul.bbg_xiv-view_menu li\").show();\n            if ( bbg_xiv.guiInterface !== 'mouse' || jQuery( window ).width() < bbg_xiv.bbg_xiv_flex_min_width_for_dense_view ) {\n                // for touch and small screen devices hide the dense menu item\n                menuItems.filter(\".bbg_xiv-large_viewport_only\").hide();\n            }\n            if(typeof bbg_xiv.images[this.id].models[0].attributes.gallery_index!==\"undefined\"){\n                // for a gallery of gallery icons hide the carousel and the dense menu items\n                menuItems.filter(\".bbg_xiv-hide_for_gallery_icons\").hide();\n            }\n        });\n    });\n\n    bbg_xiv.getDefaultView=function(gallery,galleryOfGalleries){\n        var defaultView;\n        if(galleryOfGalleries||(galleryOfGalleries===null&&gallery.hasClass(\"bbg_xiv-gallery_icons_mode\"))){\n            // for gallery of galleries always use the gallery view\n            defaultView = 'Gallery';\n        }else{\n            // use class to set default view if it exists otherwise use the global value\n            defaultView = bbg_xiv.bbg_xiv_default_view ? bbg_xiv.bbg_xiv_default_view : 'Gallery';\n            if(bbg_xiv.usingServerDefaultView){\n                if(gallery.hasClass(\"bbg_xiv-default_view_gallery\")){\n                    defaultView=\"Gallery\";\n                }else if(gallery.hasClass(\"bbg_xiv-default_view_justified\")){\n                    defaultView=\"Justified\";\n                }else if(gallery.hasClass(\"bbg_xiv-default_view_carousel\")){\n                    defaultView=\"Carousel\";\n                }else if(gallery.hasClass(\"bbg_xiv-default_view_tabs\")){\n                    defaultView=\"Tabs\";\n                }\n            }\n            gallery.parents(\"div.bbg_xiv-bootstrap.bbg_xiv-gallery\").find(\"nav.bbg_xiv-gallery_navbar ul.nav li.bbg_xiv-select_view ul.bbg_xiv-view_menu li.bbg_xiv-view\")\n                .removeClass(\"active\").filter(\".bbg_xiv-view_\"+defaultView.toLowerCase()).addClass(\"active\");\n        }\n        return defaultView;\n    };\n    \n    jQuery(document).ready(function(){\n        jQuery(\"div.bbg_xiv-gallery_envelope\").each(function(){\n            var gallery=this;\n            var defaultView=bbg_xiv.getDefaultView(jQuery(gallery),null);\n            // prettify Galleries tabs\n            bbg_xiv.prettifyTabs(jQuery(gallery.parentNode).find(\"div.bbg_xiv-container\"),true);\n            if(bbg_xiv.bbg_xiv_wp_rest_api){\n                // If the schema is not in sessionStorage it will be loaded asynchronously so must use wp.api.loadPromise.done()\n                wp.api.loadPromise.done(function(){\n                    var images=bbg_xiv.images[gallery.id]=new wp.api.collections.Media();\n                    images.reset(JSON.parse(bbg_xiv[gallery.id+\"-data\"]));\n                    bbg_xiv.renderGallery(gallery,defaultView,[\"initial\"]);\n                    jQuery( gallery ).closest( 'div.bbg_xiv-gallery' ).addClass( 'bbg_xiv-home_gallery' );\n                    jQuery(window).resize();\n                });\n            }else{\n                bbg_xiv.renderGallery(gallery,defaultView,[\"initial\"]);\n                jQuery( gallery ).closest( 'div.bbg_xiv-gallery' ).addClass( 'bbg_xiv-home_gallery' );\n            }\n        });\n\n        // wireup the event handlers\n        // wireup the handler for view selection\n        jQuery(\"nav.bbg_xiv-gallery_navbar ul.nav li.dropdown ul.bbg_xiv-view_menu li > a\").click(function(e){\n            var view=this.dataset.view;\n            var jqThis=jQuery(this);\n            var li=jqThis.parent();\n            var select=li.parent();\n            var liSelectView=li.parents(\"li.bbg_xiv-select_view\");\n            var container=jqThis.parents(\"div.bbg_xiv-bootstrap.bbg_xiv-gallery\");\n            var divGallery=container.find(\"div.bbg_xiv-gallery_envelope\")[0];\n            function handleResponse( r ) {\n                if(jqueryLoading){\n                    jQuery.mobile.loading(\"hide\");\n                    jQuery(divGallery).children().detach();\n                }\n                if(r){\n                    galleries.images[view]=bbg_xiv.constructImages(divGallery);\n                    galleries.view=view;\n                    container.find(\"div#\"+divGallery.id+\"-alt_gallery_heading span.bbg_xiv-alt_gallery_heading\").text(title);\n                    bbg_xiv.renderGallery(divGallery,defaultView);\n                }else{\n                    jQuery(divGallery).empty().append('<h1 class=\"bbg_xiv-warning\">'+bbg_xiv_lang[\"Nothing Found\"]+'</h1>');\n                }\n                jQuery(divGallery.parentNode).find(\"nav.navbar form.bbg_xiv-search_form button\").prop(\"disabled\",false);\n            }\n            if([\"Gallery\",\"Carousel\",\"Justified\",\"Tabs\",\"Dense\"].indexOf(view)>=0){\n                // view selected\n                select.find(\"li.bbg_xiv-view\").removeClass(\"active\");\n                li.addClass(\"active\");\n                liSelectView.find(\"a.bbg_xiv-selected_view span\").text(this.textContent);\n                bbg_xiv.renderGallery(divGallery,view);\n            }else{\n                // gallery selected\n                // delete search state if it exists\n                if(bbg_xiv.search[divGallery.id]){\n                    delete bbg_xiv.search[divGallery.id];\n                }\n                container.find(\"div#\"+divGallery.id+\"-alt_gallery_heading\").hide();\n                var title=this.textContent;\n                var galleries=bbg_xiv.galleries[divGallery.id];\n                var galleryOfGalleries=(view!==\"gallery_home\")?false:null;\n                var defaultView=bbg_xiv.getDefaultView(jQuery(divGallery),galleryOfGalleries);\n                select.find(\"li.bbg_xiv-view\").removeClass(\"active\");\n                var liGallery=select.find(\"li.bbg_xiv-view_\"+defaultView.toLowerCase()).addClass(\"active\");\n                liSelectView.find(\"a.bbg_xiv-selected_view span\").text(liGallery.text());\n                select.find(\"li.bbg_xiv-alt_gallery\").removeClass(\"active\");\n                li.addClass(\"active\");\n                if(galleries.images[view]){\n                    // images were previously loaded so just restore  the collection\n                    bbg_xiv.images[divGallery.id]=galleries.images[view];\n                    galleries.view=view;\n                    if(view!==\"gallery_home\"){\n                        container.find(\"div#\"+divGallery.id+\"-alt_gallery_heading span.bbg_xiv-alt_gallery_heading\").text(title);\n                    }\n                    bbg_xiv.renderGallery(divGallery,defaultView);\n                    // update active in gallery tabs\n                    container.find(\"div.bbg_xiv-gallery_tabs_container nav.navbar ul.nav-tabs li\").removeClass(\"active\").find(\"a[data-view='\"+view+\"']\").parent().addClass(\"active\");\n                    if ( view !== 'gallery_home' ) {\n                        jqThis.closest( 'div.bbg_xiv-gallery' ).removeClass( 'bbg_xiv-home_gallery' );\n                    } else {\n                        jqThis.closest( 'div.bbg_xiv-gallery' ).addClass( 'bbg_xiv-home_gallery' );\n                    }\n                    e.preventDefault();\n                    return;\n                }\n                // setup headings\n                jQuery(\"div#\"+divGallery.id+\"-heading\").hide();\n                var jqueryLoading=true;\n                try {\n                    // There is a very rare failure of the following\n                    jQuery(divGallery).empty().append(jQuery.mobile.loading(\"show\",{text:\"Loading... please wait.\",textVisible:true,textonly:false}));\n                } catch ( error ) {\n                    console.log( error );\n                    //console.log(\"jQuery.mobile.loading._widget=\",jQuery.mobile.loading._widget);\n                    jQuery(divGallery).empty().append('<h1 class=\"bbg_xiv-info\">Loading... please wait.</h1>');\n                    jQuery.mobile.loading._widget=undefined;\n                    jqueryLoading=false;\n                }\n                var specifiers=this.dataset.specifiers;\n                // extract individual gallery parameters\n                if(bbg_xiv.bbg_xiv_wp_rest_api){\n                    // translation maps for gallery shortcode parameter names and values to WP REST API option names and values\n                    var nameMap={\n                        id:\"parent\",\n                        ids:\"include\",\n                        bb_tags:\"bb-tags\"\n                    };\n                    // really should have a value map per parameter name but fortunately there are no overlaps\n                    var valueMap={\n                        ASC:\"asc\",\n                        DESC:\"desc\"\n                    };\n                }\n                var matches=specifiers.match(/(\\w+)=\"([^\"]+)\"/g);\n                var parameters={};\n                var ids=false;\n                matches.forEach(function(match){\n                    var specifier=match.match(/(\\w+)=\"([^\"]+)\"/);\n                    if(bbg_xiv.bbg_xiv_wp_rest_api){\n                        // translate gallery shortcode parameters to WP REST API options\n                        parameters[nameMap[specifier[1]]?nameMap[specifier[1]]:specifier[1]]=valueMap[specifier[2]]?valueMap[specifier[2]]:specifier[2];\n                        if(specifier[1]===\"ids\"){\n                            ids=true;\n                        }\n                    }else{\n                        parameters[specifier[1]]=specifier[2];\n                    }\n                });\n                if ( bbg_xiv.bbg_xiv_wp_rest_api && ids && ! parameters.orderby ) {\n                    // for ids use the explicit order in ids\n                    parameters.orderby = 'include';\n                }\n                var form=jqThis.parents(\"div.navbar-collapse\").first().find(\"form[role='search']\");\n                if(bbg_xiv.bbg_xiv_wp_rest_api){\n                    // uses the WP REST API - requires the WP REST API plugin\n                    var images=bbg_xiv.images[divGallery.id]=new wp.api.collections.Media();\n                    images.once(\"sync\",function(){\n                        // the sync event will occur once only on the Backbone fetch of the collection\n                        handleResponse(!!this.length);\n                    },images);\n                    // get the collection specified by the parameters\n                    parameters.per_page=bbg_xiv.wpRestApiMaxPerPage;\n                    images.fetch({\n                        data:parameters,\n                        success: function() {\n                        },\n                        error: function( c, r ) {\n                            console.log(\"error:r=\",r);\n                            handleResponse(false);\n                        }\n                    });\n                }else{\n                    // old proprietary non REST way to load the Backbone image collection - does not require the WP REST API plugin\n                    var postData={\n                        action:\"bbg_xiv_search_media\",\n                        _wpnonce:form.find(\"input[name='_wpnonce']\").val(),\n                        _wp_http_referer:form.find(\"input[name='_wp_http_referer']\").val()\n                    };\n                    // add individual gallery parameters to post data\n                    for(var parameter in parameters){\n                        postData[parameter]=parameters[parameter];\n                    }\n                    jQuery.post(bbg_xiv.ajaxurl,postData,function(r){\n                        if(r===\"-1\"){\n                            r=\"\";\n                        }\n                        bbg_xiv.images[divGallery.id]=null;\n                        bbg_xiv[divGallery.id+\"-data\"]=r;\n                        handleResponse(!!r);\n                    });\n                }\n                // update active in gallery tabs\n                jqThis.parents(\"div.bbg_xiv-bootstrap.bbg_xiv-gallery\").find(\"div.bbg_xiv-gallery_tabs_container nav.navbar ul.nav-tabs li\").removeClass(\"active\")\n                    .find(\"a[data-view='\"+view+\"']\").parent().addClass(\"active\");\n                if ( view !== 'gallery_home' ) {\n                    jqThis.closest( 'div.bbg_xiv-gallery' ).removeClass( 'bbg_xiv-home_gallery' );\n                } else {\n                    jqThis.closest( 'div.bbg_xiv-gallery' ).addClass( 'bbg_xiv-home_gallery' );\n                }\n            }\n            e.preventDefault();\n        });\n        // wireup Galleries tabs \n        jQuery(\"div.bbg_xiv-gallery_tabs_container nav.navbar ul.nav-tabs li a[data-view^='gallery_']\").click(function(e){\n            jQuery(this).parents(\"div.bbg_xiv-bootstrap.bbg_xiv-gallery\")\n                .find(\"nav.bbg_xiv-gallery_navbar ul.nav li.dropdown ul.bbg_xiv-view_menu li > a[data-view='\"+this.dataset.view+\"']\").click();\n            e.preventDefault();\n        });\n        // wireup the handler for searching\n        jQuery(\"form.bbg_xiv-search_form input[type='text']\").keypress(function(e){\n            if(e.which===13){\n                // need to do this to hide virtual keyboard on mobile devices\n                jQuery(this).blur();\n            }\n        });\n        jQuery(\"form.bbg_xiv-search_form button\").each(function(){\n            var query;\n            var offset;\n            var page;\n            var count=Number.MAX_SAFE_INTEGER;\n            var pages=Number.MAX_SAFE_INTEGER;\n            jQuery(this).click(function(e){\n                var searchLimit = parseInt( bbg_xiv.bbg_xiv_max_search_results, 10 );\n                if(bbg_xiv.bbg_xiv_wp_rest_api&&searchLimit>bbg_xiv.wpRestApiMaxPerPage){\n                    searchLimit=bbg_xiv.wpRestApiMaxPerPage;\n                }\n                var searchBtn=jQuery(this);\n                searchBtn.prop(\"disabled\",true);\n                var startSearch=\"search images on site\";\n                var continueSearch=\"continue current search\";\n                var divGallery=searchBtn.parents(\"div.bbg_xiv-gallery\").find(\"div.bbg_xiv-gallery_envelope\")[0];\n                var form=searchBtn.parents(\"form[role='search']\");\n                var input=form.find(\"input[type='text']\");\n                var value=input.val();\n                var postData;\n                if(value){\n                    // new search\n                    query=value;\n                    offset=0;\n                    page=1;\n                    // start new search history\n                    bbg_xiv.search[divGallery.id]={history:[],index:-1,done:false};\n                    // get count\n                    if(!window.bbg_xiv.bbg_xiv_wp_rest_api){\n                        postData = {\n                            action:\"bbg_xiv_search_media_count\",\n                            query:query,\n                            _wpnonce:form.find(\"input[name='_wpnonce']\").val(),\n                            _wp_http_referer:form.find(\"input[name='_wp_http_referer']\").val()\n                        };\n                        jQuery.post(bbg_xiv.ajaxurl,postData,function(r){\n                            count = parseInt( r, 10 );\n                        });\n                    }\n                }else if(typeof query===\"undefined\"){\n                    e.preventDefault();\n                    return;\n                }\n                // setup headings\n                jQuery(\"div#\"+divGallery.id+\"-alt_gallery_heading\").hide();\n                var jqueryLoading=true;\n                try {\n                    // There is a very rare failure of the following\n                    jQuery(divGallery).empty().append(jQuery.mobile.loading(\"show\",{text:\"Loading... please wait.\",textVisible:true,textonly:false}));\n                } catch ( error) {\n                    console.log( error );\n                    //console.log(\"jQuery.mobile.loading._widget=\",jQuery.mobile.loading._widget);\n                    jQuery(divGallery).empty().append('<h1 class=\"bbg_xiv-info\">Loading... please wait.</h1>');\n                    jQuery.mobile.loading._widget=undefined;\n                    jqueryLoading=false;\n                }\n                jQuery(divGallery).parent().find(\"div.bbg_xiv-search_header\").hide();\n                function handleResponse(r){\n                    if(jqueryLoading){\n                        jQuery.mobile.loading(\"hide\");\n                        jQuery(divGallery).children().detach();\n                    }\n                    if(r){\n                        var images=bbg_xiv.constructImages(divGallery);\n                        var prevOffset=offset;\n                        var prevQuery=query;\n                        var heading=jQuery(\"div#\"+divGallery.id+\"-heading\");\n                        var search=bbg_xiv.search[divGallery.id];\n                        if((window.bbg_xiv.bbg_xiv_wp_rest_api&&page<=pages)||(!window.bbg_xiv.bbg_xiv_wp_rest_api&&offset+images.models.length<count)){\n                            // this search has more images\n                            offset+=searchLimit;\n                            input.val(\"\").attr(\"placeholder\",continueSearch);\n                            heading.find(\"button.bbg_xiv-search_scroll_right\").attr(\"disabled\",false);\n                        }else{\n                            // all search results have been returned\n                            search.done=true;\n                            input.attr(\"placeholder\",startSearch).val(query);\n                            query=undefined;\n                            offset=undefined;\n                            heading.find(\"button.bbg_xiv-search_scroll_right\").attr(\"disabled\",true);\n                        }\n                        // search results uses a heading to show status\n                        heading.find(\"span.bbg_xiv-search_heading_first\").text(bbg_xiv_lang[\"Search Results for\"]+\" \\\"\"+prevQuery+\"\\\"\");\n                        var title;\n                        if(window.bbg_xiv.bbg_xiv_wp_rest_api){\n                            title = bbg_xiv_lang.Page + ' ' + ( page - 1 ) + ' ' + bbg_xiv_lang.of + ' ' + ( pages !== Number.MAX_SAFE_INTEGER ? pages : '?' );\n                        }else{\n                            title = bbg_xiv_lang.Images + ' ' + ( prevOffset + 1 ) + ' ' + bbg_xiv_lang.to + ' ' + ( prevOffset + images.models.length ) + ' ' + bbg_xiv_lang.of +\n                                ' ' + ( count !== Number.MAX_SAFE_INTEGER ? count: '?' );\n                        }\n                        heading.find(\"span.bbg_xiv-search_heading_second\").text(title);\n                        // maintain a history of all images returned by this search\n                        search.history.push({images:images,title:title});\n                        search.index=search.history.length-1;\n                        var defaultView = bbg_xiv.getDefaultView( jQuery( divGallery ), null );\n                        bbg_xiv.renderGallery( divGallery, defaultView );\n                        heading.find(\"button.bbg_xiv-search_scroll_left\").attr(\"disabled\",search.index===0);\n                    }else{\n                        jQuery(divGallery).empty().append('<h1 class=\"bbg_xiv-warning\">'+bbg_xiv_lang[\"Nothing Found\"]+'</h1>');\n                    }\n                    var liSelectView=jQuery(divGallery.parentNode).find(\"nav.bbg_xiv-gallery_navbar ul.nav li.bbg_xiv-select_view\");\n                    var liFirst=liSelectView.find(\"ul.bbg_xiv-view_menu li.bbg_xiv-view\").removeClass(\"active\").filter(\".bbg_xiv-view_gallery\").addClass(\"active\");\n                    liSelectView.find(\"a.bbg_xiv-selected_view span\").text(liFirst.text());\n                    searchBtn.prop(\"disabled\",false);\n                }\n                if(window.bbg_xiv.bbg_xiv_wp_rest_api){\n                    // uses the WP REST API - requires the WP REST API plugin\n                    var images=bbg_xiv.images[divGallery.id]=new wp.api.collections.Media();\n                    images.once(\"sync\",function(){\n                        // the sync event will occur once only on the Backbone fetch of the collection\n                        handleResponse(!!this.length);\n                    },images);\n                    // get the next part of the multi-part search result as specified by page\n                    images.fetch({\n                        data:{\n                            search:query,\n                            // 'bb-tags':query,\n                            page:page++,\n                            per_page:searchLimit\n                        },\n                        success:function(c,r,o){\n                            // set the page variable from the page query parameter of the next page url in the HTTP header field \"Link\"\n                            var link=o.xhr.getResponseHeader(\"link\");\n                            if(link){\n                                var matches=link.match(/(\\?|&)page=(\\d+)(&[^>]+>;|>;)\\s+rel=\"next\"/);\n                                if(matches&&matches.length===4&&jQuery.isNumeric(matches[2])){\n                                    page = parseInt( matches[2], 10 );\n                                }else{\n                                    // no next page means search is complete\n                                }\n                            }else{\n                                // no HTTP \"Link\" header field means only one page so search is complete\n                            }\n                            // get count and pages from the HTTP header fields: \"X-WP-Total\", \"X-WP-TotalPages\" via wp-api.js\n                            count=images.state.totalObjects;\n                            pages=images.state.totalPages;\n                        },\n                        error: function( c, r ) {\n                            console.log(\"error:r=\",r);\n                            handleResponse(false);\n                        }\n                    });\n                }else{\n                    // old proprietary non REST way to load the Backbone image collection - does not require the WP REST API plugin\n                    // get the next part of the multi-part search result\n                    postData = {\n                        action:\"bbg_xiv_search_media\",\n                        query:query,\n                        limit:searchLimit,\n                        offset:offset,\n                        _wpnonce:form.find(\"input[name='_wpnonce']\").val(),\n                        _wp_http_referer:form.find(\"input[name='_wp_http_referer']\").val()\n                    };\n                    jQuery.post(bbg_xiv.ajaxurl,postData,function(r){\n                        bbg_xiv.images[divGallery.id]=null;\n                        bbg_xiv[divGallery.id+\"-data\"]=r;\n                        handleResponse(!!r);\n                    });\n                }\n                searchBtn.closest( 'div.bbg_xiv-gallery' ).removeClass( 'bbg_xiv-home_gallery' );\n                e.preventDefault();\n            });\n        });\n        jQuery(\"button.bbg_xiv-home\").click(function(e){\n            jQuery(this).parents(\"div.bbg_xiv-bootstrap.bbg_xiv-gallery\")\n                .find(\"nav.bbg_xiv-gallery_navbar ul.nav li.dropdown ul.bbg_xiv-view_menu li > a[data-view='gallery_home']\").click();\n            e.preventDefault();\n        });\n        jQuery( 'button.bbg_xiv-fullscreen' ).click(function() {\n            var $gallery = jQuery( this ).closest( 'div.bbg_xiv-gallery' );\n            if ( $gallery.hasClass( 'bbg_xiv-fullscreen_gallery' ) ) {\n                $gallery.removeClass( 'bbg_xiv-fullscreen_gallery' ).find( 'button.bbg_xiv-fullscreen' ).attr( 'title', bbg_xiv_lang['expand gallery to full-screen'] );\n                jQuery( 'html' ).removeClass( 'bbg_xiv-fullscreen_gallery' );\n            } else {\n                $gallery.addClass( 'bbg_xiv-fullscreen_gallery' ).find( 'button.bbg_xiv-fullscreen' ).attr( 'title', bbg_xiv_lang['shrink gallery from full-screen'] );\n                jQuery( 'html' ).addClass( 'bbg_xiv-fullscreen_gallery' );\n            }\n            jQuery( window ).resize();\n        });\n        jQuery( 'button.bbg_xiv-titles' ).click(function() {\n            var $this             = jQuery( this );\n            var $galleryContainer = $this.closest( 'div.bbg_xiv-bootstrap.bbg_xiv-gallery' );\n            var $container        = $galleryContainer.find( 'div.bbg_xiv-flex_container' );\n            if ( $container.length ) {\n                var $figure  = $container.find( 'div.bbg_xiv-flex_item figure' );\n                var $caption = $figure.find( 'figcaption' );\n                if ( $galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                    $caption.hide( 1000 );\n                    $galleryContainer.removeClass( 'bbg_xiv-caption_visible' );\n                    $this.attr( 'title', bbg_xiv_lang['show titles'] );\n                } else {\n                    $caption.show( 1000 );\n                    $galleryContainer.addClass( 'bbg_xiv-caption_visible' );\n                    $this.attr( 'title', bbg_xiv_lang['hide titles'] );\n                }\n                if ( $container.hasClass( 'bbg_xiv-contain' ) ) {\n                    // in tiles contain mode center image if title not displayed\n                    if ( $galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                        $figure.find( 'img' ).removeClass( 'bbg_xiv-vertical_center' );\n                    }else{\n                        $figure.find( 'img' ).addClass( 'bbg_xiv-vertical_center' );\n                    }\n                }\n                return;\n            }\n            $container = $galleryContainer.find( 'div.bbg_xiv-justified_container' );\n            if ( $container.length ) {\n                if ( $galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                    $galleryContainer.removeClass( 'bbg_xiv-caption_visible' );\n                    $this.attr( 'title', bbg_xiv_lang['show captions'] );\n                } else {\n                    $galleryContainer.addClass( 'bbg_xiv-caption_visible' );\n                    $this.attr( 'title', bbg_xiv_lang['hide captions'] );\n                }\n                window.setTimeout( function() {\n                    var $caption = $container.find( 'div.caption' );\n                    if ( $galleryContainer.hasClass( 'bbg_xiv-caption_visible' ) ) {\n                        $caption.css( { display: 'block', opacity: '0.7' } );\n                    } else {\n                        $caption.css( { display: 'none',  opacity: '0.0' } );\n                    }\n                }, 1000 );\n            }\n        });\n        // wireup the handler for setting options\n        jQuery(\"button.bbg_xiv-configure\").click(function(e){\n            divConfigure.find(\"input#bbg_xiv-carousel_delay\").val(bbg_xiv.bbg_xiv_carousel_interval);\n            divConfigure.find(\"input#bbg_xiv-min_image_width\").val(bbg_xiv.bbg_xiv_flex_min_width);\n            divConfigure.find( 'input#bbg_xiv-miro_row_height' ).val( bbg_xiv.bbg_xiv_miro_row_height );\n            divConfigure.find(\"input#bbg_xiv-max_search_results\").val(bbg_xiv.bbg_xiv_max_search_results);\n            divConfigure.find(\"input#bbg_xiv-columns_in_dense_view\").val(bbg_xiv.bbg_xiv_flex_number_of_dense_view_columns);\n            divConfigure.find(\"input[name='bbg_xiv-default_view']\").prop(\"checked\",false);\n            if(bbg_xiv.usingServerDefaultView===false){\n                divConfigure.find(\"input[name='bbg_xiv-default_view'][value='\"+bbg_xiv.bbg_xiv_default_view+\"']\").prop(\"checked\",true);\n            }\n            divConfigure.find(\"input[name='bbg_xiv-bandwidth']\").prop(\"checked\",false);\n            divConfigure.find(\"input[name='bbg_xiv-bandwidth'][value='\"+bbg_xiv.bbg_xiv_bandwidth+\"']\").prop(\"checked\",true);\n            divConfigure.find(\"input[name='bbg_xiv-interface']\").prop(\"checked\",false);\n            divConfigure.find(\"input[name='bbg_xiv-interface'][value='\"+bbg_xiv.bbg_xiv_interface+\"']\").prop(\"checked\",true);\n            var gallery=jQuery(this).parents(\"div.bbg_xiv-gallery\");\n            var outer=gallery.find(\"div.bbg_xiv-configure_outer\");\n            outer.show();\n            var inner=gallery.find(\"div.bbg_xiv-configure_inner\");\n            inner.show();\n            e.preventDefault();\n        });\n        var divConfigure=jQuery(\".bbg_xiv-configure_inner\");\n        divConfigure.find( 'input[type=\"number\"]#bbg_xiv-max_search_results' ).change(function() {\n            // max seems to be broken so fix with javascript\n            var jqThis=jQuery(this);\n            var max     = parseInt( jqThis.val(), 10 );\n            var attrMax = parseInt( jqThis.attr( 'max' ), 10 );\n            if(bbg_xiv.bbg_xiv_wp_rest_api&&attrMax>bbg_xiv.wpRestApiMaxPerPage){\n                // WP REST API requires that per_page be between 1 and 100 inclusive\n                attrMax=bbg_xiv.wpRestApiMaxPerPage;\n            }\n            if(max>attrMax){\n                jqThis.val(attrMax);\n            }\n        });\n        divConfigure.find( 'button.bbg_xiv-configure_close,button.bbg_xiv-cancel_options' ).click(function() {\n            var gallery=jQuery(this).parents(\"div.bbg_xiv-gallery\");\n            var outer=gallery.find(\"div.bbg_xiv-configure_outer\");\n            outer.hide();\n            var inner=gallery.find(\"div.bbg_xiv-configure_inner\");\n            inner.hide();\n        });\n        divConfigure.find(\"button.bbg_xiv-help_options\").click(function(e){\n            window.open(bbg_xiv.helpOptionsUrl,\"_blank\");\n            e.preventDefault();\n        });\n        divConfigure.find(\"button.bbg_xiv-save_options\").click(function(e){\n            // save the options\n            bbg_xiv.bbg_xiv_carousel_interval=divConfigure.find(\"input#bbg_xiv-carousel_delay\").val();\n            bbg_xiv.bbg_xiv_flex_min_width=divConfigure.find(\"input#bbg_xiv-min_image_width\").val();\n            bbg_xiv.bbg_xiv_miro_row_height = divConfigure.find( 'input#bbg_xiv-miro_row_height' ).val();\n            bbg_xiv.bbg_xiv_max_search_results=divConfigure.find(\"input#bbg_xiv-max_search_results\").val();\n            bbg_xiv.bbg_xiv_flex_number_of_dense_view_columns=divConfigure.find(\"input#bbg_xiv-columns_in_dense_view\").val();\n            var defaultView=divConfigure.find(\"input[name='bbg_xiv-default_view']:checked\").val();\n            if(defaultView){\n                bbg_xiv.bbg_xiv_default_view=defaultView;\n                bbg_xiv.usingServerDefaultView=false;\n            }else{\n                bbg_xiv.usingServerDefaultView=true;\n            }\n            bbg_xiv.bbg_xiv_bandwidth=divConfigure.find(\"input[name='bbg_xiv-bandwidth']:checked\").val();\n            bbg_xiv.bbg_xiv_interface=divConfigure.find(\"input[name='bbg_xiv-interface']:checked\").val();\n            var cookie={\n                bbg_xiv_carousel_interval:bbg_xiv.bbg_xiv_carousel_interval,\n                bbg_xiv_flex_min_width:bbg_xiv.bbg_xiv_flex_min_width,\n                bbg_xiv_miro_row_height: bbg_xiv.bbg_xiv_miro_row_height,\n                bbg_xiv_max_search_results:bbg_xiv.bbg_xiv_max_search_results,\n                bbg_xiv_flex_number_of_dense_view_columns:bbg_xiv.bbg_xiv_flex_number_of_dense_view_columns,\n                bbg_xiv_bandwidth:bbg_xiv.bbg_xiv_bandwidth,\n                bbg_xiv_interface:bbg_xiv.bbg_xiv_interface\n            };\n            if(bbg_xiv.usingServerDefaultView===false){\n                cookie.bbg_xiv_default_view=bbg_xiv.bbg_xiv_default_view;\n            }\n            cookie=JSON.stringify(cookie);\n            bbg_xiv.setCookie(\"bbg_xiv\",cookie,30);\n            bbg_xiv.getOptionsFromCookie();\n            bbg_xiv.calcBreakpoints();\n            var gallery=jQuery(this).parents(\"div.bbg_xiv-gallery\");\n            var outer=gallery.find(\"div.bbg_xiv-configure_outer\");\n            outer.hide();\n            var inner=gallery.find(\"div.bbg_xiv-configure_inner\");\n            inner.hide();\n            // redisplay the \"Gallery\" view using the new option values\n            bbg_xiv.resetGallery(jQuery(this).parents(\"div.bbg_xiv-gallery\"));\n            e.preventDefault();\n        });\n        jQuery(\"button.bbg_xiv-help\").click(function(e){\n            var view = jQuery( this ).closest( 'div.navbar-collapse' ).find( 'ul.navbar-nav li.bbg_xiv-select_view ul.bbg_xiv-view_menu li.bbg_xiv-view.active a' ).data( 'view' );\n            window.open( bbg_xiv.docUrl + '#view-' + view.toLowerCase(), '_blank' );\n            this.blur();\n            e.preventDefault();\n        });\n        // wireup the handler for scrolling through search results\n        jQuery( 'div.bbg_xiv-search_header button.bbg_xiv-search_scroll_left,div.bbg_xiv-search_header button.bbg_xiv-search_scroll_right' ).click(function() {\n            var jqThis = jQuery( this );\n            var heading=jqThis.parents(\"div.bbg_xiv-search_header\");\n            var id=heading.attr(\"id\").replace(\"-heading\",\"\");\n            var gallery=heading.parents(\"div.bbg_xiv-gallery\");\n            var search=bbg_xiv.search[id];\n            if(jqThis.hasClass(\"bbg_xiv-search_scroll_left\")){\n                if(search.index>0){\n                    if(!--search.index){\n                        jqThis.attr(\"disabled\",true);\n                    }\n                    heading.find(\"button.bbg_xiv-search_scroll_right\").attr(\"disabled\",false);\n                }else{\n                }\n            }else{\n                if(search.index<search.history.length-1){\n                    ++search.index;\n                    if(search.index===search.history.length-1&&search.done){\n                        heading.find(\"button.bbg_xiv-search_scroll_right\").attr(\"disabled\",true);\n                    }\n                    heading.find(\"button.bbg_xiv-search_scroll_left\").attr(\"disabled\",false);\n                }else{\n                    // load the next part of the multi-part search\n                    gallery.find(\"nav.navbar form.bbg_xiv-search_form button[type='submit']\").click();\n                    return;\n                }\n            }\n            if(search.index>=0&&search.index<search.history.length){\n                var history=search.history[search.index];\n                bbg_xiv.images[id]=history.images;\n                heading.find(\"span.bbg_xiv-search_heading_second\").text(history.title);\n                var divGallery  = gallery.find( 'div.bbg_xiv-gallery_envelope' );\n                var defaultView = bbg_xiv.getDefaultView( divGallery, null );\n                bbg_xiv.renderGallery( divGallery[0], defaultView );\n                // reset navbar to \"Gallery\" view\n                var liSelectView=gallery.find(\"nav.bbg_xiv-gallery_navbar ul.nav li.bbg_xiv-select_view\");\n                var liFirst=liSelectView.find(\"ul.bbg_xiv-view_menu li.bbg_xiv-view\").removeClass(\"active\").filter(\".bbg_xiv-view_gallery\").addClass(\"active\");\n                liSelectView.find(\"a.bbg_xiv-selected_view span\").text(liFirst.text());\n            }\n        });\n        // make the \"Images\" brand clickable for mobile devices and send click to the toggle button\n        jQuery(\"a.bbg_xiv-images_brand,a.bbg_xiv-tabs_brand\").click(function(e){\n            var toggle=jQuery(this).siblings(\"button.navbar-toggle\");\n            if(toggle.css(\"display\")!==\"none\"){\n                toggle.click();\n            }\n            e.preventDefault();\n        });\n        // wireup mobile only events\n        jQuery(window).on(\"swipe\",function(e){\n            var carousel=jQuery(\"div.bbg_xiv-gallery_envelope div.carousel\");\n            if(carousel.length){\n                // ignore swipes near carousel slider\n                if(e.pageY>jQuery(\"div.carousel-indicators\").offset().top-50){\n                    return;\n                }\n                if(e.swipestop.coords[0]>e.swipestart.coords[0]){\n                    carousel.find(\"a.left.carousel-control\").click();\n                }else{\n                    carousel.find(\"a.right.carousel-control\").click();\n                }\n                return;\n            }\n            // hide/show title and caption of overlay on swipe\n            var inner=jQuery(\"div.bbg_xiv-dense_inner\");\n            inner.find( '.bbg_xiv-dense_title, .bbg_xiv-dense_caption' ).each(function() {\n                var $this = jQuery( this );\n                var color = $this.css( 'color' );\n                if ( color !== 'transparent' && color !== 'rgba(0, 0, 0, 0)' ) {   // TODO: find safer test for transparent\n                    $this.css({ color: 'transparent',      textShadow: 'none'             });\n                }else{\n                    $this.css({ color: bbg_xiv.titleColor, textShadow: bbg_xiv.titleShadow});\n                }\n            });\n        });\n        jQuery( window ).on( 'orientationchange', function() {\n            var $body = jQuery( 'body' );\n            if ( $body.hasClass( 'admin-bar' ) && jQuery( 'div#wpadminbar' ).css( 'position' ) == 'fixed' ) {\n                $body.addClass( 'bbg_xiv-fixed_admin_bar' );\n            } else {\n                $body.removeClass( 'bbg_xiv-fixed_admin_bar' );\n            }\n            jQuery(\"div.bbg_xiv-gallery\").each(function(){\n                bbg_xiv.resetGallery(jQuery(this));\n            });\n        });\n        if(!bbg_xiv.bbg_xiv_wp_rest_api){\n            // if using the REST API cannot do resize here since the models may be asynchronously created\n            jQuery(window).resize();\n        }\n        // If TwentySixteen theme has border then add class to body element to indicate this.\n        var $body            = jQuery( 'body' );\n        var bodyBeforeStyle  = window.getComputedStyle( $body[0], ':before' );\n        if ( bodyBeforeStyle && bodyBeforeStyle.position === 'fixed' && bodyBeforeStyle.zIndex > 0 ) {\n            var height = parseInt( bodyBeforeStyle.height, 10 );\n            if ( height > 8 && height < 64 ) {\n                $body.addClass( 'bbg_xiv-twentysixteen_with_border' );\n            }\n        }\n        if ( $body.hasClass( 'admin-bar' ) && jQuery( 'div#wpadminbar' ).css( 'position' ) == 'fixed' ) {\n            $body.addClass( 'bbg_xiv-fixed_admin_bar' );\n        }\n        \n    });   // jQuery(document).ready(function(){\n\n    //cookie test code\n    //window.alert(\"bbg_xiv_test=\"+bbg_xiv.getCookie(\"bbg_xiv_test\"));\n    //bbg_xiv.setCookie(\"bbg_xiv_test\",window.prompt(\"bbg_xiv_test\",\"null\"));\n}());\n\n"]}